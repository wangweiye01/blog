<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/blog/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/blog/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/blog/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/blog/images/logo.svg" color="#222">

<link rel="stylesheet" href="/blog/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha256-dABdfBfUoC8vJUBOwGVdm8L9qlMWaHTIfXt+7GnZCIo=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"wangweiye01.github.io","root":"/blog/","images":"/blog/images","scheme":"Muse","darkmode":false,"version":"8.23.1","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"codeblock":{"theme":{"light":"default","dark":"stackoverflow-dark"},"prism":{"light":"prism","dark":"prism-dark"},"copy_button":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"language":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/blog/js/config.js" defer></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="Coding &amp; Life">
<meta property="og:url" content="https://wangweiye01.github.io/blog/index.html">
<meta property="og:site_name" content="Coding &amp; Life">
<meta property="og:locale">
<meta property="article:author" content="老枪">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://wangweiye01.github.io/blog/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-Hans","comments":"","permalink":"","path":"index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Coding & Life</title>
  








  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
<script src="/blog/js/utils.js" defer></script><script src="/blog/js/motion.js" defer></script><script src="/blog/js/sidebar.js" defer></script><script src="/blog/js/next-boot.js" defer></script>

  






  





  <noscript>
    <link rel="stylesheet" href="/blog/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
    </div>
  </div>

  <div class="site-meta">

    <a href="/blog/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Coding & Life</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">求知若饥，虚心若愚</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>







</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">老枪</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/blog/archives/">
          <span class="site-state-item-count">90</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/blog/categories/">
        <span class="site-state-item-count">2</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">tags</span>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://wangweiye01.github.io/blog/2024/07/26/acme/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="老枪">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Coding & Life">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Coding & Life">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/2024/07/26/acme/" class="post-title-link" itemprop="url">acme自动续费免费SSL证书</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-07-26 10:25:55" itemprop="dateCreated datePublished" datetime="2024-07-26T10:25:55+08:00">2024-07-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-06-16 15:54:53" itemprop="dateModified" datetime="2025-06-16T15:54:53+08:00">2025-06-16</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote>
<p>目前云商提供的免费正式都是3个月的有效期，过期更换很麻烦</p>
</blockquote>
<h1 id="安装acme"><a href="#安装acme" class="headerlink" title="安装acme"></a>安装acme</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl https://get.acme.sh | sh</span><br></pre></td></tr></table></figure>

<p>如果安装服务器在国内，访问github困难，可以使用以下方法</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://gitee.com/neilpang/acme.sh.git</span><br><span class="line"><span class="built_in">cd</span> acme.sh</span><br><span class="line">./acme.sh --install -m my@example.com</span><br></pre></td></tr></table></figure>

<p>这一步会把<code>acme.sh</code>安装到<code>~/.acme.sh/</code>目录，并自动配置一个名叫<code>acme.sh</code>的<code>alias</code></p>
<h1 id="获取DNS解析密钥"><a href="#获取DNS解析密钥" class="headerlink" title="获取DNS解析密钥"></a>获取DNS解析密钥</h1><p><code>acme.sh</code>支持阿里云、腾讯云、godaddy等数十种解析商的自动集成，这里以阿里云为例，其它的参考<a target="_blank" rel="noopener" href="https://github.com/acmesh-official/acme.sh/wiki/dnsapi">官方介绍</a></p>
<p>访问<code>https://ram.console.aliyun.com/users</code>，如果还没有创建过用户这里创建一个</p>
<p><img src="https://blog.wangweiye.cc/WX20240726-103635-1.png"></p>
<p>新建完后一定要记得添加“云解析”相关的权限，否则后面步骤会失败</p>
<p><img src="https://blog.wangweiye.cc/WX20240726-104402-2.png"></p>
<p>然后复制<code>AccessKey ID</code>和<code>AccessKey Secret</code></p>
<h1 id="注册厂商账号"><a href="#注册厂商账号" class="headerlink" title="注册厂商账号"></a>注册厂商账号</h1><p>此处使用ZeroSSL厂商测试</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">acme.sh  --register-account  -m xxx@youremail.com --server zerossl</span><br></pre></td></tr></table></figure>

<h1 id="生成证书"><a href="#生成证书" class="headerlink" title="生成证书"></a>生成证书</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> Ali_Key=<span class="string">&quot;上面记录的AccessKey ID&quot;</span></span><br><span class="line"><span class="built_in">export</span> Ali_Secret=<span class="string">&quot;上面记录AccessKey Secret&quot;</span></span><br><span class="line">acme.sh --issue -d test.wangweiye.cc --dns dns_ali</span><br></pre></td></tr></table></figure>

<p>看到如下界面，证书就生成好了</p>
<p><img src="https://blog.wangweiye.cc/WX20240726-104954%402x-3.png"></p>
<p>同时会自动创建CT任务检测所有证书，如果快过期了（貌似是60天）需要更新，则会自动更新证书</p>
<p><img src="https://blog.wangweiye.cc/WX20240726-105124%402x-4.png"></p>
<h1 id="使用证书"><a href="#使用证书" class="headerlink" title="使用证书"></a>使用证书</h1><p>注意千万不要直接让nginx使用<code>~/.acme.sh/</code>目录下的证书，因为这个文件是会变化的，正确方式是：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">acme.sh --install-cert -d test.wangweiye.cc \</span><br><span class="line">--fullchain-file /usr/local/nginx/conf/cert/test.wangweiye.cc.cert \</span><br><span class="line">--key-file	   /usr/local/nginx/conf/cert/test.wangweiye.cc.key  \</span><br><span class="line">--reloadcmd	 <span class="string">&quot;nginx -s reload&quot;</span></span><br></pre></td></tr></table></figure>

<p>证书更新后会自动调用<code>reloadcmd</code>，然后确保你的nginx中引用的是上述证书文</p>
<h1 id="最终效果"><a href="#最终效果" class="headerlink" title="最终效果"></a>最终效果</h1><p><img src="https://blog.wangweiye.cc/WX20240726-105502-5.png"></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://wangweiye01.github.io/blog/2024/06/16/iptables-rule/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="老枪">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Coding & Life">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Coding & Life">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/2024/06/16/iptables-rule/" class="post-title-link" itemprop="url">iptables推荐默认规则</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-06-16 16:24:42" itemprop="dateCreated datePublished" datetime="2024-06-16T16:24:42+08:00">2024-06-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-06-16 17:00:28" itemprop="dateModified" datetime="2025-06-16T17:00:28+08:00">2025-06-16</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="清空旧规则"><a href="#清空旧规则" class="headerlink" title="清空旧规则"></a>清空旧规则</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">iptables -F</span><br><span class="line">iptables -X</span><br><span class="line">iptables -Z</span><br></pre></td></tr></table></figure>

<h1 id="默认策略：丢弃所有"><a href="#默认策略：丢弃所有" class="headerlink" title="默认策略：丢弃所有"></a>默认策略：丢弃所有</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">iptables -P INPUT DROP</span><br><span class="line">iptables -P FORWARD DROP</span><br><span class="line">iptables -P OUTPUT ACCEPT</span><br></pre></td></tr></table></figure>

<h1 id="允许本地回环访问"><a href="#允许本地回环访问" class="headerlink" title="允许本地回环访问"></a>允许本地回环访问</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT -i lo -j ACCEPT</span><br></pre></td></tr></table></figure>

<h1 id="允许已建立连接和相关连接的数据包"><a href="#允许已建立连接和相关连接的数据包" class="headerlink" title="允许已建立连接和相关连接的数据包"></a>允许已建立连接和相关连接的数据包</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT</span><br></pre></td></tr></table></figure>

<h1 id="允许SSH（默认22端口）"><a href="#允许SSH（默认22端口）" class="headerlink" title="允许SSH（默认22端口）"></a>允许SSH（默认22端口）</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT -p tcp --dport 22 -j ACCEPT</span><br></pre></td></tr></table></figure>

<h1 id="可选：允许Ping"><a href="#可选：允许Ping" class="headerlink" title="可选：允许Ping"></a>可选：允许Ping</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -A INPUT -p icmp -j ACCEPT</span><br></pre></td></tr></table></figure>

<h1 id="保存规则"><a href="#保存规则" class="headerlink" title="保存规则"></a>保存规则</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">yum install -y iptables-services # 安装iptable</span><br><span class="line">service iptables save # 规则保存到 /etc/sysconfig/iptables</span><br><span class="line">systemctl restart iptables # 重启</span><br><span class="line">systemctl enable iptables # 开机启动</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://wangweiye01.github.io/blog/2023/12/14/disk/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="老枪">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Coding & Life">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Coding & Life">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/2023/12/14/disk/" class="post-title-link" itemprop="url">Linux逻辑卷(LVM)</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-12-14 09:52:01" itemprop="dateCreated datePublished" datetime="2023-12-14T09:52:01+08:00">2023-12-14</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-06-16 15:54:53" itemprop="dateModified" datetime="2025-06-16T15:54:53+08:00">2025-06-16</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><img src="https://blog.wangweiye.cc/girl-8435340_1280.png"></p>
<p>逻辑卷（LVM）是在硬盘分区和文件系统之间添加的一个逻辑层，为文件系统屏蔽下层硬盘分区部局，并提供一个抽象的盘卷，在盘卷上建立文件系统。可以利用LVM在硬盘不用重新分区的情况下<strong>动态调整文件系统的大小</strong>，并且利用LVM管理的文件系统可以跨越物理硬盘。当服务器添加新的硬盘后，管理员不必将原有的文件移动到新的硬盘上，而是通过LVM直接扩展文件系统来跨越物理硬盘</p>
<p>在Debian系统中使用<code>lvs</code>命令，如果找不到，说明未安装LVM系统，使用<code>sudo apt-get install lvm2</code>命令进行安装，CentOS一般默认安装LVM</p>
<h1 id="创建分区"><a href="#创建分区" class="headerlink" title="创建分区"></a>创建分区</h1><p>使用<code>fdisk -l</code>命令查看现有硬盘信息</p>
<p><img src="https://blog.wangweiye.cc/2023-12-14-10-05-57-image.png"></p>
<p>发现有一个vdb硬盘未创建分区，为其创建3个分区，大小分别是<mark>10G、13G、27G</mark>，使用<code>fdisk /dev/vdb</code>命令</p>
<p><img src="https://blog.wangweiye.cc/2023-12-14-14-26-58-image.png"></p>
<p>再次使用<code>fdisk -l</code>命令查看硬盘及分区信息，发现vdb硬盘下已有3个分区</p>
<p><img src="https://blog.wangweiye.cc/2023-12-14-10-12-57-image.png"></p>
<h1 id="创建物理卷"><a href="#创建物理卷" class="headerlink" title="创建物理卷"></a>创建物理卷</h1><p>CentOS7以上系统，在创建卷组时会自动创建物理卷，可以省略此步骤</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pvcreate /dev/vdb1 /dev/vdb2 /dev/vdb3</span><br></pre></td></tr></table></figure>

<p><img src="https://blog.wangweiye.cc/2023-12-14-10-16-57-image.png"></p>
<h1 id="创建卷组"><a href="#创建卷组" class="headerlink" title="创建卷组"></a>创建卷组</h1><p>将3个分区中的1和2分区纳入到卷组中，卷组中共23G空间</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vgcreate vg1 /dev/vdb1 /dev/vdb2</span><br></pre></td></tr></table></figure>

<p>创建卷组时并不是只能指定分区，可以直接使用硬盘，如：<code>vgcreate vg1 /dev/vdb</code>，并且<strong>CentOS7以上的系统可以在创建卷组时自动创建物理卷</strong>，可以跳过创建物理卷的过程。例如</p>
<h1 id="创建逻辑卷"><a href="#创建逻辑卷" class="headerlink" title="创建逻辑卷"></a>创建逻辑卷</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lvcreate -L 10G -n lv1 vg1</span><br></pre></td></tr></table></figure>

<p>逻辑卷大小<strong>10G</strong>，逻辑卷名是<strong>lv1</strong>，从<strong>vg1</strong>卷组中创建</p>
<p>如果要把卷组中所有的容量加入到逻辑卷中，使用如下命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lvcreate -l 100%FREE -n lv1 vg1</span><br></pre></td></tr></table></figure>

<h1 id="为逻辑卷创建文件系统"><a href="#为逻辑卷创建文件系统" class="headerlink" title="为逻辑卷创建文件系统"></a>为逻辑卷创建文件系统</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkfs.xfs /dev/vg1/lv1</span><br></pre></td></tr></table></figure>

<p><img src="https://blog.wangweiye.cc/2023-12-14-10-29-19-image.png"></p>
<p>如果提示命令不存在，那么请安装xfs文件系统</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install xfsprogs</span><br></pre></td></tr></table></figure>

<h1 id="挂载逻辑卷"><a href="#挂载逻辑卷" class="headerlink" title="挂载逻辑卷"></a>挂载逻辑卷</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mount /dev/vg1/lv1 /mnt/test</span><br></pre></td></tr></table></figure>

<h1 id="开机自动挂载"><a href="#开机自动挂载" class="headerlink" title="开机自动挂载"></a>开机自动挂载</h1><p><code>/etc/fstab</code>用于存放文件系统信息，当系统启动时，系统会自动读取文件内容将指定的文件系统挂载到指定的目录</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/dev/vg1/lv1 /mnt/test xfs defaults 0 0</span><br></pre></td></tr></table></figure>

<p>第一个字段：要挂载的设备路径</p>
<p>第二个字段：挂载点目录</p>
<p>第三个字段：设备文件系统类型</p>
<p>第四、五、六个字段，不知道什么意思，直接填写即可…</p>
<p>填写完成后测试内容是否正确：</p>
<ol>
<li><p>将逻辑卷卸载</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">umount /mnt/test</span><br></pre></td></tr></table></figure>
</li>
<li><p>依照配置文件<code>/etc/fstab</code>的数据将所有未挂载的磁盘都挂载上来</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mount -a</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看是否重新挂载</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">df -Th</span><br></pre></td></tr></table></figure></li>
</ol>
<h1 id="扩展逻辑卷"><a href="#扩展逻辑卷" class="headerlink" title="扩展逻辑卷"></a>扩展逻辑卷</h1><p>逻辑卷的空间来源于卷组，当卷组有足够的空间时，才可以扩展逻辑卷。卷组中一共有23G空间，lv1占用了10G，可以扩展</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lvextend -L +5G /dev/vg1/lv1</span><br></pre></td></tr></table></figure>

<p><img src="https://blog.wangweiye.cc/2023-12-14-14-10-22-image.png"></p>
<p>同样，如果将卷组中剩余的所有空间都扩展到逻辑卷中，使用如下命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lvextend -l +100%FREE /dev/vg1/lv1</span><br></pre></td></tr></table></figure>

<p>使用<code>lvs</code>查看，发现逻辑卷已有15G空间</p>
<p><img src="https://blog.wangweiye.cc/2023-12-14-14-11-09-image.png"></p>
<p>此时我们查看文件系统大小，仍然是10G</p>
<p><img src="https://blog.wangweiye.cc/2023-12-14-14-12-24-image.png"></p>
<p>这种情况需要扩展文件系统</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xfs_growfs /mnt/test</span><br></pre></td></tr></table></figure>

<p><img src="https://blog.wangweiye.cc/2023-12-14-14-13-34-image.png"></p>
<h1 id="扩展卷组"><a href="#扩展卷组" class="headerlink" title="扩展卷组"></a>扩展卷组</h1><p>卷组的空间来源于物理分区或者物理硬盘，当卷组没有足够空间提供给逻辑卷时，须扩容卷组。我们之前把vdb1和vdb2两个分区加入到卷组，现在我们把vdb3扩展到卷组中</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vgextend vg1 /dev/vdb3</span><br></pre></td></tr></table></figure>

<p><img src="https://blog.wangweiye.cc/2023-12-14-14-16-41-image.png"></p>
<h1 id="删除逻辑卷"><a href="#删除逻辑卷" class="headerlink" title="删除逻辑卷"></a>删除逻辑卷</h1><p>逻辑卷的删除不允许联机操作，需要先卸载，再执行删除</p>
<p>删除顺序：先删除逻辑卷，再删除卷组，最后删除物理卷</p>
<h2 id="卸载"><a href="#卸载" class="headerlink" title="卸载"></a>卸载</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">umount /mnt/test</span><br></pre></td></tr></table></figure>

<h2 id="删除逻辑卷-1"><a href="#删除逻辑卷-1" class="headerlink" title="删除逻辑卷"></a>删除逻辑卷</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lvremove /dev/vg1/lv1</span><br></pre></td></tr></table></figure>

<p><img src="https://blog.wangweiye.cc/2023-12-14-14-20-16-image.png"></p>
<h2 id="删除卷组"><a href="#删除卷组" class="headerlink" title="删除卷组"></a>删除卷组</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vgremove vg1</span><br></pre></td></tr></table></figure>

<p><img src="https://blog.wangweiye.cc/2023-12-14-14-21-00-image.png"></p>
<h2 id="删除物理卷"><a href="#删除物理卷" class="headerlink" title="删除物理卷"></a>删除物理卷</h2><p><img src="https://blog.wangweiye.cc/2023-12-14-14-21-35-image.png"></p>
<h2 id="删除分区"><a href="#删除分区" class="headerlink" title="删除分区"></a>删除分区</h2><p><img src="https://blog.wangweiye.cc/2023-12-14-14-23-14-image.png"></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://wangweiye01.github.io/blog/2023/12/02/api-sign/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="老枪">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Coding & Life">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Coding & Life">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/2023/12/02/api-sign/" class="post-title-link" itemprop="url">跨系统接口调用</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-12-02 14:15:08" itemprop="dateCreated datePublished" datetime="2023-12-02T14:15:08+08:00">2023-12-02</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-06-16 15:54:53" itemprop="dateModified" datetime="2025-06-16T15:54:53+08:00">2025-06-16</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><img src="http://gttx-test.guan2018.com/Rhododendron_ZH-CN8481644646_1920x1080.jpeg" alt="pic"></p>
<p>在涉及跨系统接口调用时，我们容易碰到以下安全问题：</p>
<ul>
<li>请求身份被伪造。</li>
<li>请求参数被篡改。</li>
<li>请求被抓包，然后重放攻击。</li>
</ul>
<h2 id="需求场景"><a href="#需求场景" class="headerlink" title="需求场景"></a>需求场景</h2><p>假设我们有如下业务需求：</p>
<blockquote>
<p>用户在 A 系统参与活动成功后，活动奖励以余额的形式下发到 B 系统。</p>
</blockquote>
<h2 id="初始方案：裸奔"><a href="#初始方案：裸奔" class="headerlink" title="初始方案：裸奔"></a>初始方案：裸奔</h2><p>在不考虑安全问题的情况下，我们很容易完成这个需求：</p>
<ol>
<li><p>在B系统开放一个接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 为指定用户添加指定余额</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> userId 用户 id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> money 要添加的余额，单位：分</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> / </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;addMoney&quot;)</span></span><br><span class="line"><span class="keyword">public</span> SaResult <span class="title function_">addMoney</span><span class="params">(<span class="type">long</span> userId, <span class="type">long</span> money)</span> &#123;</span><br><span class="line">    <span class="comment">// 处理业务 </span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 返回 </span></span><br><span class="line">    <span class="keyword">return</span> SaResult.ok();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>在 A 系统使用 http 工具类调用这个接口。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">long userId = 10001;</span><br><span class="line">long money = 1000;</span><br><span class="line">String res = HttpUtil.request(&quot;http://b.com/api/addMoney?userId=&quot; + userId + &quot;&amp;money=&quot; + money);</span><br></pre></td></tr></table></figure></li>
</ol>
<p>上述代码简单的完成了需求，但是很明显它有安全问题</p>
<h2 id="方案升级：增加secretKey校验"><a href="#方案升级：增加secretKey校验" class="headerlink" title="方案升级：增加secretKey校验"></a>方案升级：增加secretKey校验</h2><p>为防止 B 系统开放的接口被陌生人任意调用，我们增加一个 secretKey 参数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 为指定用户添加指定余额</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;addMoney&quot;)</span></span><br><span class="line"><span class="keyword">public</span> SaResult <span class="title function_">addMoney</span><span class="params">(<span class="type">long</span> userId, <span class="type">long</span> money, String secretKey)</span> &#123;</span><br><span class="line">    <span class="comment">// 1、先校验 secretKey 参数是否正确，如果不正确直接拒绝响应请求</span></span><br><span class="line">    <span class="keyword">if</span>( ! check(secretKey) ) &#123;</span><br><span class="line">        <span class="keyword">return</span> SaResult.error(<span class="string">&quot;无效 secretKey，无法响应请求&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2、业务代码 </span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3、返回</span></span><br><span class="line">    <span class="keyword">return</span> SaResult.ok();</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>由于 A 系统是我们 “自己人”，所以它可以拿着 secretKey 进行合法请求：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">long</span> <span class="variable">userId</span> <span class="operator">=</span> <span class="number">10001</span>;</span><br><span class="line"><span class="type">long</span> <span class="variable">money</span> <span class="operator">=</span> <span class="number">1000</span>;</span><br><span class="line"><span class="type">String</span> <span class="variable">secretKey</span> <span class="operator">=</span> <span class="string">&quot;xxxxxxxxxxxxxxxxxxxx&quot;</span>;</span><br><span class="line"><span class="type">String</span> <span class="variable">res</span> <span class="operator">=</span> HttpUtil.request(<span class="string">&quot;http://b.com/api/addMoney?userId=&quot;</span> + userId + <span class="string">&quot;&amp;money=&quot;</span> + money + <span class="string">&quot;&amp;secretKey=&quot;</span> + secretKey);</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>现在，即使 B 系统的接口被暴露了，也不会被陌生人任意调用了，安全性得到了一定的保证，但是仍然存在一些问题：</p>
<ul>
<li>如果请求被抓包，secretKey 就会泄露，因为每次请求都在 url 中明文传输了 secretKey 参数。</li>
<li>如果请求被抓包，请求的其它参数就可以被任意修改，例如可以将 money 参数修改为 9999999，B系统无法确定参数是否被修改过。</li>
</ul>
<h2 id="方案再升级：使用摘要算法生成参数签名"><a href="#方案再升级：使用摘要算法生成参数签名" class="headerlink" title="方案再升级：使用摘要算法生成参数签名"></a>方案再升级：使用摘要算法生成参数签名</h2><p>首先，在 A 系统不要直接发起请求，而是先计算一个 sign 参数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 声明变量</span></span><br><span class="line"><span class="type">long</span> <span class="variable">userId</span> <span class="operator">=</span> <span class="number">10001</span>;</span><br><span class="line"><span class="type">long</span> <span class="variable">money</span> <span class="operator">=</span> <span class="number">1000</span>;</span><br><span class="line"><span class="type">String</span> <span class="variable">secretKey</span> <span class="operator">=</span> <span class="string">&quot;xxxxxxxxxxxxxxxxxxxx&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 计算 sign 参数</span></span><br><span class="line"><span class="type">String</span> <span class="variable">sign</span> <span class="operator">=</span> md5(<span class="string">&quot;money=&quot;</span> + money + <span class="string">&quot;&amp;userId=&quot;</span> + userId + <span class="string">&quot;&amp;key=&quot;</span> + secretKey);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将 sign 拼接在请求地址后面</span></span><br><span class="line"><span class="type">String</span> <span class="variable">res</span> <span class="operator">=</span> HttpUtil.request(<span class="string">&quot;http://b.com/api/addMoney?userId=&quot;</span> + userId + <span class="string">&quot;&amp;money=&quot;</span> + money + <span class="string">&quot;&amp;sign=&quot;</span> + sign);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>注意此处计算签名时，需要将所有参数按照字典顺序依次排列（key除外，挂在最后面）</strong>以下所有计算签名时同理，不再赘述。</p>
<p>然后在 B 系统接收请求时，使用同样的算法、同样的秘钥，生成 sign 字符串，与参数中 sign 值进行比较：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 为指定用户添加指定余额</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;addMoney&quot;)</span></span><br><span class="line"><span class="keyword">public</span> SaResult <span class="title function_">addMoney</span><span class="params">(<span class="type">long</span> userId, <span class="type">long</span> money, String sign)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 在 B 系统，使用同样的算法、同样的密钥，计算出 sign2，与传入的 sign 进行比对</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">sign2</span> <span class="operator">=</span> md5(<span class="string">&quot;money=&quot;</span> + money + <span class="string">&quot;&amp;userId=&quot;</span> + userId + <span class="string">&quot;&amp;key=&quot;</span> + secretKey);</span><br><span class="line">    <span class="keyword">if</span>(!sign2.equals(sign)) &#123;</span><br><span class="line">        <span class="keyword">return</span> SaResult.error(<span class="string">&quot;无效 sign，无法响应请求&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2、业务代码 </span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3、返回</span></span><br><span class="line">    <span class="keyword">return</span> SaResult.ok();</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>因为 sign 的值是由 userId、money、secretKey 三个参数共同决定的，所以只要有一个参数不一致，就会造成最终生成 sign 也是不一致的，所以，根据比对结果：</p>
<ul>
<li>如果sign一致，说明这是个合法请求</li>
<li>如果sign不一致，说明发起请求的客户端密钥不正确，或者请求的参数被篡改过，是个不合法请求。</li>
</ul>
<p>此方案有点：</p>
<ul>
<li>不在url中直接传递secretKey参数了，避免了泄露风险</li>
<li>由于sign参数的限制，请求中的参数也不可被篡改，B系统可放心的使用这些参数</li>
</ul>
<p>此方案扔存在以下缺陷：</p>
<ul>
<li>被抓包后，请求可以被无限重放，B系统无法判断请求是真正来自于A系统，还是被抓包后重放的</li>
</ul>
<h2 id="方案再再升级：追加nonce随机字符串"><a href="#方案再再升级：追加nonce随机字符串" class="headerlink" title="方案再再升级：追加nonce随机字符串"></a>方案再再升级：追加nonce随机字符串</h2><p>首先，在 A 系统发起调用前，追加一个 <code>nonce</code> 参数，一起参与到签名中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 声明变量</span></span><br><span class="line"><span class="type">long</span> <span class="variable">userId</span> <span class="operator">=</span> <span class="number">10001</span>;</span><br><span class="line"><span class="type">long</span> <span class="variable">money</span> <span class="operator">=</span> <span class="number">1000</span>;</span><br><span class="line"><span class="type">String</span> <span class="variable">nonce</span> <span class="operator">=</span> SaFoxUtil.getRandomString(<span class="number">32</span>); <span class="comment">// 随机32位字符串</span></span><br><span class="line"><span class="type">String</span> <span class="variable">secretKey</span> <span class="operator">=</span> <span class="string">&quot;xxxxxxxxxxxxxxxxxxxx&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 计算 sign 参数</span></span><br><span class="line"><span class="type">String</span> <span class="variable">sign</span> <span class="operator">=</span> md5(<span class="string">&quot;money=&quot;</span> + money + <span class="string">&quot;&amp;nonce=&quot;</span> + nonce + <span class="string">&quot;&amp;userId=&quot;</span> + userId + <span class="string">&quot;&amp;key=&quot;</span> + secretKey);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将 sign 拼接在请求地址后面</span></span><br><span class="line"><span class="type">String</span> <span class="variable">res</span> <span class="operator">=</span> HttpUtil.request(<span class="string">&quot;http://b.com/api/addMoney?userId=&quot;</span> + userId + <span class="string">&quot;&amp;money=&quot;</span> + money + <span class="string">&quot;nonce=&quot;</span> + nonce + <span class="string">&quot;&amp;sign=&quot;</span> + sign);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>然后在 B 系统接收请求时，也把 nonce 参数加进去生成 sign 字符串，进行比较：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 为指定用户添加指定余额</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;addMoney&quot;)</span></span><br><span class="line"><span class="keyword">public</span> SaResult <span class="title function_">addMoney</span><span class="params">(<span class="type">long</span> userId, <span class="type">long</span> money, String nonce, String sign)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1、检查此 nonce 是否已被使用过了</span></span><br><span class="line">    <span class="keyword">if</span>(CacheUtil.get(<span class="string">&quot;nonce_&quot;</span> + nonce) != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> SaResult.error(<span class="string">&quot;此 nonce 已被使用过了，请求无效&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2、验证签名</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">sign2</span> <span class="operator">=</span> md5(<span class="string">&quot;money=&quot;</span> + money + <span class="string">&quot;&amp;nonce=&quot;</span> + nonce + <span class="string">&quot;&amp;userId=&quot;</span> + userId + <span class="string">&quot;&amp;key=&quot;</span> + secretKey);</span><br><span class="line">    <span class="keyword">if</span>(!sign2.equals(sign)) &#123;</span><br><span class="line">        <span class="keyword">return</span> SaResult.error(<span class="string">&quot;无效 sign，无法响应请求&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3、将 nonce 记入缓存，防止重复使用</span></span><br><span class="line">    CacheUtil.set(<span class="string">&quot;nonce_&quot;</span> + nonce, <span class="string">&quot;1&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4、业务代码 </span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 5、返回</span></span><br><span class="line">    <span class="keyword">return</span> SaResult.ok();</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>代码分析：</p>
<ul>
<li>为方便理解，我们先看第 3 步：此处在校验签名成功后，将 nonce 随机字符串记入缓存中。</li>
<li>再看第 1 步：每次请求进来，先查看一下缓存中是否已经记录了这个随机字符串，如果是，则立即返回：无效请求。</li>
</ul>
<p>这两步的组合，保证了一个 nonce 随机字符串只能被使用一次，如果请求被抓包后重放，是无法通过nonce校验的。</p>
<p>至此，问题似乎已经解决了……吗？</p>
<p>别急，我们还有一个问题没有考虑：这个 nonce 在字符串在缓存应该被保存多久呢？</p>
<ul>
<li>保存 15 分钟？那抓包的人只需要等待 15 分钟，你的 nonce 记录在缓存中消失，请求就可以被重放了。</li>
<li>那保存 24 小时？保存一周？保存半个月？好像无论保存多久，都无法从根本上解决这个问题。</li>
</ul>
<p>你可能会想到，那我永久保存吧。这样确实能解决问题，但显然服务器承载不了这么做，即使再微小的数据量，在时间的累加下，也总一天会超出服务器能够承载的上限。</p>
<h2 id="方案再再再升级：追加timestamp时间戳"><a href="#方案再再再升级：追加timestamp时间戳" class="headerlink" title="方案再再再升级：追加timestamp时间戳"></a>方案再再再升级：追加timestamp时间戳</h2><p>我们可以再追加一个 timestamp 时间戳参数，将请求的有效性限定在一个有限时间范围内，例如 15分钟。</p>
<p>首先，在 A 系统追加 timestamp 参数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 声明变量</span></span><br><span class="line"><span class="type">long</span> <span class="variable">userId</span> <span class="operator">=</span> <span class="number">10001</span>;</span><br><span class="line"><span class="type">long</span> <span class="variable">money</span> <span class="operator">=</span> <span class="number">1000</span>;</span><br><span class="line"><span class="type">String</span> <span class="variable">nonce</span> <span class="operator">=</span> SaFoxUtil.getRandomString(<span class="number">32</span>); <span class="comment">// 随机32位字符串</span></span><br><span class="line"><span class="type">long</span> <span class="variable">timestamp</span> <span class="operator">=</span> System.currentTimeMillis(); <span class="comment">// 随机32位字符串</span></span><br><span class="line"><span class="type">String</span> <span class="variable">secretKey</span> <span class="operator">=</span> <span class="string">&quot;xxxxxxxxxxxxxxxxxxxx&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 计算 sign 参数</span></span><br><span class="line"><span class="type">String</span> <span class="variable">sign</span> <span class="operator">=</span> md5(<span class="string">&quot;money=&quot;</span> + money + <span class="string">&quot;&amp;nonce=&quot;</span> + nonce + <span class="string">&quot;&amp;timestamp=&quot;</span> + timestamp + <span class="string">&quot;&amp;userId=&quot;</span> + userId + <span class="string">&quot;&amp;key=&quot;</span> + secretKey);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将 sign 拼接在请求地址后面</span></span><br><span class="line"><span class="type">String</span> <span class="variable">res</span> <span class="operator">=</span> HttpUtil.request(<span class="string">&quot;http://b.com/api/addMoney&quot;</span> +</span><br><span class="line">        <span class="string">&quot;?userId=&quot;</span> + userId + <span class="string">&quot;&amp;money=&quot;</span> + money + <span class="string">&quot;&amp;nonce=&quot;</span> + nonce + <span class="string">&quot;&amp;timestamp=&quot;</span> + timestamp + <span class="string">&quot;&amp;sign=&quot;</span> + sign);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在 B 系统检测这个 timestamp 是否超出了允许的范围</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 为指定用户添加指定余额</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;addMoney&quot;)</span></span><br><span class="line"><span class="keyword">public</span> SaResult <span class="title function_">addMoney</span><span class="params">(<span class="type">long</span> userId, <span class="type">long</span> money, <span class="type">long</span> timestamp, String nonce, String sign)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1、检查 timestamp 是否超出允许的范围（此处假定最大允许15分钟差距）</span></span><br><span class="line">    <span class="type">long</span> <span class="variable">timestampDisparity</span> <span class="operator">=</span> System.currentTimeMillis() - timestamp; <span class="comment">// 实际的时间差</span></span><br><span class="line">    <span class="keyword">if</span>(timestampDisparity &gt; <span class="number">1000</span> * <span class="number">60</span> * <span class="number">15</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> SaResult.error(<span class="string">&quot;timestamp 时间差超出允许的范围，请求无效&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2、检查此 nonce 是否已被使用过了</span></span><br><span class="line">    <span class="comment">// 代码同上，不再赘述</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3、验证签名</span></span><br><span class="line">    <span class="comment">// 代码同上，不再赘述</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4、将 nonce 记入缓存，ttl 有效期和 allowDisparity 允许时间差一致 </span></span><br><span class="line">    CacheUtil.set(<span class="string">&quot;nonce_&quot;</span> + nonce, <span class="string">&quot;1&quot;</span>, <span class="number">1000</span> * <span class="number">60</span> * <span class="number">15</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 5、业务代码 ...</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 6、返回</span></span><br><span class="line">    <span class="keyword">return</span> SaResult.ok();</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>至此，抓包者：</p>
<ul>
<li>如果在 15 分钟内重放攻击，nonce 参数不答应：缓存中可以查出 nonce 值，直接拒绝响应请求。</li>
<li>如果在 15 分钟后重放攻击，timestamp 参数不答应：超出了允许的 timestamp 时间差，直接拒绝响应请求。</li>
</ul>
<h2 id="服务器的时钟差异造成安全问题"><a href="#服务器的时钟差异造成安全问题" class="headerlink" title="服务器的时钟差异造成安全问题"></a>服务器的时钟差异造成安全问题</h2><p>以上的代码，均假设 A 系统服务器与 B 系统服务器的时钟一致，才可以正常完成安全校验，但在实际的开发场景中，有些服务器会存在时钟不准确的问题。</p>
<p>假设 A 服务器与 B 服务器的时钟差异为 10 分钟，即：在 A 服务器为 8:00 的时候，B 服务器为 7:50。</p>
<ol>
<li>A 系统发起请求，其生成的时间戳也是代表 8:00。</li>
<li>B 系统接受到请求后，完成业务处理，此时 nonce 的 ttl 为 15分钟，到期时间为 7:50 + 15分 &#x3D; 8:05。</li>
<li>8.05 后，nonce 缓存消失，抓包者重放请求攻击：</li>
</ol>
<ul>
<li>timestamp 校验通过：因为时间戳差距仅有 8.05 - 8.00 &#x3D; 5分钟，小于 15 分钟，校验通过。</li>
<li>nonce 校验通过：因为此时 nonce 缓存已经消失，可以通过校验。</li>
<li>sign 校验通过：因为这本来就是由 A 系统构建的一个合法签名。</li>
<li>攻击完成。</li>
</ul>
<p>要解决上述问题，有两种方案：</p>
<ul>
<li>方案一：修改服务器时钟，使两个服务器时钟保持一致。</li>
<li>方案二：在代码层面兼容时钟不一致的场景。</li>
</ul>
<p>要采用方案一的同学可自行搜索一下同步时钟的方法，在此暂不赘述，此处详细阐述一下方案二。</p>
<p>我们只需简单修改一下，B 系统校验参数的代码即可：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 为指定用户添加指定余额</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;addMoney&quot;)</span></span><br><span class="line"><span class="keyword">public</span> SaResult <span class="title function_">addMoney</span><span class="params">(<span class="type">long</span> userId, <span class="type">long</span> money, <span class="type">long</span> timestamp, String nonce, String sign)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1、检查 timestamp 是否超出允许的范围 （重点一：此处需要取绝对值）</span></span><br><span class="line">    <span class="type">long</span> <span class="variable">timestampDisparity</span> <span class="operator">=</span> Math.abs(System.currentTimeMillis() - timestamp);</span><br><span class="line">    <span class="keyword">if</span>(timestampDisparity &gt; <span class="number">1000</span> * <span class="number">60</span> * <span class="number">15</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> SaResult.error(<span class="string">&quot;timestamp 时间差超出允许的范围，请求无效&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2、检查此 nonce 是否已被使用过了</span></span><br><span class="line">    <span class="comment">// 代码同上，不再赘述 </span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3、验证签名</span></span><br><span class="line">    <span class="comment">// 代码同上，不再赘述 </span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4、将 nonce 记入缓存，防止重复使用（重点二：此处需要将 ttl 设定为允许 timestamp 时间差的值 x 2 ）</span></span><br><span class="line">    CacheUtil.set(<span class="string">&quot;nonce_&quot;</span> + nonce, <span class="string">&quot;1&quot;</span>, (<span class="number">1000</span> * <span class="number">60</span> * <span class="number">15</span>) * <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 5、业务代码 ...</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 6、返回</span></span><br><span class="line">    <span class="keyword">return</span> SaResult.ok();</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>以上代码中时间差的计算改为当前时间和请求时间的绝对值计算，同时将缓存时间设置为2倍时间差，这样就可以保证时间戳的计算和缓存nonce有一项能在异常请求时拦截成功</p>
<h2 id="最终方案"><a href="#最终方案" class="headerlink" title="最终方案"></a>最终方案</h2><p>此处再贴一下完整的代码。</p>
<p>A 系统（发起请求端）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 声明变量</span></span><br><span class="line"><span class="type">long</span> <span class="variable">userId</span> <span class="operator">=</span> <span class="number">10001</span>;</span><br><span class="line"><span class="type">long</span> <span class="variable">money</span> <span class="operator">=</span> <span class="number">1000</span>;</span><br><span class="line"><span class="type">String</span> <span class="variable">nonce</span> <span class="operator">=</span> SaFoxUtil.getRandomString(<span class="number">32</span>); <span class="comment">// 随机32位字符串</span></span><br><span class="line"><span class="type">long</span> <span class="variable">timestamp</span> <span class="operator">=</span> System.currentTimeMillis(); <span class="comment">// 当前时间戳</span></span><br><span class="line"><span class="type">String</span> <span class="variable">secretKey</span> <span class="operator">=</span> <span class="string">&quot;xxxxxxxxxxxxxxxxxxxx&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 计算 sign 参数</span></span><br><span class="line"><span class="type">String</span> <span class="variable">sign</span> <span class="operator">=</span> md5(<span class="string">&quot;money=&quot;</span> + money + <span class="string">&quot;&amp;nonce=&quot;</span> + nonce + <span class="string">&quot;&amp;timestamp=&quot;</span> + timestamp + <span class="string">&quot;&amp;userId=&quot;</span> + userId + <span class="string">&quot;&amp;key=&quot;</span> + secretKey);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将 sign 拼接在请求地址后面</span></span><br><span class="line"><span class="type">String</span> <span class="variable">res</span> <span class="operator">=</span> HttpUtil.request(<span class="string">&quot;http://b.com/api/addMoney&quot;</span> +</span><br><span class="line">        <span class="string">&quot;?userId=&quot;</span> + userId + <span class="string">&quot;&amp;money=&quot;</span> + money + <span class="string">&quot;&amp;nonce=&quot;</span> + nonce + <span class="string">&quot;&amp;timestamp=&quot;</span> + timestamp + <span class="string">&quot;&amp;sign=&quot;</span> + sign);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>B 系统（接收请求端）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 为指定用户添加指定余额</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;addMoney&quot;)</span></span><br><span class="line"><span class="keyword">public</span> SaResult <span class="title function_">addMoney</span><span class="params">(<span class="type">long</span> userId, <span class="type">long</span> money, <span class="type">long</span> timestamp, String nonce, String sign)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1、检查 timestamp 是否超出允许的范围</span></span><br><span class="line">    <span class="type">long</span> <span class="variable">allowDisparity</span> <span class="operator">=</span> <span class="number">1000</span> * <span class="number">60</span> * <span class="number">15</span>;    <span class="comment">// 允许的时间差：15分钟</span></span><br><span class="line">    <span class="type">long</span> <span class="variable">timestampDisparity</span> <span class="operator">=</span> Math.abs(System.currentTimeMillis() - timestamp); <span class="comment">// 实际的时间差</span></span><br><span class="line">    <span class="keyword">if</span>(timestampDisparity &gt; allowDisparity) &#123;</span><br><span class="line">        <span class="keyword">return</span> SaResult.error(<span class="string">&quot;timestamp 时间差超出允许的范围，请求无效&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2、检查此 nonce 是否已被使用过了</span></span><br><span class="line">    <span class="keyword">if</span>(CacheUtil.get(<span class="string">&quot;nonce_&quot;</span> + nonce) != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> SaResult.error(<span class="string">&quot;此 nonce 已被使用过了，请求无效&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3、验证签名</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">sign2</span> <span class="operator">=</span> md5(<span class="string">&quot;money=&quot;</span> + money + <span class="string">&quot;&amp;nonce=&quot;</span> + nonce + <span class="string">&quot;&amp;timestamp=&quot;</span> + timestamp + <span class="string">&quot;&amp;userId=&quot;</span> + userId + <span class="string">&quot;&amp;key=&quot;</span> + secretKey);</span><br><span class="line">    <span class="keyword">if</span>(!sign2.equals(sign)) &#123;</span><br><span class="line">        <span class="keyword">return</span> SaResult.error(<span class="string">&quot;无效 sign，无法响应请求&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4、将 nonce 记入缓存，防止重复使用，注意此处需要将 ttl 设定为允许 timestamp 时间差的值 x 2  </span></span><br><span class="line">    CacheUtil.set(<span class="string">&quot;nonce_&quot;</span> + nonce, <span class="string">&quot;1&quot;</span>, allowDisparity * <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 5、业务代码 ...</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 6、返回</span></span><br><span class="line">    <span class="keyword">return</span> SaResult.ok();</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p>可以使用Sa-Token提供的<a target="_blank" rel="noopener" href="https://sa-token.cc/doc.html#/plugin/api-sign">API接口参数签名</a>插件快速完成以上需求</p>
</blockquote>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://wangweiye01.github.io/blog/2022/12/08/mongoDB/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="老枪">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Coding & Life">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Coding & Life">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/2022/12/08/mongoDB/" class="post-title-link" itemprop="url">mongoDB分片副本集搭建</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-12-08 11:31:14" itemprop="dateCreated datePublished" datetime="2022-12-08T11:31:14+08:00">2022-12-08</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-06-16 15:54:53" itemprop="dateModified" datetime="2025-06-16T15:54:53+08:00">2025-06-16</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><img src="https://blog.wangweiye.cc/pexels-valeriia-miller-3405808.jpg"></p>
<p>MongoDB是一个<code>基于分布式文件存储的数据库</code>。由C++语言编写。旨在<code>为WEB应用提供可扩展高性能数据存储解决方案</code>。</p>
<p>MongoDB是一个<code>介于关系数据库和非关系数据库</code>之间的产品，是非关系数据库当中功能最丰富，最像关系数据库的。他支持的数据结构非常松散，是类似json的bson格式，因此可以存储比较复杂的数据类型 。Mongo最大的特点是他支持的查询语言非常强大，其语法有点类似于面向对象的查询语言，<code>几乎可以实现类似关系数据库单表查询的绝大部分功能，而且还支持对数据建立索引</code>。</p>
<p>总结: mongoDB 是一个非关系型文档数据库</p>
<h2 id="副本集"><a href="#副本集" class="headerlink" title="副本集"></a>副本集<Replica Set></h2><h3 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h3><p><a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/replication/">https://docs.mongodb.com/manual/replication/</a></p>
<p>MongoDB 副本集（Replica Set）是有自动故障恢复功能的主从集群，有一个Primary节点和一个或多个Secondary节点组成。副本集没有固定的<code>主节点</code>,当<code>主节点</code>发生故障时整个集群会<code>选举一个主节点</code>为系统提供服务以保证系统的高可用。</p>
<p><img src="https://blog.wangweiye.cc/replica-set-read-write-operations-primary.bakedsvg-20211214132813414.svg"></p>
<h3 id="Automatic-Failover"><a href="#Automatic-Failover" class="headerlink" title="Automatic Failover"></a>Automatic Failover</h3><p>​自动故障转移机制: 当主节点未与集合的其他成员通信超过配置的选举超时时间（默认为 10 秒）时，合格的辅助节点将调用选举以将自己提名为新的主节点。集群尝试完成新主节点的选举并恢复正常操作。</p>
<p><img src="https://blog.wangweiye.cc/replica-set-trigger-election.bakedsvg.svg"></p>
<h3 id="搭建副本集"><a href="#搭建副本集" class="headerlink" title="搭建副本集"></a>搭建副本集</h3><p>演示环境使用<code>Debian 10.13</code>和<code>MongoDB v5.0.14</code></p>
<h4 id="创建数据目录"><a href="#创建数据目录" class="headerlink" title="创建数据目录"></a>创建数据目录</h4><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># 在安装目录中创建</span></span><br><span class="line"><span class="bullet">-</span> mkdir -p ../repl/data1</span><br><span class="line"><span class="bullet">-</span> mkdir -p ../repl/data2</span><br><span class="line"><span class="bullet">-</span> mkdir -p ../repl/data3</span><br></pre></td></tr></table></figure>

<h4 id="搭建副本集-1"><a href="#搭建副本集-1" class="headerlink" title="搭建副本集"></a>搭建副本集</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">./mongod --port 27017  --dbpath ../repl/data1 --bind_ip 0.0.0.0 --replSet  myreplace/124.239.149.46:27018,124.239.149.46:27019</span><br><span class="line"></span><br><span class="line">./mongod --port 27018  --dbpath ../repl/data2 --bind_ip 0.0.0.0 --replSet  myreplace/124.239.149.46:27019,124.239.149.46:27017</span><br><span class="line"></span><br><span class="line">./mongod --port 27019  --dbpath ../repl/data3 --bind_ip 0.0.0.0 --replSet  myreplace/124.239.149.46:27017,124.239.149.46:27018</span><br></pre></td></tr></table></figure>

<h4 id="配置副本集"><a href="#配置副本集" class="headerlink" title="配置副本集"></a>配置副本集</h4><p>连接任意节点，切换到<code>admin</code>库<code>use admin</code></p>
<p>初始化副本集</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">var config = <span class="punctuation">&#123;</span></span><br><span class="line">    _id<span class="punctuation">:</span><span class="string">&quot;myreplace&quot;</span><span class="punctuation">,</span> </span><br><span class="line">    members<span class="punctuation">:</span><span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span>_id<span class="punctuation">:</span><span class="number">0</span><span class="punctuation">,</span>host<span class="punctuation">:</span><span class="string">&quot;124.239.149.46:27017&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span>_id<span class="punctuation">:</span><span class="number">1</span><span class="punctuation">,</span>host<span class="punctuation">:</span><span class="string">&quot;124.239.149.46:27018&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span>_id<span class="punctuation">:</span><span class="number">2</span><span class="punctuation">,</span>host<span class="punctuation">:</span><span class="string">&quot;124.239.149.46:27019&quot;</span><span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line">rs.initiate(config);<span class="comment">//初始化配置 </span></span><br></pre></td></tr></table></figure>

<p>设置从节点客户端临时访问</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rs.secondaryOk();</span><br></pre></td></tr></table></figure>

<h2 id="分片集群"><a href="#分片集群" class="headerlink" title="分片集群"></a>分片集群<Sharding Cluster></h2><h3 id="说明-1"><a href="#说明-1" class="headerlink" title="说明"></a>说明</h3><p><a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/sharding/">https://docs.mongodb.com/manual/sharding/</a></p>
<p><code>分片(sharding)</code>是指<code>将数据拆分,将其分散存在不同机器的过程</code>，有时也用<code>分区(partitioning)</code>来表示这个概念,将数据分散在不同的机器上，不需要功能强大的大型计算机就能存储更多的数据，处理更大的负载。</p>
<p>​分片目的是通过分片能够增加更多机器来应对不断的增加负载和数据，还不影响应用运行。</p>
<p>​MongoDB支持<code>自动分片</code>,可以摆脱手动分片的管理困扰，集群自动切分数据做负载均衡。MongoDB分片的基本思想就是将集合拆分成多个块，这些块分散在若干个片里，每个片只负责总数据的一部分，应用程序不必知道哪些片对应哪些数据，甚至不需要知道数据拆分了，所以在分片之前会运行一个路由进程，mongos进程，这个路由器知道所有的数据存放位置，应用只需要直接与mongos交互即可。mongos自动将请求转到相应的片上获取数据，从应用角度看分不分片没有什么区别。</p>
<h3 id="架构"><a href="#架构" class="headerlink" title="架构"></a>架构</h3><p><img src="https://blog.wangweiye.cc/image-20211214150523282.png"></p>
<ul>
<li><p><strong>Shard:</strong>	用于存储实际的数据块，实际生产环境中一个shard server角色可由几台机器组个一个replica set承担，防止主机单点故障</p>
</li>
<li><p><strong>Config Server</strong>:mongod实例，存储了整个 ClusterMetadata。</p>
</li>
<li><p><strong>Query Routers</strong>: 前端路由，客户端由此接入，且让整个集群看上去像单一数据库，前端应用可以透明使用。</p>
</li>
<li><p><strong>Shard Key</strong>: 片键，设置分片时需要在集合中选一个键,用该键的值作为拆分数据的依据,这个片键称之为(shard key)，片键的选取很重要,片键的选取决定了数据散列是否均匀。</p>
</li>
</ul>
<h3 id="搭建"><a href="#搭建" class="headerlink" title="搭建"></a>搭建</h3><h4 id="集群规划"><a href="#集群规划" class="headerlink" title="集群规划"></a>集群规划</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Shard Server 1：27017</span><br><span class="line">Shard Repl   1：27018</span><br><span class="line"></span><br><span class="line">Shard Server 2：27019</span><br><span class="line">Shard Repl   2：27020</span><br><span class="line"></span><br><span class="line">Shard Server 3：27021</span><br><span class="line">Shard Repl   3：27022</span><br><span class="line"></span><br><span class="line">Config Server ：27023</span><br><span class="line">Config Server ：27024</span><br><span class="line">Config Server ：27025</span><br><span class="line"></span><br><span class="line">Route Process ：27026</span><br></pre></td></tr></table></figure>

<h4 id="进入bin目录创建数据目录"><a href="#进入bin目录创建数据目录" class="headerlink" title="进入bin目录创建数据目录"></a>进入bin目录创建数据目录</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p ../cluster/shard/s0</span><br><span class="line">mkdir -p ../cluster/shard/s0-repl</span><br><span class="line"></span><br><span class="line">mkdir -p ../cluster/shard/s1</span><br><span class="line">mkdir -p ../cluster/shard/s1-repl</span><br><span class="line"></span><br><span class="line">mkdir -p ../cluster/shard/s2</span><br><span class="line">mkdir -p ../cluster/shard/s2-repl</span><br><span class="line"></span><br><span class="line">mkdir -p ../cluster/shard/config1</span><br><span class="line">mkdir -p ../cluster/shard/config2</span><br><span class="line">mkdir -p ../cluster/shard/config3</span><br></pre></td></tr></table></figure>

<h4 id="启动分片服务"><a href="#启动分片服务" class="headerlink" title="启动分片服务"></a>启动分片服务</h4><h5 id="启动s0-r0"><a href="#启动s0-r0" class="headerlink" title="启动s0,r0"></a>启动s0,r0</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">./mongod --port 27017 --dbpath ../cluster/shard/s0 --bind_ip 0.0.0.0 --shardsvr --replSet r0/124.239.149.46:27018</span><br><span class="line"></span><br><span class="line">./mongod --port 27018 --dbpath ../cluster/shard/s0-repl --bind_ip 0.0.0.0 --shardsvr --replSet r0/124.239.149.46:27017</span><br></pre></td></tr></table></figure>
<h5 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">use admin</span><br><span class="line"></span><br><span class="line">config = &#123;_id: &quot;r0&quot;, members: [</span><br><span class="line">        &#123;_id:0,host:&quot;124.239.149.46:27017&quot;&#125;,</span><br><span class="line">        &#123;_id:1,host:&quot;124.239.149.46:27018&quot;&#125;,</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">rs.initiate(config);//初始化</span><br></pre></td></tr></table></figure>

<h5 id="启动s1-r1"><a href="#启动s1-r1" class="headerlink" title="启动s1,r1"></a>启动s1,r1</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">./mongod --port 27019 --dbpath ../cluster/shard/s1 --bind_ip 0.0.0.0 --shardsvr --replSet r1/124.239.149.46:27020</span><br><span class="line"></span><br><span class="line">./mongod --port 27020 --dbpath ../cluster/shard/s1-repl --bind_ip 0.0.0.0 --shardsvr --replSet r1/124.239.149.46:27019</span><br></pre></td></tr></table></figure>

<h5 id="配置-1"><a href="#配置-1" class="headerlink" title="配置"></a>配置</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">use admin</span><br><span class="line"></span><br><span class="line">config = &#123;_id: &quot;r1&quot;, members: [</span><br><span class="line">        &#123;_id:0,host:&quot;124.239.149.46:27019&quot;&#125;,</span><br><span class="line">        &#123;_id:1,host:&quot;124.239.149.46:27020&quot;&#125;,</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">rs.initiate(config);//初始化</span><br></pre></td></tr></table></figure>

<h5 id="启动s2-r2"><a href="#启动s2-r2" class="headerlink" title="启动s2,r2"></a>启动s2,r2</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">./mongod --port 27021 --dbpath ../cluster/shard/s2 --bind_ip 0.0.0.0 --shardsvr --replSet r2/124.239.149.46:27022</span><br><span class="line"></span><br><span class="line">./mongod --port 27022 --dbpath ../cluster/shard/s2-repl --bind_ip 0.0.0.0 --shardsvr --replSet r2/124.239.149.46:27021</span><br></pre></td></tr></table></figure>

<h5 id="配置-2"><a href="#配置-2" class="headerlink" title="配置"></a>配置</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">use admin</span><br><span class="line"></span><br><span class="line">config = &#123;_id: &quot;r2&quot;, members: [</span><br><span class="line">        &#123;_id:0,host:&quot;124.239.149.46:27021&quot;&#125;,</span><br><span class="line">        &#123;_id:1,host:&quot;124.239.149.46:27022&quot;&#125;,</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">rs.initiate(config);//初始化</span><br></pre></td></tr></table></figure>

<h4 id="启动3个config服务"><a href="#启动3个config服务" class="headerlink" title="启动3个config服务"></a>启动3个config服务</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">./mongod --port 27023 --dbpath ../cluster/shard/config1 --bind_ip 0.0.0.0 --replSet  config/124.239.149.46:27024,124.239.149.46:27025 --configsvr</span><br><span class="line"></span><br><span class="line">./mongod --port 27024 --dbpath ../cluster/shard/config2 --bind_ip 0.0.0.0 --replSet  config/124.239.149.46:27023,124.239.149.46:27025 --configsvr</span><br><span class="line"></span><br><span class="line">./mongod --port 27025 --dbpath ../cluster/shard/config3 --bind_ip 0.0.0.0 --replSet  config/124.239.149.46:27023,124.239.149.46:27024 --configsvr</span><br></pre></td></tr></table></figure>

<h4 id="初始化-config-server-副本集"><a href="#初始化-config-server-副本集" class="headerlink" title="初始化 config server 副本集"></a>初始化 config server 副本集</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">use admin </span><br><span class="line"></span><br><span class="line">config = &#123; </span><br><span class="line">    _id:&quot;config&quot;, </span><br><span class="line">    configsvr: true,</span><br><span class="line">    members:[</span><br><span class="line">        &#123;_id:0,host:&quot;124.239.149.46:27023&quot;&#125;,</span><br><span class="line">        &#123;_id:1,host:&quot;124.239.149.46:27024&quot;&#125;,</span><br><span class="line">        &#123;_id:2,host:&quot;124.239.149.46:27025&quot;&#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">rs.initiate(config); //初始化副本集配置 </span><br></pre></td></tr></table></figure>

<h4 id="启动-mongos-路由服务"><a href="#启动-mongos-路由服务" class="headerlink" title="启动 mongos 路由服务"></a>启动 mongos 路由服务</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./mongos --port 27026 --configdb config/124.239.149.46:27023,124.239.149.46:27024,124.239.149.46:27025 --bind_ip 0.0.0.0</span><br></pre></td></tr></table></figure>

<h4 id="添加分片信息"><a href="#添加分片信息" class="headerlink" title="添加分片信息"></a>添加分片信息</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">登录mongos服务</span></span><br><span class="line">./mongo --port 27026</span><br><span class="line">use admin</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">添加分片信息</span></span><br><span class="line">db.runCommand(&#123; addshard:&quot;r0/124.239.149.46:27017,124.239.149.46:27018&quot;, &quot;allowLocal&quot;:true &#125;);</span><br><span class="line">db.runCommand(&#123; addshard:&quot;r1/124.239.149.46:27019,124.239.149.46:27020&quot;, &quot;allowLocal&quot;:true &#125;);</span><br><span class="line">db.runCommand(&#123; addshard:&quot;r2/124.239.149.46:27021,124.239.149.46:27022&quot;, &quot;allowLocal&quot;:true &#125;);</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">指定分片库</span></span><br><span class="line">db.runCommand(&#123; enablesharding: &quot;baizhi&quot; &#125;);</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置库的片键信息</span></span><br><span class="line">db.runCommand(&#123; shardcollection: &quot;baizhi.emps&quot;, key: &#123; _id: &quot;hashed&quot;&#125;&#125;)</span><br></pre></td></tr></table></figure>

<h4 id="测试分片"><a href="#测试分片" class="headerlink" title="测试分片"></a>测试分片</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">连接mongos</span></span><br><span class="line">./mongo --port 27026</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">切换库</span></span><br><span class="line">use baizhi</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">插入1000条信息</span></span><br><span class="line">for(let i = 0; i &lt; 1000; i++) &#123;</span><br><span class="line">    db.emps.insert(&#123;_id: i, name: &quot;xxx_&quot; + i&#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">登录3个分片分别查询插入的数量</span></span><br></pre></td></tr></table></figure>

<h2 id="其他资料"><a href="#其他资料" class="headerlink" title="其他资料"></a>其他资料</h2><p><a target="_blank" rel="noopener" href="https://blog.wangweiye.cc/1_MongoDB%E6%9D%83%E5%A8%81%E6%8C%87%E5%8D%97%5D%E7%BF%BB%E8%AF%91%E7%89%88.pdf">MongoDB权威指南</a><br><a target="_blank" rel="noopener" href="https://blog.wangweiye.cc/2_MongoDB%E8%B5%84%E6%96%99.pdf">MongoDB基本语法</a><br><a target="_blank" rel="noopener" href="https://blog.wangweiye.cc/MongoDB%20%E5%AE%9E%E6%88%98.pdf">MongoDB笔记</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://wangweiye01.github.io/blog/2022/08/04/mysql-json/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="老枪">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Coding & Life">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Coding & Life">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/2022/08/04/mysql-json/" class="post-title-link" itemprop="url">MySQL8操作JSON</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-08-04 15:39:16" itemprop="dateCreated datePublished" datetime="2022-08-04T15:39:16+08:00">2022-08-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-06-16 15:54:53" itemprop="dateModified" datetime="2025-06-16T15:54:53+08:00">2025-06-16</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><img src="https://blog.wangweiye.cc/pexels-brett-sayles-4508751.jpeg"></p>
<p>MySQL是一种<code>关系型数据库</code>，适合存储结构化数据，而JSON是一种非结构化格式，通常使用<code>mongoDB</code>等存储。但是在5.7之后，MySQL也开始支持<code>JSON</code>操作。此文章使用的版本是<code>8.0.30</code></p>
<h2 id="使用JSON数据类型的优点"><a href="#使用JSON数据类型的优点" class="headerlink" title="使用JSON数据类型的优点"></a>使用JSON数据类型的优点</h2><ul>
<li>不用预创建字段: 字段可以无限扩展，更加灵活；</li>
<li>处理稀疏字段: 避免了某些很少使用字段的NULL值，避免了冗余存储；</li>
<li>支持索引。支持<code>JSON</code>之前，可以使用<code>VARCHAR</code>存储，但是不支持索引等查询优化</li>
</ul>
<h2 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h2><h3 id="创建测试表"><a href="#创建测试表" class="headerlink" title="创建测试表"></a>创建测试表</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE TABLE</span> `<span class="keyword">user</span>` (</span><br><span class="line">  `id` <span class="type">bigint</span> <span class="keyword">NOT NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `name` <span class="type">varchar</span>(<span class="number">20</span>) <span class="keyword">NOT NULL</span> <span class="keyword">DEFAULT</span> <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">  `details` json <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  <span class="keyword">PRIMARY KEY</span> (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4 <span class="keyword">COLLATE</span><span class="operator">=</span>utf8mb4_unicode_ci</span><br></pre></td></tr></table></figure>

<h3 id="插入数据"><a href="#插入数据" class="headerlink" title="插入数据"></a>插入数据</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert into</span> <span class="keyword">user</span>(name, details) <span class="keyword">values</span> (<span class="string">&#x27;jack&#x27;</span>, <span class="string">&#x27;&#123;&quot;phone&quot;: &quot;13100000000&quot;, &quot;age&quot;: 30, &quot;address&quot;: &#123;&quot;country&quot;: &quot;CN&quot;, &quot;province&quot;: &quot;浙江省&quot;, &quot;city&quot;: &quot;杭州市&quot;&#125;&#125;&#x27;</span>);</span><br><span class="line"><span class="keyword">insert into</span> <span class="keyword">user</span>(name, details) <span class="keyword">values</span> (<span class="string">&#x27;Linda&#x27;</span>, <span class="string">&#x27;&#123;&quot;phone&quot;: &quot;music&quot;, &quot;age&quot;: 25, &quot;address&quot;: &#123;&quot;country&quot;: &quot;CN&quot;, &quot;province&quot;: &quot;河北省&quot;&#125;&#125;&#x27;</span>);</span><br><span class="line"><span class="keyword">insert into</span> <span class="keyword">user</span>(name, details) <span class="keyword">values</span> (<span class="string">&#x27;Lily&#x27;</span>, <span class="string">&#x27;&#123;&quot;age&quot;: 30, &quot;address&quot;: &#123;&quot;country&quot;: &quot;CN&quot;, &quot;province&quot;: &quot;广东省&quot;, &quot;city&quot;: &quot;广州市&quot;&#125;&#125;&#x27;</span>);</span><br><span class="line"><span class="keyword">insert into</span> <span class="keyword">user</span>(name, details) <span class="keyword">values</span> (<span class="string">&#x27;Lisa&#x27;</span>, <span class="string">&#x27;&#123;&quot;likes&quot;: [&quot;music&quot;, &quot;basketball&quot;], &quot;likes2&quot;: [&quot;music&quot;]&#125;&#x27;</span>);</span><br><span class="line"><span class="keyword">insert into</span> <span class="keyword">user</span>(name, details) <span class="keyword">values</span> (<span class="string">&#x27;Kobe&#x27;</span>, <span class="string">&#x27;&#123;&quot;likes&quot;: [&quot;art&quot;]&#125;&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>完成数据准备之后的数据如图:<br><img src="https://blog.wangweiye.cc/WX20220805-100044%402x.png"></p>
<h3 id="查询"><a href="#查询" class="headerlink" title="查询"></a>查询</h3><ol>
<li>使用<code>JSON_EXTRACT</code>查询JSON中的某个字段</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> name, JSON_EXTRACT(details, <span class="string">&#x27;$.address.city&#x27;</span>) city <span class="keyword">from</span> <span class="keyword">user</span>;</span><br></pre></td></tr></table></figure>
<p><img src="https://blog.wangweiye.cc/WX20220805-100214%402x.png"></p>
<p>使用符号，同样可以替代<code>JSON_EXTRACT</code>函数的作用。<code>-&gt;</code>查询出的带有双引号，<code>-&gt;&gt;</code>查询出的没有双引号</p>
<p><img src="https://blog.wangweiye.cc/WX20220805-100729%402x.png"></p>
<ol start="2">
<li>使用JSON中的字段作为查询条件<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> name, details <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">where</span> details <span class="operator">-</span><span class="operator">&gt;</span> <span class="string">&#x27;$.address.city&#x27;</span> <span class="operator">=</span> <span class="string">&#x27;杭州市&#x27;</span>;</span><br></pre></td></tr></table></figure></li>
</ol>
<p><img src="https://blog.wangweiye.cc/WX20220804-164653%402x.png"></p>
<ol start="3">
<li><code>JSON_CONTAINS</code>函数，查询JSON文档是否在指定path包含指定的数据，包含则返回1，否则返回0；如果有参数为NULL或者path不存在，则返回NULL</li>
</ol>
<p>使用方式：<code>JSON_CONTAINS(json_doc, val [,path])</code>, 第二个参数<code>&#39;val&#39;</code>表示val为整型，<code>&#39;&quot;val&quot;&#39;</code>表示val为字符串类型，<strong>第二个参数最外层必须使用<code>&#39;&#39;</code></strong></p>
<p>例子2中的查询可以等同于：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> name, details <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">where</span> JSON_CONTAINS(details, <span class="string">&#x27;&quot;杭州市&quot;&#x27;</span>, <span class="string">&#x27;$.address.city&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>查询爱好包含音乐的用户信息</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> name, details <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">where</span> JSON_CONTAINS(details, <span class="string">&#x27;&quot;music&quot;&#x27;</span>, <span class="string">&#x27;$.likes&#x27;</span>);</span><br></pre></td></tr></table></figure>
<p><img src="https://blog.wangweiye.cc/WX20220805-100948%402x.png"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> JSON_CONTAINS(details, <span class="string">&#x27;&quot;杭州市&quot;&#x27;</span>, <span class="string">&#x27;$.address.city&#x27;</span>) <span class="keyword">from</span> <span class="keyword">user</span>;</span><br></pre></td></tr></table></figure>
<p><img src="https://blog.wangweiye.cc/WX20220805-101734%402x.png"></p>
<ol start="4">
<li><code>JSON_SEARCH</code>函数，返回字符串匹配的路径</li>
</ol>
<p>使用方式: <code>JSON_SEARCH(json_doc, one_or_all, search_str[, escape_char[, path] ...])</code></p>
<ul>
<li><strong>one</strong>: The search terminates after the first match and returns one path string. It is undefined which match is considered first. <code>搜索在第一次匹配后终止，并返回一个路径字符串</code></li>
<li><strong>all</strong>: The search returns all matching path strings such that no duplicate paths are included. If there are multiple strings, they are autowrapped as an array. The order of the array elements is undefined. <code>搜索返回所有匹配的路径字符串</code></li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> json_search(details, <span class="string">&#x27;all&#x27;</span>, <span class="string">&#x27;music&#x27;</span>) <span class="keyword">from</span> <span class="keyword">user</span>;</span><br></pre></td></tr></table></figure>
<p><img src="https://blog.wangweiye.cc/WX20220805-101835%402x.png"></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> json_search(details, <span class="string">&#x27;one&#x27;</span>, <span class="string">&#x27;music&#x27;</span>) <span class="keyword">from</span> <span class="keyword">user</span>;</span><br></pre></td></tr></table></figure>
<p><img src="https://blog.wangweiye.cc/WX20220805-101904%402x.png"></p>
<h3 id="更新"><a href="#更新" class="headerlink" title="更新"></a>更新</h3><p><code>JSON_SET</code>更新如果key存在则覆盖，不存在则新增</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">where</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="keyword">update</span> <span class="keyword">user</span> <span class="keyword">set</span> details <span class="operator">=</span> JSON_SET(details, <span class="string">&#x27;$.phone&#x27;</span>, <span class="string">&#x27;13127366399&#x27;</span>, <span class="string">&#x27;$.email&#x27;</span>, <span class="string">&#x27;wwyknight@163.com&#x27;</span>) <span class="keyword">where</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure>
<p><img src="https://blog.wangweiye.cc/WX20220805-153758%402x.png"></p>
<p><code>JSON_INSERT</code>只是插入数据，不会替换已经存在的值</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">update</span> <span class="keyword">user</span> <span class="keyword">set</span> details <span class="operator">=</span> JSON_INSERT(details, <span class="string">&#x27;$.sex&#x27;</span>, <span class="string">&#x27;男&#x27;</span>, <span class="string">&#x27;$.age&#x27;</span>, <span class="string">&#x27;20&#x27;</span>) <span class="keyword">where</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure>
<p><img src="https://blog.wangweiye.cc/WX20220805-154436%402x.png"></p>
<p><code>JSON_REPLACE</code>只是替换已经存在的值，不存在的无影响</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">update</span> <span class="keyword">user</span> <span class="keyword">set</span> details <span class="operator">=</span> JSON_REPLACE(details, <span class="string">&#x27;$.age&#x27;</span>, <span class="number">20</span>, <span class="string">&#x27;$.height&#x27;</span>, <span class="number">180</span>) <span class="keyword">where</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure>
<p><img src="https://blog.wangweiye.cc/WX20220805-154842%402x.png"></p>
<p>总结:</p>
<ul>
<li><code>JSON_INSERT</code> 只新增，不更新</li>
<li><code>JSON_REPLACE</code> 只更新，不新增</li>
<li><code>JSON_SET</code> 既新增，也更新</li>
</ul>
<h3 id="删除"><a href="#删除" class="headerlink" title="删除"></a>删除</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">update</span> <span class="keyword">user</span> <span class="keyword">set</span> details <span class="operator">=</span> JSON_REMOVE(details, <span class="string">&#x27;$.email&#x27;</span>) <span class="keyword">where</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure>
<p><img src="https://blog.wangweiye.cc/WX20220805-155257%402x.png"></p>
<h3 id="其他函数"><a href="#其他函数" class="headerlink" title="其他函数"></a>其他函数</h3><p><code>JSON_KEYS()</code> 获取JSON文档中所有的key<br><img src="https://blog.wangweiye.cc/WX20220805-160351%402x.png"></p>
<p><code>JSON_LENGTH()</code>  给出JSON文档中的key的个数<br><img src="https://blog.wangweiye.cc/WX20220805-160608%402x.png"></p>
<p><code>JSON_MERGE()</code> 合并<br><img src="https://blog.wangweiye.cc/WX20220805-161320%402x.png"></p>
<p>参考<a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/8.0/en/json.html">https://dev.mysql.com/doc/refman/8.0/en/json.html</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://wangweiye01.github.io/blog/2022/07/29/db-backup/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="老枪">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Coding & Life">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Coding & Life">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/2022/07/29/db-backup/" class="post-title-link" itemprop="url">MySQL全量、增量备份与恢复</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-07-29 18:02:10" itemprop="dateCreated datePublished" datetime="2022-07-29T18:02:10+08:00">2022-07-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-06-16 15:54:53" itemprop="dateModified" datetime="2025-06-16T15:54:53+08:00">2025-06-16</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><img src="https://gttx-test.guan2018.com/usb-g97d2a3d4a_1280.jpeg"></p>
<p>数据安全重要性无需多言，本文讲解如何进行MySQL的备份与恢复</p>
<h1 id="全量备份"><a href="#全量备份" class="headerlink" title="全量备份"></a>全量备份</h1><h2 id="逻辑备份"><a href="#逻辑备份" class="headerlink" title="逻辑备份"></a>逻辑备份</h2><p>可以使用<code>mysqldump</code>直接备份所有库或者某一个库或者某一个库中的某个表</p>
<p>备份所有库</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqldump -uroot -p --lock-all-tables --all-databases &gt; all.sql</span><br></pre></td></tr></table></figure>

<p>备份某一个库(<code>test</code>库)</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqldump -uroot -p --lock-all-tables --databases test &gt; test.sql</span><br></pre></td></tr></table></figure>

<p>备份某一个库(<code>test</code>)中某一张(<code>hy_express</code>)表</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqldump -uroot -p --lock-all-tables test hy_express &gt; test.press.sql</span><br></pre></td></tr></table></figure>

<p><strong><code>--lock-all-tables</code>保证在导出过程中整个mysql实例加全局读锁，操作线上数据库谨慎添加该参数</strong></p>
<h1 id="增量备份"><a href="#增量备份" class="headerlink" title="增量备份"></a>增量备份</h1><p>增量备份是指在一次全备份或上一次增量备份后，以后每次的备份只需备份与前一次相比增加或者被修改的文件。这就意味着，第一次增量备份的对象是进行全备后所产生的增加和修改的文件</p>
<p>增量备份是使用bin-log日志进行备份的，所以需要开启bin-log日志</p>
<h2 id="开启bin-log"><a href="#开启bin-log" class="headerlink" title="开启bin-log"></a>开启bin-log</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line">log_bin=/var/mysql/mysql-bin</span><br><span class="line">server-id=1</span><br><span class="line">max_binlog_size=100m</span><br><span class="line">binlog_format=row</span><br></pre></td></tr></table></figure>
<ul>
<li><code>log_bin</code>日志路径，注意此路径必须<code>mysql</code>用户拥有读写权限</li>
<li><code>server-id</code>服务唯一标识，可以随机填写，但不要重复</li>
<li><code>max_binlog_size</code>单文件大小，超过此设置，生成新的文件。同时当MySQL数据库重启时，也会生成新的日志文件，文件序号递增</li>
<li><code>binlog_format</code>设置记录模式。<img src="https://gttx-test.guan2018.com/WX20220730-091319%402x.png"></li>
</ul>
<h2 id="binlog的一些常用操作"><a href="#binlog的一些常用操作" class="headerlink" title="binlog的一些常用操作"></a>binlog的一些常用操作</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash">show master logs; <span class="comment">#查看数据库所有日志文件</span></span></span><br></pre></td></tr></table></figure>
<p><img src="https://gttx-test.guan2018.com/master_logs.png"></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash">show binlog events <span class="keyword">in</span> <span class="string">&#x27;mysql-bin.000015&#x27;</span>; <span class="comment">#查看某个binlog文件信息</span></span></span><br></pre></td></tr></table></figure>
<p><img src="https://gttx-test.guan2018.com/WX20220730-092105%402x.png"></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash">flush logs; <span class="comment">#将缓存中的日志写磁盘，保存到当前binlog文件中，并产生一个新的binlog文件</span></span></span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash">flush logs; reset master; <span class="comment">#删除所有binlog，并重新开始记录</span></span></span><br></pre></td></tr></table></figure>

<h1 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h1><h2 id="准备全量数据"><a href="#准备全量数据" class="headerlink" title="准备全量数据"></a>准备全量数据</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash">create database t1;</span></span><br><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash">use t1;</span></span><br><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash">create table full(c1 int(10), c2 varchar(20)) engine=innodb;</span></span><br><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash">insert into full values(1, <span class="string">&#x27;full1&#x27;</span>), (2, <span class="string">&#x27;full2&#x27;</span>);</span></span><br></pre></td></tr></table></figure>

<h2 id="全量数据备份"><a href="#全量数据备份" class="headerlink" title="全量数据备份"></a>全量数据备份</h2><ol>
<li><p>备份前，数据库加读锁，防止数据在备份时写入</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash">flush tables with <span class="built_in">read</span> lock;</span></span><br></pre></td></tr></table></figure></li>
<li><p>将binlog刷盘，写入当前binlog(mysql-bin.000001)，再生成一个新的binlog</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash">flush logs;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>全量备份</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root] mysqldump -uroot -p --lock-all-tables --databases t1 &gt; t1.sql</span><br></pre></td></tr></table></figure>
</li>
<li><p>解除读锁</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash">unlock tables;</span></span><br></pre></td></tr></table></figure></li>
</ol>
<p>至此，全量备份结束。将全量数据文件<code>t1.sql</code>保存即可。数据库再有新的数据更新，会记录在<code>mysql-bin.000002</code>文件中</p>
<h2 id="准备增量数据"><a href="#准备增量数据" class="headerlink" title="准备增量数据"></a>准备增量数据</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash">create database t2;</span></span><br><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash">use t2;</span></span><br><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash">create table increment(c1 int(10), c2 varchar(20)) engine=innodb;</span></span><br><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash">insert into increment values(3, <span class="string">&#x27;increment1&#x27;</span>), (4, <span class="string">&#x27;increment2&#x27;</span>);</span></span><br></pre></td></tr></table></figure>

<h2 id="将第一份增量数据进行备份"><a href="#将第一份增量数据进行备份" class="headerlink" title="将第一份增量数据进行备份"></a>将第一份增量数据进行备份</h2><ol>
<li><p>备份前，数据库加读锁，防止数据在备份时写入</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash">flush tables with <span class="built_in">read</span> lock;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>将binlog刷盘，写入当前binlog(mysql-bin.000002)，再生成一个新的binlog</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash">flush logs;</span></span><br></pre></td></tr></table></figure></li>
<li><p>将增备文件(mysql-bin.000002)直接复制保存即可</p>
</li>
<li><p>解除读锁</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash">unlock tables;</span></span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="准备第二份增量数据"><a href="#准备第二份增量数据" class="headerlink" title="准备第二份增量数据"></a>准备第二份增量数据</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash">use t2;</span></span><br><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash">insert into increment values(5, <span class="string">&#x27;increment3&#x27;</span>), (6, <span class="string">&#x27;increment4&#x27;</span>);</span></span><br></pre></td></tr></table></figure>

<h2 id="将第二份增量数据备份"><a href="#将第二份增量数据备份" class="headerlink" title="将第二份增量数据备份"></a>将第二份增量数据备份</h2><p>步骤同上一步，生成<code>mysql-bin.000003</code>文件，复制保存</p>
<h2 id="模拟故障"><a href="#模拟故障" class="headerlink" title="模拟故障"></a>模拟故障</h2><p>删除<code>t1</code>和<code>t2</code>库</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash">drop database t1;</span></span><br><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash">drop database t2;</span></span><br></pre></td></tr></table></figure>

<h1 id="数据恢复"><a href="#数据恢复" class="headerlink" title="数据恢复"></a>数据恢复</h1><h2 id="还原全量备份数据"><a href="#还原全量备份数据" class="headerlink" title="还原全量备份数据"></a>还原全量备份数据</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -uroot -p &lt; t1.sql;</span><br></pre></td></tr></table></figure>
<p>此时，查看数据，恢复成功<br><img src="https://gttx-test.guan2018.com/WX20220730-102509%402x.png"></p>
<h2 id="还原增量备份数据"><a href="#还原增量备份数据" class="headerlink" title="还原增量备份数据"></a>还原增量备份数据</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqlbinlog mysql-bin.000002 | mysql -uroot -p</span><br></pre></td></tr></table></figure>

<p>查看结果，恢复成功</p>
<p><img src="https://gttx-test.guan2018.com/WX20220730-104207%402x.png"></p>
<h2 id="还原第二份增量"><a href="#还原第二份增量" class="headerlink" title="还原第二份增量"></a>还原第二份增量</h2><p>方法同上，查看数据</p>
<p><img src="https://gttx-test.guan2018.com/WX20220730-104335%402x.png"></p>
<p>至此数据全部还原成功！</p>
<h2 id="mysqlbinlog按照时间点和位置点恢复"><a href="#mysqlbinlog按照时间点和位置点恢复" class="headerlink" title="mysqlbinlog按照时间点和位置点恢复"></a>mysqlbinlog按照时间点和位置点恢复</h2><h3 id="按位置点恢复"><a href="#按位置点恢复" class="headerlink" title="按位置点恢复"></a>按位置点恢复</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqlbinlog --start-position=500 --stop-position=716 mysql-bin.000002 | mysql -uroot -p</span><br></pre></td></tr></table></figure>

<h3 id="按时间点恢复"><a href="#按时间点恢复" class="headerlink" title="按时间点恢复"></a>按时间点恢复</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqlbinlog --start-datetime=&#x27;2022-07-29 15:45:59&#x27;  --stop-datetime=&#x27;2022-07-29 15:46:24&#x27; mysql-bin.000002 | mysql -uroot -p</span><br></pre></td></tr></table></figure>

<p>生产中建议定期使用全量备份，然后搭配增量备份的方式来保证数据的安全性。附上全量备份脚本，在进行全量备份后对binlog进行刷盘，这样方便搭配恢复。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">获取当前时间</span></span><br><span class="line">date_now=$(date &quot;+%Y%m%d-%H%M%S&quot;)</span><br><span class="line">backUpFolder=/root/backup/full</span><br><span class="line">username=&quot;root&quot;</span><br><span class="line">password=&quot;xxx&quot;</span><br><span class="line">db_name=&quot;test&quot;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">日志记录文件</span></span><br><span class="line">logFile=/root/backup/full_bak.log</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">定义备份文件名</span></span><br><span class="line">fileName=&quot;$&#123;db_name&#125;_$&#123;date_now&#125;.sql&quot;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">定义备份文件目录</span></span><br><span class="line">backUpFileName=&quot;$&#123;backUpFolder&#125;/$&#123;fileName&#125;&quot;</span><br><span class="line">echo &quot;starting backup mysql $&#123;db_name&#125; at $&#123;date_now&#125;.&quot; &gt;&gt; $logFile</span><br><span class="line">/usr/bin/mysqldump -u$&#123;username&#125; -p$&#123;password&#125;  --lock-all-tables --flush-logs --databases $&#123;db_name&#125; &gt; $&#123;backUpFileName&#125;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">进入到备份文件目录</span></span><br><span class="line">cd $&#123;backUpFolder&#125;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">压缩备份文件</span></span><br><span class="line">tar zcvf $&#123;fileName&#125;.tar.gz $&#123;fileName&#125;</span><br><span class="line"></span><br><span class="line">date_end=$(date &quot;+%Y%m%d-%H%M%S&quot;)</span><br><span class="line">echo &quot;finish backup mysql database $&#123;db_name&#125; at $&#123;date_end&#125;. filename is $&#123;backUpFileName&#125;&quot; &gt;&gt; $logFile</span><br><span class="line">echo &quot;&quot; &gt;&gt; $logFile</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://wangweiye01.github.io/blog/2022/07/21/transactional-sync/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="老枪">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Coding & Life">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Coding & Life">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/2022/07/21/transactional-sync/" class="post-title-link" itemprop="url">Transactional注解导致锁失效的问题</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-07-21 16:59:55" itemprop="dateCreated datePublished" datetime="2022-07-21T16:59:55+08:00">2022-07-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-06-16 15:54:53" itemprop="dateModified" datetime="2025-06-16T15:54:53+08:00">2025-06-16</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><img src="https://gttx-test.guan2018.com/castle-g637f37890_1280.jpeg"></p>
<p>在工作实践中发现，很多人在Spring项目开发中，如果<code>@Transactional</code>注解结合同步锁或者分布式锁时，经常会犯错，今天在此记录问题，分析原因同时给出解决方案</p>
<h2 id="错误案例"><a href="#错误案例" class="headerlink" title="错误案例"></a>错误案例</h2><h3 id="数据库准备"><a href="#数据库准备" class="headerlink" title="数据库准备"></a>数据库准备</h3><p>新建一个<code>sys_user</code>表，同时把<code>username</code>字段设为唯一索引</p>
<h3 id="业务逻辑"><a href="#业务逻辑" class="headerlink" title="业务逻辑"></a>业务逻辑</h3><p><img src="https://gttx-test.guan2018.com/WX20220721-164048%402x.png"></p>
<p>新建一个接口<code>test</code>，在接口上添加<code>@Transactional</code>注解，同时方法内添加一个<code>synchronized</code>同步锁。方法实现的是查询<code>username</code>为<code>a</code>的用户是否存在，如果不存在插入一条<code>username</code>为<code>a</code>的记录</p>
<h3 id="测试问题"><a href="#测试问题" class="headerlink" title="测试问题"></a>测试问题</h3><p>我们使用<a target="_blank" rel="noopener" href="https://www.joedog.org/">siege</a>(一款压测工具)模拟并发请求</p>
<p><img src="https://gttx-test.guan2018.com/WX20220721-164105%402x.png"></p>
<p>通过压测，发现其中有1个请求失败，此时观察java控制台输出</p>
<p><img src="https://gttx-test.guan2018.com/WX20220721-164121%402x.png"><br>输出显示出现唯一索引冲突的问题导致插入失败。我们明明已经为方法整体增加了同步锁，为什么还会导致相同<code>username</code>执行插入的逻辑呢？</p>
<p>此处就是许多开发者经常犯的错误</p>
<h2 id="原因分析"><a href="#原因分析" class="headerlink" title="原因分析"></a>原因分析</h2><p>此时首先需要了解你当前使用数据库的事务隔离级别</p>
<p><img src="https://gttx-test.guan2018.com/WX20220722-091813%402x.png"></p>
<p>我这里使用的是<code>RR</code>级别，如果有对事务隔离不清楚的可以查看我这篇<a target="_blank" rel="noopener" href="https://www.wangweiye.cc/blog/2022/01/18/mysql-transaction-isolation/">文章</a></p>
<p><code>@Transactional</code>是使用代理机制实现的数据库事务，有时间我会单独讲一下它的原理。它会在请求进入方法之前开启事务，同时方法结束之后提交事务(或者发生异常时回滚)</p>
<p>此案例中，当两个请求同时打来，会各自开启数据库事务，同时只有1个请求获得锁，执行锁内代码。由于<strong>锁内代码是包含在事务之内的</strong>，所以当执行完锁内代码，释放锁之后，另一个请求就可以获得锁，执行锁内代码。此时由于数据库事务的隔离性，第2个请求并不能查到第1个请求新增的数据(无论第1个请求是否进行了事务提交)，所以它认为数据库并没有<code>username</code>为<code>a</code>的数据，再次执行插入时，由于数据库的唯一索引，导致程序报错</p>
<h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><p>既然是<strong>锁包含在事务之内</strong>导致的问题，那我们就把<strong>事务包含在锁内</strong>就能解决这个问题，代码如下<br><img src="https://gttx-test.guan2018.com/WX20220721-164214%402x.png"></p>
<p>我们抽象出一个<code>addUser</code>方法，该方法使用<code>@Transactional</code>注解。在调用该方法时，使用锁包围</p>
<p>通过多次测试，没有出现唯一索引冲突的问题<br><img src="https://gttx-test.guan2018.com/WX20220721-164157%402x.png"></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>当<code>@Transactional</code>和同步锁一起使用时，<strong>一定要将事务的开启和关闭包含在锁内</strong></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://wangweiye01.github.io/blog/2022/07/15/jvm-tools/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="老枪">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Coding & Life">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Coding & Life">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/2022/07/15/jvm-tools/" class="post-title-link" itemprop="url">JVM工具使用以及Arthas的简单使用</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-07-15 10:13:35" itemprop="dateCreated datePublished" datetime="2022-07-15T10:13:35+08:00">2022-07-15</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-06-16 15:54:53" itemprop="dateModified" datetime="2025-06-16T15:54:53+08:00">2025-06-16</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><img src="https://gttx-test.guan2018.com/pexels-christina-morillo-1181675.jpeg"></p>
<p>现实企业级线上应用可能会发生内存泄露、线程死锁、Java进程消耗CPU过高等等情况，有的人遇到上述问题只是重启服务，而不会深究问题根源，导致此后问题会重复出现，所以理解并解决这些问题是Java高级开发必备要求，本文将介绍JVM性能监控工具，帮你解决这些问题</p>
<blockquote>
<p>为什么java面试喜欢问垃圾回收以及内存模型这种问题？是属于面试八股文吗？</p>
</blockquote>
<blockquote>
<p>简历中你是否敢写<code>熟悉GC常用算法，熟悉常见垃圾回收器，具有实际JVM调优实战经验</code>?</p>
</blockquote>
<h2 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h2><h3 id="jps"><a href="#jps" class="headerlink" title="jps"></a>jps</h3><p>jps(JVM Process Status Tool)，它的功能和Linux中ps命令类似，可以列出正在运行的虚拟机进程</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jps 列出运行中的JVM进程</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jps -v 输出虚拟机进程启动时显式指定的JVM参数</span><br></pre></td></tr></table></figure>

<p><img src="https://gttx-test.guan2018.com/WX20220715-103246%402x.png"></p>
<h3 id="jmap"><a href="#jmap" class="headerlink" title="jmap"></a>jmap</h3><p>jmap(Memory Map for Java)生成虚拟机的内存快照，当内存飙升时候可以使用jmap来查看</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jmap -histo:live &lt;pid&gt; | more</span><br></pre></td></tr></table></figure>
<p>打印堆的对象统计，包括对象数 、内存大小等。这个命令执行的话，JVM会先触发GC，然后再统计信息<br><img src="https://gttx-test.guan2018.com/WX20220715-104219%402x.png"></p>
<table>
<thead>
<tr>
<th>参数</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>num</td>
<td>序号</td>
</tr>
<tr>
<td>#instances</td>
<td>实例数量</td>
</tr>
<tr>
<td>#bytes</td>
<td>占用内存大小</td>
</tr>
<tr>
<td>class name</td>
<td>类名称</td>
</tr>
</tbody></table>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jmap -dump:live,format=b,file=xxx &lt;pid&gt;</span><br></pre></td></tr></table></figure>
<p>在当前目录下导出一个存储当前堆内存信息的dump文件（dump文件是进程的内存镜像），文件中存储的是当时那一时刻的堆的信息</p>
<p>这个命令执行，JVM会把整个heap信息写入到一个文件，heap如果比较大的话，就会导致这个过程非常耗时，并且执行过程中为了保证dump信息是可靠的，所以会暂停应用，线上系统一定要慎用！</p>
<p><img src="https://gttx-test.guan2018.com/WX20220715-105703%402x.png"></p>
<p>导出成功后，用分析工具（比如jhat MAT）导入文件即可以分析</p>
<blockquote>
<p>因为jmap很耗时，建议在java项目启动时添加非标参数<code>-XX:+HeapDumpOnOutOfMemoryError</code>这样当溢出时会自动将内存快照打印</p>
</blockquote>
<h3 id="jstack"><a href="#jstack" class="headerlink" title="jstack"></a>jstack</h3><p>jstack(Stack Trace for Java)显示虚拟机的线程快照。线程快照就是当前虚拟机内每一条线程正在执行的方法堆栈的集合，生成线程快照的主要目的是定位线程出现长时间停顿的原因，如线程间死锁、死循环、请求外部资源导致的长时间等待等都是导致线程长时间停顿的常见原因。线程出现停顿的时候通过 jstack 来查看各个线程的调用堆栈，就可以知道没有响应的线程到底在后台做些什么事情，或者等待着什么资源</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jstack &lt;pid&gt; </span><br></pre></td></tr></table></figure>

<p><img src="https://gttx-test.guan2018.com/WX20220715-110414%402x.png"></p>
<table>
<thead>
<tr>
<th>参数</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>http-nio-8088-Acceptor-0</td>
<td>线程名</td>
</tr>
<tr>
<td>prio</td>
<td>java优先级</td>
</tr>
<tr>
<td>os_prio</td>
<td>操作系统优先级</td>
</tr>
<tr>
<td>tid</td>
<td>java线程的id, threadId</td>
</tr>
<tr>
<td>nid</td>
<td>系统内核里面的线程唯一id</td>
</tr>
</tbody></table>
<blockquote>
<p>使用实例：查找线上Java进程导致CPU占用过高的问题</p>
</blockquote>
<ol>
<li>使用一段死循环模拟CPU高占用</li>
</ol>
<p><img src="https://gttx-test.guan2018.com/WX20220715-111013%402x.png"></p>
<ol start="2">
<li><p>通过<code>top</code>命令查看当前cpu占用率最高的进程<br><img src="https://gttx-test.guan2018.com/WX20220715-111425%402x.png"></p>
</li>
<li><p>通过<code>top -H -p 9522</code>命令查看某个pid进程下各线程的cpu占用情况</p>
</li>
</ol>
<p><img src="https://gttx-test.guan2018.com/WX20220715-113137%402x.png"></p>
<p>可以看到线程id&#x3D;9548cpu占用率最高，因为线程id在jstack中是以十六进制显示的，我们将9548转成十六进制是：0x254c</p>
<ol start="4">
<li>使用<code>jstack 9522 | grep -10 &#39;0x254c&#39;</code>找到进程的调用堆栈情况，并通过<code>grep</code>按照线程id搜索，返回匹配结果前后<code>10</code>行的数据</li>
</ol>
<p><img src="https://gttx-test.guan2018.com/WX20220715-113621%402x.png"></p>
<ol start="5">
<li>结果：图中可以看到<code>JvmMonitorApplication</code>类的第18行导致的问题，分析正确</li>
</ol>
<p><strong>通过Arthas可以更快速的定位，后面给出方法</strong></p>
<h3 id="jinfo"><a href="#jinfo" class="headerlink" title="jinfo"></a>jinfo</h3><p>jinfo(Configuration Info for Java)的作用是实时查看和调整虚拟机各项参数。使用<code>jps</code>命令的<code>-v</code>参数可以查看虚拟机启动时显式指定的参数列表，但如果想知道未被显式指定的参数的系统默认值，就可以使用<code>info</code>进行查询</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">jinfo &lt;pid&gt; 查看所有参数</span><br><span class="line"></span><br><span class="line">jinfo -flags &lt;pid&gt; 查看JVM参数</span><br><span class="line"></span><br><span class="line">jinfo -sysprops &lt;pid&gt; 查看java系统参数</span><br></pre></td></tr></table></figure>

<h3 id="jstat"><a href="#jstat" class="headerlink" title="jstat"></a>jstat</h3><p>jstat(JVM Statistics Monitoring Tool)是用于监视虚拟机各种运行状态信息的命令行工具。它可以显示本地或者远程虚拟机进程中的类装载、内存、垃圾收集、JIT编译等运行数据，在没有GUI图形界面，只提供了纯文本控制台环境的服务器上，它将是运行期定位虚拟机性能问题的首选工具</p>
<p><img src="https://gttx-test.guan2018.com/WX20220715-185947%402x.png"></p>
<ul>
<li>class 用于查看类加载情况的统计</li>
<li>compiler 用于查看HotSpot中即时编译器编译情况的统计</li>
<li>gc 用于查看JVM中堆的垃圾收集情况的统计</li>
<li>gccapacity 用于查看新生代、老生代及持久代的存储容量情况</li>
<li>gcmetacapacity 显示metaspace的大小</li>
<li>gcnew 用于查看新生代垃圾收集的情况</li>
<li>gcnewcapacity 用于查看新生代存储容量的情况</li>
<li>gcold 用于查看老生代及持久代垃圾收集的情况</li>
<li>gcoldcapacity 用于查看老生代的容量</li>
<li>gcutil 显示垃圾收集信息</li>
<li>gccause 显示垃圾回收的相关信息（通-gcutil）,同时显示最后一次仅当前正在发生的垃圾收集的原因<br>-printcompilation 输出JIT编译的方法信息</li>
</ul>
<p>例子： 查看垃圾回收统计</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jstat -gc &lt;pid&gt; 1000 10</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>参数</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>-gc</td>
<td>打印方式</td>
</tr>
<tr>
<td><pid></td>
<td>进程id</td>
</tr>
<tr>
<td>1000</td>
<td>每1000ms打印一次</td>
</tr>
<tr>
<td>10</td>
<td>打印10次</td>
</tr>
</tbody></table>
<p><img src="https://gttx-test.guan2018.com/WX20220715-122816%402x.png"></p>
<table>
<thead>
<tr>
<th>参数</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>S0C</td>
<td>第一个幸存区的大小</td>
</tr>
<tr>
<td>S1C</td>
<td>第二个幸存区的大小</td>
</tr>
<tr>
<td>S0U</td>
<td>第一个幸存区的使用大小</td>
</tr>
<tr>
<td>S1U</td>
<td>第二个幸存区的使用大小</td>
</tr>
<tr>
<td>EC</td>
<td>伊甸园区的大小</td>
</tr>
<tr>
<td>EU</td>
<td>伊甸园的使用大小</td>
</tr>
<tr>
<td>OC</td>
<td>老年代的大小</td>
</tr>
<tr>
<td>OU</td>
<td>老年代的使用大小</td>
</tr>
<tr>
<td>MC</td>
<td>方法区大小</td>
</tr>
<tr>
<td>MU</td>
<td>方法区的使用大小</td>
</tr>
<tr>
<td>CCSC</td>
<td>压缩类空间大小</td>
</tr>
<tr>
<td>CCSU</td>
<td>压缩类空间的使用大小</td>
</tr>
<tr>
<td>YGC</td>
<td>年轻代垃圾回收次数</td>
</tr>
<tr>
<td>YGCT</td>
<td>年轻代垃圾回收消耗的时间</td>
</tr>
<tr>
<td>FGC</td>
<td>老年代回收次数</td>
</tr>
<tr>
<td>FGCT</td>
<td>老年代垃圾回收消耗的时间</td>
</tr>
<tr>
<td>CGC</td>
<td>并发回收次数</td>
</tr>
<tr>
<td>CGCT</td>
<td>并发回收消耗的时间</td>
</tr>
<tr>
<td>GCT</td>
<td>垃圾回收消耗总时间</td>
</tr>
</tbody></table>
<blockquote>
<p>使用实例：写一个需要频繁GC的程序，用<code>jstat</code>观察GC情况</p>
</blockquote>
<ol>
<li>代码</li>
</ol>
<p><img src="https://gttx-test.guan2018.com/WX20220715-124228%402x.png"></p>
<ol start="2">
<li>观察状态信息</li>
</ol>
<p><img src="https://gttx-test.guan2018.com/WX20220715-124426%402x.png"></p>
<p>分析图中结果可以发现YGC(年轻代垃圾回收次数)增加的非常快，而FGC(老年代回收次数)不会执行</p>
<h2 id="Arthas"><a href="#Arthas" class="headerlink" title="Arthas"></a>Arthas</h2><h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p><code>Arthas</code>是Alibaba开源的Java诊断工具，深受开发者喜爱。</p>
<p>安装方式极为简单，按照<a target="_blank" rel="noopener" href="https://arthas.aliyun.com/zh-cn/">首页</a>引导即可，下面介绍简单使用</p>
<h3 id="dashboard"><a href="#dashboard" class="headerlink" title="dashboard"></a>dashboard</h3><p>当前系统的实时数据面板</p>
<p><img src="https://gttx-test.guan2018.com/WX20220715-141552%402x.png"></p>
<p><img src="https://gttx-test.guan2018.com/dashboard20220715.png"></p>
<h3 id="thread"><a href="#thread" class="headerlink" title="thread"></a>thread</h3><p>查看当前线程信息，查看线程的堆栈</p>
<p><img src="https://gttx-test.guan2018.com/WX20220715-141639%402x.png"></p>
<p>实例1: 前文使用jstack查找线上Java进程导致CPU占用过高的问题，使用arthas会更加简单</p>
<ol>
<li>dashboard查询占用cpu较高线程</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dashboard</span><br></pre></td></tr></table></figure>

<p><img src="https://gttx-test.guan2018.com/WX20220715-141945%402x.png"><br>发现线程id为20(注意这个ID不能跟jstack中的nativeID一一对应)的线程占用过高</p>
<ol start="2">
<li>查看线程堆栈</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">thread 20</span><br></pre></td></tr></table></figure>

<p><img src="https://gttx-test.guan2018.com/WX20220715-142241%402x.png"><br>图中分析正确</p>
<p>实例2: 查询java进程中的所有死锁信息</p>
<ol>
<li>代码模拟死锁</li>
</ol>
<p><img src="https://gttx-test.guan2018.com/WX20220715-150812%402x.png"></p>
<ol start="2">
<li>启动Arthas,执行<code>thread -b</code>查看死锁位置</li>
</ol>
<p><img src="https://gttx-test.guan2018.com/WX20220715-150914%402x.png"><br>更多Arthas用法，去官网查询</p>
<p>同样使用<code>jstack</code>同样可以查找死锁</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jstack &lt;pid&gt; | grep -10 &#x27;deadlock&#x27;</span><br></pre></td></tr></table></figure>

<p><img src="https://gttx-test.guan2018.com/WX20220715-191234%402x.png"></p>
<p>可以看到图中<code>Thread-1</code>想要的锁被<code>Thread-2</code>持有；<code>Thread-2</code>想要的锁被<code>Thread-1</code>持有</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://wangweiye01.github.io/blog/2022/07/14/gc/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="老枪">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Coding & Life">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Coding & Life">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/2022/07/14/gc/" class="post-title-link" itemprop="url">垃圾回收</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-07-14 14:13:53" itemprop="dateCreated datePublished" datetime="2022-07-14T14:13:53+08:00">2022-07-14</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-06-16 15:54:53" itemprop="dateModified" datetime="2025-06-16T15:54:53+08:00">2025-06-16</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><img src="https://gttx-test.guan2018.com/pexels-vladislav-vasnetsov-2682683.jpeg" alt="垃圾回收"></p>
<h1 id="什么是垃圾"><a href="#什么是垃圾" class="headerlink" title="什么是垃圾"></a>什么是垃圾</h1><p>垃圾就是在程序运行中没有任何指向的对象，这个对象就是需要被回收的垃圾</p>
<h1 id="Java中的垃圾回收"><a href="#Java中的垃圾回收" class="headerlink" title="Java中的垃圾回收"></a>Java中的垃圾回收</h1><p>Java不像C语言那样，需要自己手动垃圾回收，而是将运行时产生的垃圾交给JVM处理。在Java的内存模型中主要分为堆、方法区、虚拟机栈、本地方法栈、程序计数器。垃圾回收器主要负责对堆中产生的垃圾对象进行回收。</p>
<p>Java中堆内存一般分为新生代和老年代，根据各个年代的特点采用不同的收集算法。据调查统计新生代中的对象只会在一次垃圾回收后存活10%(少量存活)，因此使用拷贝算法，老年代(对象存活率高)使用”标记清除”算法</p>
<h1 id="垃圾搜索算法"><a href="#垃圾搜索算法" class="headerlink" title="垃圾搜索算法"></a>垃圾搜索算法</h1><h2 id="引用计数算法-Reference-Counting"><a href="#引用计数算法-Reference-Counting" class="headerlink" title="引用计数算法(Reference Counting)"></a>引用计数算法(Reference Counting)</h2><p>给对象添加一个引用计数器，每当一个地方引用时，计数器加1；当引用失效时，计数器减1。计数器为0时，即可被回收</p>
<h2 id="根搜索算法-GC-Root-Tracing"><a href="#根搜索算法-GC-Root-Tracing" class="headerlink" title="根搜索算法(GC Root Tracing)"></a>根搜索算法(GC Root Tracing)</h2><p>过一系列的名为<strong>GC Root</strong>的对象作为起始点，从这些节点开始向下搜索，搜索所有走过的路径称为引用链（Reference Chain）,当一个对象到GC Root没有任何引用链相连时（用图论来说就是GC Root到这个对象不可达时），证明该对象是可以被回收的。</p>
<p><strong>Java采用了根搜索算法</strong></p>
<p>在Java中哪些对象可以成为GC Root?</p>
<ul>
<li>虚拟机栈(栈帧中的本地变量表)中的引用对象</li>
<li>方法区中的类静态属性引用的对象</li>
<li>方法区中的常量引用对象</li>
<li>本地方法栈中JNI(即Native方法)的引用对象</li>
</ul>
<p><img src="https://gttx-test.guan2018.com/ccc0d1e1e60022b8bd6b8520f759917f.png"></p>
<h1 id="垃圾清除算法"><a href="#垃圾清除算法" class="headerlink" title="垃圾清除算法"></a>垃圾清除算法</h1><h2 id="标记清除算法-Mark-Sweep"><a href="#标记清除算法-Mark-Sweep" class="headerlink" title="标记清除算法(Mark-Sweep)"></a>标记清除算法(Mark-Sweep)</h2><p>最基础的垃圾处理器算法，分为“标记”和“清除”两个阶段。先标记需要回收的对象，标记完成后，统一回收掉所有被标记的对象。js通常采用此算法</p>
<p>缺点: </p>
<ol>
<li>效率低，标记和清除的效率都不高</li>
<li>清除后会产生大量的不连续内存碎片，可能会导致在程序需要为较大对象分配内存时无法找到足够连续的内存，不得不提前触发垃圾回收动作。</li>
</ol>
<p><img src="https://gttx-test.guan2018.com/20220714-%E6%A0%87%E8%AE%B0%E6%B8%85%E9%99%A4.png"></p>
<h2 id="拷贝算法-Copying"><a href="#拷贝算法-Copying" class="headerlink" title="拷贝算法(Copying)"></a>拷贝算法(Copying)</h2><p>将内存容量分成大小相等的两块，每次只使用其中一块，当一块用完时，将还存活的对象复制到另一块去，然后把之前使用满的那块空间一次性清理掉，如此反复</p>
<p>缺点: 内存空间浪费大，每次只能使用当前能够使用内存空间的一半；当对象存活率较高时，需要有大量的复制操作，效率低</p>
<p><img src="https://gttx-test.guan2018.com/20220714-%E6%8B%B7%E8%B4%9D%E7%AE%97%E6%B3%95.png"></p>
<h2 id="标记整理算法-Mark-Compact"><a href="#标记整理算法-Mark-Compact" class="headerlink" title="标记整理算法(Mark-Compact)"></a>标记整理算法(Mark-Compact)</h2><p>标记整理是在标记-清除上改进得来，前面说到标记-清除内存碎片的问题，在标记-整理中有解决。同样有标记阶段，标记出所有需要回收的对象，但是不会直接清理，而是将存活的对象向一端移动，在移动过程中清理掉可回收对象</p>
<p><img src="https://gttx-test.guan2018.com/20220714-%E6%A0%87%E8%AE%B0%E6%95%B4%E7%90%86.png"></p>
<h2 id="分代收集算法"><a href="#分代收集算法" class="headerlink" title="分代收集算法"></a>分代收集算法</h2><p><img src="https://gttx-test.guan2018.com/20220715%E5%A0%86%E5%86%85%E5%AD%98.webp"></p>
<ul>
<li>堆内存被划分为两块，一块是<strong>年轻代</strong>，另一块是<strong>老年代</strong></li>
<li>年轻代又分为<strong>Eden</strong>和<strong>Survivor</strong>他俩空间大小比例默认为8:2</li>
<li>幸存区又分为<strong>s0</strong>和<strong>s1</strong>这两个空间大小是一模一样的，就是一对双胞胎，他俩是1:1比例</li>
</ul>
<h3 id="回收过程"><a href="#回收过程" class="headerlink" title="回收过程"></a>回收过程</h3><ol>
<li>新生成的对象首先放到<strong>Eden</strong>区，当<strong>Eden</strong>区满了会触发<strong>Minor GC</strong></li>
<li>第一步GC活下来的对象，会被移动到<strong>Survivor</strong>区中的S0区，S0区满了之后会触发<strong>Minor GC</strong>，S0区存活下来的对象会被移动到S1区，S0区空闲。S1满了之后再GC，存活下来的再次移动到S0区，S1区空闲，这样反反复复GC，每GC一次，对象的年龄就涨一岁，达到某个值(默认15)后，就会进入<strong>老年代</strong></li>
<li>在发生一次<strong>Minor Gc</strong>后(前提条件)，老年代可能会出现<strong>Major GC</strong></li>
</ol>
<h4 id="Full-GC触发条件"><a href="#Full-GC触发条件" class="headerlink" title="Full GC触发条件"></a>Full GC触发条件</h4><ul>
<li>手动调用System.gc，会不断的执行Full GC</li>
<li>老年代空间不足&#x2F;满了</li>
<li>方法区空间不足&#x2F;满了</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/blog/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/blog/page/9/">9</a><a class="extend next" rel="next" title="Next page" aria-label="Next page" href="/blog/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">老枪</span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>

</body>
</html>
