<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/blog/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/blog/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/blog/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/blog/images/logo.svg" color="#222">

<link rel="stylesheet" href="/blog/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha256-dABdfBfUoC8vJUBOwGVdm8L9qlMWaHTIfXt+7GnZCIo=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"wangweiye01.github.io","root":"/blog/","images":"/blog/images","scheme":"Muse","darkmode":false,"version":"8.23.1","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"codeblock":{"theme":{"light":"default","dark":"stackoverflow-dark"},"prism":{"light":"prism","dark":"prism-dark"},"copy_button":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"language":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/blog/js/config.js" defer></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="Coding &amp; Life">
<meta property="og:url" content="https://wangweiye01.github.io/blog/page/2/index.html">
<meta property="og:site_name" content="Coding &amp; Life">
<meta property="og:locale">
<meta property="article:author" content="老枪">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://wangweiye01.github.io/blog/page/2/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-Hans","comments":"","permalink":"","path":"page/2/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Coding & Life</title>
  








  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
<script src="/blog/js/utils.js" defer></script><script src="/blog/js/motion.js" defer></script><script src="/blog/js/sidebar.js" defer></script><script src="/blog/js/next-boot.js" defer></script>

  






  





  <noscript>
    <link rel="stylesheet" href="/blog/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
    </div>
  </div>

  <div class="site-meta">

    <a href="/blog/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Coding & Life</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">求知若饥，虚心若愚</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>







</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">老枪</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/blog/archives/">
          <span class="site-state-item-count">91</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/blog/categories/">
        <span class="site-state-item-count">2</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">tags</span>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://wangweiye01.github.io/blog/2022/07/14/gc/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="老枪">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Coding & Life">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Coding & Life">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/2022/07/14/gc/" class="post-title-link" itemprop="url">垃圾回收</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-07-14 14:13:53" itemprop="dateCreated datePublished" datetime="2022-07-14T14:13:53+08:00">2022-07-14</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-06-16 15:54:53" itemprop="dateModified" datetime="2025-06-16T15:54:53+08:00">2025-06-16</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><img src="https://gttx-test.guan2018.com/pexels-vladislav-vasnetsov-2682683.jpeg" alt="垃圾回收"></p>
<h1 id="什么是垃圾"><a href="#什么是垃圾" class="headerlink" title="什么是垃圾"></a>什么是垃圾</h1><p>垃圾就是在程序运行中没有任何指向的对象，这个对象就是需要被回收的垃圾</p>
<h1 id="Java中的垃圾回收"><a href="#Java中的垃圾回收" class="headerlink" title="Java中的垃圾回收"></a>Java中的垃圾回收</h1><p>Java不像C语言那样，需要自己手动垃圾回收，而是将运行时产生的垃圾交给JVM处理。在Java的内存模型中主要分为堆、方法区、虚拟机栈、本地方法栈、程序计数器。垃圾回收器主要负责对堆中产生的垃圾对象进行回收。</p>
<p>Java中堆内存一般分为新生代和老年代，根据各个年代的特点采用不同的收集算法。据调查统计新生代中的对象只会在一次垃圾回收后存活10%(少量存活)，因此使用拷贝算法，老年代(对象存活率高)使用”标记清除”算法</p>
<h1 id="垃圾搜索算法"><a href="#垃圾搜索算法" class="headerlink" title="垃圾搜索算法"></a>垃圾搜索算法</h1><h2 id="引用计数算法-Reference-Counting"><a href="#引用计数算法-Reference-Counting" class="headerlink" title="引用计数算法(Reference Counting)"></a>引用计数算法(Reference Counting)</h2><p>给对象添加一个引用计数器，每当一个地方引用时，计数器加1；当引用失效时，计数器减1。计数器为0时，即可被回收</p>
<h2 id="根搜索算法-GC-Root-Tracing"><a href="#根搜索算法-GC-Root-Tracing" class="headerlink" title="根搜索算法(GC Root Tracing)"></a>根搜索算法(GC Root Tracing)</h2><p>过一系列的名为<strong>GC Root</strong>的对象作为起始点，从这些节点开始向下搜索，搜索所有走过的路径称为引用链（Reference Chain）,当一个对象到GC Root没有任何引用链相连时（用图论来说就是GC Root到这个对象不可达时），证明该对象是可以被回收的。</p>
<p><strong>Java采用了根搜索算法</strong></p>
<p>在Java中哪些对象可以成为GC Root?</p>
<ul>
<li>虚拟机栈(栈帧中的本地变量表)中的引用对象</li>
<li>方法区中的类静态属性引用的对象</li>
<li>方法区中的常量引用对象</li>
<li>本地方法栈中JNI(即Native方法)的引用对象</li>
</ul>
<p><img src="https://gttx-test.guan2018.com/ccc0d1e1e60022b8bd6b8520f759917f.png"></p>
<h1 id="垃圾清除算法"><a href="#垃圾清除算法" class="headerlink" title="垃圾清除算法"></a>垃圾清除算法</h1><h2 id="标记清除算法-Mark-Sweep"><a href="#标记清除算法-Mark-Sweep" class="headerlink" title="标记清除算法(Mark-Sweep)"></a>标记清除算法(Mark-Sweep)</h2><p>最基础的垃圾处理器算法，分为“标记”和“清除”两个阶段。先标记需要回收的对象，标记完成后，统一回收掉所有被标记的对象。js通常采用此算法</p>
<p>缺点: </p>
<ol>
<li>效率低，标记和清除的效率都不高</li>
<li>清除后会产生大量的不连续内存碎片，可能会导致在程序需要为较大对象分配内存时无法找到足够连续的内存，不得不提前触发垃圾回收动作。</li>
</ol>
<p><img src="https://gttx-test.guan2018.com/20220714-%E6%A0%87%E8%AE%B0%E6%B8%85%E9%99%A4.png"></p>
<h2 id="拷贝算法-Copying"><a href="#拷贝算法-Copying" class="headerlink" title="拷贝算法(Copying)"></a>拷贝算法(Copying)</h2><p>将内存容量分成大小相等的两块，每次只使用其中一块，当一块用完时，将还存活的对象复制到另一块去，然后把之前使用满的那块空间一次性清理掉，如此反复</p>
<p>缺点: 内存空间浪费大，每次只能使用当前能够使用内存空间的一半；当对象存活率较高时，需要有大量的复制操作，效率低</p>
<p><img src="https://gttx-test.guan2018.com/20220714-%E6%8B%B7%E8%B4%9D%E7%AE%97%E6%B3%95.png"></p>
<h2 id="标记整理算法-Mark-Compact"><a href="#标记整理算法-Mark-Compact" class="headerlink" title="标记整理算法(Mark-Compact)"></a>标记整理算法(Mark-Compact)</h2><p>标记整理是在标记-清除上改进得来，前面说到标记-清除内存碎片的问题，在标记-整理中有解决。同样有标记阶段，标记出所有需要回收的对象，但是不会直接清理，而是将存活的对象向一端移动，在移动过程中清理掉可回收对象</p>
<p><img src="https://gttx-test.guan2018.com/20220714-%E6%A0%87%E8%AE%B0%E6%95%B4%E7%90%86.png"></p>
<h2 id="分代收集算法"><a href="#分代收集算法" class="headerlink" title="分代收集算法"></a>分代收集算法</h2><p><img src="https://gttx-test.guan2018.com/20220715%E5%A0%86%E5%86%85%E5%AD%98.webp"></p>
<ul>
<li>堆内存被划分为两块，一块是<strong>年轻代</strong>，另一块是<strong>老年代</strong></li>
<li>年轻代又分为<strong>Eden</strong>和<strong>Survivor</strong>他俩空间大小比例默认为8:2</li>
<li>幸存区又分为<strong>s0</strong>和<strong>s1</strong>这两个空间大小是一模一样的，就是一对双胞胎，他俩是1:1比例</li>
</ul>
<h3 id="回收过程"><a href="#回收过程" class="headerlink" title="回收过程"></a>回收过程</h3><ol>
<li>新生成的对象首先放到<strong>Eden</strong>区，当<strong>Eden</strong>区满了会触发<strong>Minor GC</strong></li>
<li>第一步GC活下来的对象，会被移动到<strong>Survivor</strong>区中的S0区，S0区满了之后会触发<strong>Minor GC</strong>，S0区存活下来的对象会被移动到S1区，S0区空闲。S1满了之后再GC，存活下来的再次移动到S0区，S1区空闲，这样反反复复GC，每GC一次，对象的年龄就涨一岁，达到某个值(默认15)后，就会进入<strong>老年代</strong></li>
<li>在发生一次<strong>Minor Gc</strong>后(前提条件)，老年代可能会出现<strong>Major GC</strong></li>
</ol>
<h4 id="Full-GC触发条件"><a href="#Full-GC触发条件" class="headerlink" title="Full GC触发条件"></a>Full GC触发条件</h4><ul>
<li>手动调用System.gc，会不断的执行Full GC</li>
<li>老年代空间不足&#x2F;满了</li>
<li>方法区空间不足&#x2F;满了</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://wangweiye01.github.io/blog/2022/06/10/redis-cluster/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="老枪">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Coding & Life">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Coding & Life">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/2022/06/10/redis-cluster/" class="post-title-link" itemprop="url">CentOS7搭建Redis5.0.14集群</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-06-10 11:45:15" itemprop="dateCreated datePublished" datetime="2022-06-10T11:45:15+08:00">2022-06-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-06-16 15:54:53" itemprop="dateModified" datetime="2025-06-16T15:54:53+08:00">2025-06-16</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><img src="http://gttx-test.guan2018.com/grapes-gdf2655f95_1280.jpeg" alt="pic"></p>
<h2 id="集群概念"><a href="#集群概念" class="headerlink" title="集群概念"></a>集群概念</h2><p>Redis集群实现了对Redis的水平扩容，即启动N个Redis节点，将整个数据库分布存储在这N个节点中，每个节点存储总数据的1&#x2F;N。每个节点负责一部分插槽(<code>slot</code>)，注意在Redis Cluster中，只有mater才拥有插槽的所有权。</p>
<h2 id="分片实现"><a href="#分片实现" class="headerlink" title="分片实现"></a>分片实现</h2><p>Redis集群通过分片的方式来保存数据库中的键值对，集群的整个数据库被分为16384(0-16383)个槽，数据库中的每个键都属于这16384个槽的其中一个，集群中的每个节点可以处理0个或最多16384个。只有当数据库中的16384个槽都有节点在处理时，集群才处于上线状态。</p>
<h2 id="集群搭建"><a href="#集群搭建" class="headerlink" title="集群搭建"></a>集群搭建</h2><p>我们在一台机器上使用6个端口，模拟集群搭建</p>
<h3 id="安装Redis"><a href="#安装Redis" class="headerlink" title="安装Redis"></a>安装Redis</h3><p>下载redis安装包，进行解压，编译，安装。此处省略</p>
<h3 id="集群配置"><a href="#集群配置" class="headerlink" title="集群配置"></a>集群配置</h3><ol>
<li>创建6个节点的配置文件目录<code>conf</code>，日志目录<code>logs</code>，数据存储目录<code>data</code>，如下命令：</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /usr/local/redis/redis_cluster/7001/conf/</span><br><span class="line">mkdir -p /usr/local/redis/redis_cluster/7001/logs/</span><br><span class="line">mkdir -p /usr/local/redis/redis_cluster/7001/data/</span><br><span class="line"></span><br><span class="line">mkdir -p /usr/local/redis/redis_cluster/7002/conf/</span><br><span class="line">mkdir -p /usr/local/redis/redis_cluster/7002/logs/</span><br><span class="line">mkdir -p /usr/local/redis/redis_cluster/7002/data/</span><br><span class="line"></span><br><span class="line">mkdir -p /usr/local/redis/redis_cluster/7003/conf/</span><br><span class="line">mkdir -p /usr/local/redis/redis_cluster/7003/logs/</span><br><span class="line">mkdir -p /usr/local/redis/redis_cluster/7003/data/</span><br><span class="line"></span><br><span class="line">mkdir -p /usr/local/redis/redis_cluster/7004/conf/</span><br><span class="line">mkdir -p /usr/local/redis/redis_cluster/7004/logs/</span><br><span class="line">mkdir -p /usr/local/redis/redis_cluster/7004/data/</span><br><span class="line"></span><br><span class="line">mkdir -p /usr/local/redis/redis_cluster/7005/conf/</span><br><span class="line">mkdir -p /usr/local/redis/redis_cluster/7005/logs/</span><br><span class="line">mkdir -p /usr/local/redis/redis_cluster/7005/data/</span><br><span class="line"></span><br><span class="line">mkdir -p /usr/local/redis/redis_cluster/7006/conf/</span><br><span class="line">mkdir -p /usr/local/redis/redis_cluster/7006/logs/</span><br><span class="line">mkdir -p /usr/local/redis/redis_cluster/7006/data/</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>创建7001的配置文件，并添加如下内容</li>
</ol>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 绑定服务器域名或IP地址</span></span><br><span class="line"><span class="attribute">bind</span> <span class="number">127.0.0.1</span></span><br><span class="line"><span class="comment"># 设置端口，区分集群中Redis的实例</span></span><br><span class="line">port <span class="number">7001</span></span><br><span class="line"><span class="comment"># 后台运行</span></span><br><span class="line">daemonize <span class="literal">yes</span></span><br><span class="line"><span class="comment"># pid进程文件名，以端口号命名</span></span><br><span class="line">pidfile /var/run/redis-<span class="number">7001</span>.pid</span><br><span class="line"><span class="comment"># 日志文件名称，以端口号为目录来区分</span></span><br><span class="line">logfile /usr/local/redis/redis_cluster/<span class="number">7001</span>/logs/redis.log</span><br><span class="line"><span class="comment"># 数据文件存放地址，以端口号为目录名来区分</span></span><br><span class="line">dir /usr/local/redis/redis_cluster/<span class="number">7001</span>/data</span><br><span class="line"><span class="comment"># 启用集群</span></span><br><span class="line">cluster-enabled <span class="literal">yes</span></span><br><span class="line"><span class="comment"># 配置每个节点的配置文件，同样以端口号为名称</span></span><br><span class="line">cluster-config-file nodes_7001.conf</span><br><span class="line"><span class="comment"># 配置集群节点的超时时间</span></span><br><span class="line">cluster-node-timeout <span class="number">15000</span></span><br><span class="line"><span class="comment"># 启动AOF增量持久化策略</span></span><br><span class="line">appendonly <span class="literal">yes</span></span><br><span class="line"><span class="comment"># 发生改变，则记录日志</span></span><br><span class="line">appendfsync always</span><br></pre></td></tr></table></figure>

<p>其他节点配置文件仿照7001分别创建</p>
<h3 id="启动集群"><a href="#启动集群" class="headerlink" title="启动集群"></a>启动集群</h3><ol>
<li>启动每一个Redis节点</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">redis-server /usr/local/redis/redis_cluster/7001/conf/redis.conf</span><br><span class="line">redis-server /usr/local/redis/redis_cluster/7002/conf/redis.conf</span><br><span class="line">redis-server /usr/local/redis/redis_cluster/7003/conf/redis.conf</span><br><span class="line">redis-server /usr/local/redis/redis_cluster/7004/conf/redis.conf</span><br><span class="line">redis-server /usr/local/redis/redis_cluster/7005/conf/redis.conf</span><br><span class="line">redis-server /usr/local/redis/redis_cluster/7006/conf/redis.conf</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>使用redis-cli创建Redis集群</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli --cluster create 127.0.0.1:7001 127.0.0.1:7002 127.0.0.1:7003 127.0.0.1:7004 127.0.0.1:7005 127.0.0.1:7006 --cluster-replicas 1</span><br></pre></td></tr></table></figure>

<ul>
<li><code>redis-cli --cluster</code>代表集群操作命令</li>
<li><code>create</code> 代表创建集群</li>
<li><code>--cluster-replicas 1</code> 指定集群中每个mater的副本数为1，此时<code>节点总数 ÷ (replicas + 1)</code>得到的就是master的数量n。因此节点列表中的前n个就是master节点，其他节点都是slave节点，随机分配到不同master</li>
</ul>
<ol start="3">
<li>查看刚创建的集群状态，如下命令：（在任一台机器中查看任一节点信息，会带出所有节点信息）</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli --cluster check 127.0.0.1:7001</span><br></pre></td></tr></table></figure>

<p><img src="http://gttx-test.guan2018.com/WX20220610-142526%402x.png" alt="节点信息"></p>
<ol start="4">
<li>测试集群是否正常</li>
</ol>
<p>连接集群中任一节点，注意：集群操作时，需要给redis-cli加上-c参数才可以</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -c -p 7001</span><br></pre></td></tr></table></figure>

<p>添加一个key进入集群</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:7001&gt; set name wangweiye</span><br><span class="line"><span class="meta prompt_">-&gt; </span><span class="language-bash">Redirected to slot [5798] located at 127.0.0.1:7002</span></span><br><span class="line">OK</span><br><span class="line">127.0.0.1:7002&gt;</span><br></pre></td></tr></table></figure>

<p>可以看到，set之后，Redis会自动重定向到7002节点的5798插槽，接着我们进入7003节点，观察是否能查到此key</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:7003&gt; get name</span><br><span class="line"><span class="meta prompt_">-&gt; </span><span class="language-bash">Redirected to slot [5798] located at 127.0.0.1:7002</span></span><br><span class="line">&quot;wangweiye&quot;</span><br><span class="line">127.0.0.1:7002&gt;</span><br></pre></td></tr></table></figure>
<p>出现以上结果，说明我们搭建的集群运作正常。当集群中某个master节点故障时，相应的slave节点会自动升级为master，保证集群的可靠性。当故障节点恢复正常，则变为slave节点提供副本职能，请自行测试</p>
<h2 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h2><p>Redis集群中每个实例会使用两个TCP端口，一个用于客户端(redis-cli或其他应用)通信，另一个用于集群中实例相互通信的总线端口，且第二个端口比第一个端口一定大1000。如果外网配置时，请注意网络的连通性</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://wangweiye01.github.io/blog/2022/06/10/dynamic-datasource/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="老枪">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Coding & Life">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Coding & Life">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/2022/06/10/dynamic-datasource/" class="post-title-link" itemprop="url">Spring Boot切换多数据源</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-06-10 08:53:13" itemprop="dateCreated datePublished" datetime="2022-06-10T08:53:13+08:00">2022-06-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-06-16 15:54:53" itemprop="dateModified" datetime="2025-06-16T15:54:53+08:00">2025-06-16</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><img src="http://gttx-test.guan2018.com/pexels-marina-leonova-9374414.jpeg" alt="pic"></p>
<p>在开发场景中，如果需要对接第三方系统的数据库，与自己的应用结合，这时就需要动态切换数据库进行对接</p>
<h2 id="什么是多数据源"><a href="#什么是多数据源" class="headerlink" title="什么是多数据源"></a>什么是多数据源</h2><p>最常见的单一应用中最多涉及到一个数据库，既是一个数据源(<code>DataSource</code>)。那么顾名思义，多数据源就是在一个单一应用中涉及到了两个及以上的数据库。</p>
<p>其实在配置数据源的时候就已经很明确这个定义了，如以下代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean(name = &quot;dataSource&quot;)</span></span><br><span class="line"><span class="keyword">public</span> DataSource <span class="title function_">dataSource</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="type">DruidDataSource</span> <span class="variable">druidDataSource</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DruidDataSource</span>();</span><br><span class="line">  druidDataSource.setUrl(url);</span><br><span class="line">  druidDataSource.setUsername(username);</span><br><span class="line">  druidDataSource.setDriverClassName(driverClassName);</span><br><span class="line">  druidDataSource.setPassword(password);</span><br><span class="line">  <span class="keyword">return</span> druidDataSource;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>url</code>、<code>username</code>、<code>password</code>这三个属性已经唯一确定了一个数据库了，<code>DataSource</code>则是依赖这三个创建出来的。则多数据源即是配置多个<code>DataSource</code></p>
</blockquote>
<h2 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h2><p>相信大多数做过医疗系统的都会和<code>HIS</code>打交道，为了简化护士以及医生的操作流程，必须要将必要的信息从<code>HIS</code>系统对接过来，对接方式可以通过<code>HIS</code>提供视图，比如医护视图，患者视图等，而此时其他系统只需要定时从<code>HIS</code>视图中读取数据同步到自己数据库中即可。这是就涉及到了至少两个数据库了，一个是<code>HIS</code>数据库，一个自己系统的数据库，在单一应用中必然需要用到<code>多数据源切换</code>才能达到目的。</p>
<h2 id="整合单一的数据源"><a href="#整合单一的数据源" class="headerlink" title="整合单一的数据源"></a>整合单一的数据源</h2><p>本文使用阿里的数据库连接池<code>druid</code>，添加依赖如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>druid-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.9<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>Druid连接池的<code>starter</code>的自动配置类是<code>DruidDataSourceAutoConfigure</code>，类上标注如下一行注解：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableConfigurationProperties(&#123;DruidStatProperties.class, DataSourceProperties.class&#125;)</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>@EnableConfigurationProperties</code>这个注解使得配置文件中的配置生效并且映射到指定类的属性</p>
</blockquote>
<p><code>DruidStatProperties</code>中指定的前缀是<code>spring.datasource.druid</code>，这个配置主要是用来设置连接池的一些参数。</p>
<p><code>DataSourceProperties</code>中指定的前缀是<code>spring.datasource</code>，这个主要是用来设置数据库的<code>url</code>、<code>username</code>、<code>password</code>等信息。</p>
<p>因此我们只需要在全局配置文件中指定<code>数据库的一些配置</code>以及<code>连接池的一些配置</code>信息即可，前缀分别是<code>spring.datasource.druid</code>、<code>spring.datasource</code></p>
<blockquote>
<p>在全局配置文件<code>application.yml</code>中配置数据库信息即可注入一个数据源到Spring Boot中。其实这仅仅是一种方式，下面介绍另外一种方式。</p>
</blockquote>
<p>在自动配置类中<code>DruidDataSourceAutoConfigure</code>中有如下一段代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean(initMethod = &quot;init&quot;)</span></span><br><span class="line"><span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line"><span class="keyword">public</span> DataSource <span class="title function_">dataSource</span><span class="params">()</span> &#123;</span><br><span class="line">  LOGGER.info(<span class="string">&quot;Init DruidDataSource&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DruidDataSourceWrapper</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>@ConditionalOnMissingBean</code>和<code>@Bean</code>这两个注解的结合，意味着我们可以覆盖，只需要提前在<code>IOC</code>中注入一个<code>DataSource</code>类型的<code>Bean</code>即可。</p>
</blockquote>
<p>因此我们在自定义的配置类中定义如下配置即可：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Bean</span>：向IOC容器中注入一个Bean</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ConfigurationProperties</span>：使得配置文件中以spring.datasource为前缀的属性映射到Bean的属性中</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;spring.datasource&quot;)</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> DataSource <span class="title function_">dataSource</span><span class="params">()</span>&#123;</span><br><span class="line">  <span class="comment">//做一些其他的自定义配置，比如密码加密等......</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DruidDataSource</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>以上介绍了两种数据源的配置方式，第一种比较简单，第二种适合扩展，按需选择</p>
</blockquote>
<h2 id="整合Mybatis"><a href="#整合Mybatis" class="headerlink" title="整合Mybatis"></a>整合Mybatis</h2><p>Spring Boot整合Mybatis其实很简单，简单的几步就搞定，首先添加依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>第二步找到自动配置类<code>MybatisAutoConfiguration</code>，有如下一行代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableConfigurationProperties(&#123;MybatisProperties.class&#125;)</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>老套路了，全局配置文件中配置前缀为<code>mybatis</code>的配置将会映射到该类中的属性</p>
</blockquote>
<p>直接在全局配置文件配置各种属性是一种比较简单的方式，其实的任何组件的整合都有不少于两种的配置方式，下面来介绍下配置类如何配置。</p>
<p><code>MybatisAutoConfiguration</code>自动配置类中有如下一段代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line"><span class="keyword">public</span> SqlSessionFactory <span class="title function_">sqlSessionFactory</span><span class="params">(DataSource dataSource)</span> <span class="keyword">throws</span> Exception &#123;&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>@ConditionalOnMissingBean</code>和<code>@Bean</code>真是老搭档了，意外着我们又可以覆盖，只需要在IOC容器中注入<code>SqlSessionFactory</code>(Mybatis六剑客之一生产者)</p>
</blockquote>
<p>在自定义配置类中注入即可，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 注入SqlSessionFactory</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Bean(&quot;sqlSessionFactory1&quot;)</span></span><br><span class="line"><span class="keyword">public</span> SqlSessionFactory <span class="title function_">sqlSessionFactory</span><span class="params">(DataSource dataSource)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">  <span class="type">SqlSessionFactoryBean</span> <span class="variable">sqlSessionFactoryBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SqlSessionFactoryBean</span>();</span><br><span class="line">  sqlSessionFactoryBean.setDataSource(dataSource);</span><br><span class="line">  sqlSessionFactoryBean.setMapperLocations(<span class="keyword">new</span> <span class="title class_">PathMatchingResourcePatternResolver</span>().getResources(<span class="string">&quot;classpath*:/mapper/**/*.xml&quot;</span>));</span><br><span class="line">  org.apache.ibatis.session.<span class="type">Configuration</span> <span class="variable">configuration</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">org</span>.apache.ibatis.session.Configuration();</span><br><span class="line">  <span class="comment">// 自动将数据库中的下划线转换为驼峰格式</span></span><br><span class="line">  configuration.setMapUnderscoreToCamelCase(<span class="literal">true</span>);</span><br><span class="line">  configuration.setDefaultFetchSize(<span class="number">100</span>);</span><br><span class="line">  configuration.setDefaultStatementTimeout(<span class="number">30</span>);</span><br><span class="line">  sqlSessionFactoryBean.setConfiguration(configuration);</span><br><span class="line">  <span class="keyword">return</span> sqlSessionFactoryBean.getObject();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>以上介绍了配置Mybatis的两种方式，其实在大多数场景中使用第一种已经够用了，至于为什么介绍第二种呢？当然是为了多数据源的整合而做准备了。</p>
</blockquote>
<p>在<code>MybatisAutoConfiguration</code>中有一行很重要的代码，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ConditionalOnSingleCandidate(DataSource.class)</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>@ConditionalOnSingleCandidate</code>这个注解的意思是当IOC容器中只有一个候选Bean的实例才会生效。言外之意就是当IOC容器中只有一个数据源DataSource，这个自动配置类才会生效</p>
</blockquote>
<p><em><strong>哦？照这样搞，多数据源是不是不能用Mybatis？</strong></em></p>
<p>可能大家会有一个误解，认为多数据源就是多个的<code>DataSource</code>并存的，当然这样说也不是不正确。</p>
<blockquote>
<p>多数据源的情况下并不是多个数据源并存的，Spring提供了<code>AbstractRoutingDataSource</code>这样一个抽象类，使得能够在多数据源的情况下任意切换，相当于一个<code>动态路由</code>的作用，作者称之为<code>动态数据源</code>。因此Mybatis只需要配置这个动态数据源即可。</p>
</blockquote>
<h2 id="什么是动态数据源"><a href="#什么是动态数据源" class="headerlink" title="什么是动态数据源"></a>什么是动态数据源</h2><p>动态数据源简单的说就是能够自动切换的数据源，类似于一个动态路由的感觉，Spring提供了一个抽象类<code>AbstractRoutingDataSource</code>，这个抽象类中有一个属性，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Map&lt;Object, Object&gt; targetDataSources;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>targetDataSources是一个<code>Map</code>结构，所有需要切换的数据源都存放在其中，根据指定的KEY进行切换。当然还有一个默认的数据源。</p>
</blockquote>
<p><code>AbstractRoutingDataSource</code>这个抽象类中有一个抽象方法需要子类实现，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">abstract</span> Object <span class="title function_">determineCurrentLookupKey</span><span class="params">()</span>;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>determineCurrentLookupKey()</code>这个方法的返回值决定了需要切换的数据源的<code>KEY</code>，就是根据这个<code>KEY</code>从<code>targetDataSources</code>取值（数据源）</p>
</blockquote>
<h3 id="数据源切换如何保证线程隔离？"><a href="#数据源切换如何保证线程隔离？" class="headerlink" title="数据源切换如何保证线程隔离？"></a>数据源切换如何保证线程隔离？</h3><p>数据源属于一个公共的资源，在多线程的情况下如何保证线程隔离呢？不能我这边切换了影响其他线程的执行。</p>
<blockquote>
<p>“说到线程隔离，自然会想到<code>ThreadLocal</code>了，将切换数据源的<code>KEY</code>（用于从<code>targetDataSources</code>中取值）存储在<code>ThreadLocal</code>中，执行结束之后清除即可”</p>
</blockquote>
<p>单独封装了一个<code>DataSourceHolder</code>，内部使用<code>ThreadLocal</code>隔离线程，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 使用ThreadLocal存储切换数据源后的KEY</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DataSourceHolder</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//线程  本地环境</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;String&gt; dataSources = <span class="keyword">new</span> <span class="title class_">InheritableThreadLocal</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//设置数据源</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setDataSource</span><span class="params">(String datasource)</span> &#123;</span><br><span class="line">        dataSources.set(datasource);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取数据源</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getDataSource</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> dataSources.get();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//清除数据源</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">clearDataSource</span><span class="params">()</span> &#123;</span><br><span class="line">        dataSources.remove();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如何构造一个动态数据源？</p>
<p>上文说过只需继承一个抽象类<code>AbstractRoutingDataSource</code>，重写其中的一个方法<code>determineCurrentLookupKey()</code>即可。代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 动态数据源，继承AbstractRoutingDataSource</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DynamicDataSource</span> <span class="keyword">extends</span> <span class="title class_">AbstractRoutingDataSource</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 返回需要使用的数据源的key，将会按照这个KEY从Map获取对应的数据源（切换）</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Object <span class="title function_">determineCurrentLookupKey</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">//从ThreadLocal中取出KEY</span></span><br><span class="line">        <span class="keyword">return</span> DataSourceHolder.getDataSource();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 构造方法填充Map，构建多数据源</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">DynamicDataSource</span><span class="params">(DataSource defaultTargetDataSource, Map&lt;Object, Object&gt; targetDataSources)</span> &#123;</span><br><span class="line">        <span class="comment">// 默认的数据源，可以作为主数据源</span></span><br><span class="line">        <span class="built_in">super</span>.setDefaultTargetDataSource(defaultTargetDataSource);</span><br><span class="line">        <span class="comment">// 目标数据源</span></span><br><span class="line">        <span class="built_in">super</span>.setTargetDataSources(targetDataSources);</span><br><span class="line">        <span class="comment">// 执行afterPropertiesSet方法，完成属性的设置</span></span><br><span class="line">        <span class="built_in">super</span>.afterPropertiesSet();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上述代码很简单，分析如下：</p>
<ol>
<li>一个多参的构造方法，指定了默认的数据源和目标数据源。</li>
<li>重写<code>determineCurrentLookupKey()</code>方法，返回数据源对应的<code>KEY</code>，这里是直接从<code>ThreadLocal</code>中取值，就是上文封装的<code>DataSourceHolder</code></li>
</ol>
<h3 id="定义一个注解"><a href="#定义一个注解" class="headerlink" title="定义一个注解"></a>定义一个注解</h3><p>为了操作方便且低耦合，不能每次需要切换数据源的时候都要手动调一下接口吧，可以定义一个切换数据源的注解，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 切换数据源的注解</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Target(value = ElementType.METHOD)</span></span><br><span class="line"><span class="meta">@Retention(value = RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> SwitchSource &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 默认切换的数据源KEY</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">DEFAULT_NAME</span> <span class="operator">=</span> <span class="string">&quot;hisDataSource&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 需要切换到数据的KEY</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String <span class="title function_">value</span><span class="params">()</span> <span class="keyword">default</span> DEFAULT_NAME;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注解中只有一个<code>value</code>属性，指定了需要切换数据源的<code>KEY</code></p>
<p>有注解还不行，当然还要有切面，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="comment">// 优先级要设置在事务切面执行之前</span></span><br><span class="line"><span class="meta">@Order(1)</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DataSourceAspect</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Pointcut(&quot;@annotation(SwitchSource)&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">pointcut</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 在方法执行之前切换到指定的数据源</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> joinPoint</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Before(value = &quot;pointcut()&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">beforeOpt</span><span class="params">(JoinPoint joinPoint)</span> &#123;</span><br><span class="line">        <span class="comment">/*因为是对注解进行切面，所以这边无需做过多判定，直接获取注解的值，进行环绕，将数据源设置成远方，然后结束后，清楚当前线程数据源*/</span></span><br><span class="line">        <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> ((MethodSignature) joinPoint.getSignature()).getMethod();</span><br><span class="line">        <span class="type">SwitchSource</span> <span class="variable">switchSource</span> <span class="operator">=</span> method.getAnnotation(SwitchSource.class);</span><br><span class="line">        log.info(<span class="string">&quot;[Switch DataSource]:&quot;</span> + switchSource.value());</span><br><span class="line">        DataSourceHolder.setDataSource(switchSource.value());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 方法执行之后清除掉ThreadLocal中存储的KEY，这样动态数据源会使用默认的数据源</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@After(value = &quot;pointcut()&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterOpt</span><span class="params">()</span> &#123;</span><br><span class="line">        DataSourceHolder.clearDataSource();</span><br><span class="line">        log.info(<span class="string">&quot;[Switch Default DataSource]&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个<code>ASPECT</code>很容易理解，<code>beforeOpt()</code>在方法之前执行，取值<code>@SwitchSource</code>中value属性设置到<code>ThreadLocal</code>中；<code>afterOpt()</code>方法在方法执行之后执行，清除掉<code>ThreadLocal</code>中的<code>KEY</code>，保证了如果不切换数据源，则用默认的数据源。</p>
<h3 id="如何与Mybatis整合？"><a href="#如何与Mybatis整合？" class="headerlink" title="如何与Mybatis整合？"></a>如何与Mybatis整合？</h3><p>单一数据源与Mybatis整合上文已经详细讲解了，数据源<code>DataSource</code>作为参数构建了<code>SqlSessionFactory</code>，同样的思想，只需要把这个数据源换成动态数据源即可。注入的代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 创建动态数据源的SqlSessionFactory，传入的是动态数据源</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@Primary</span>这个注解很重要，如果项目中存在多个SqlSessionFactory，这个注解一定要加上</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@Primary</span></span><br><span class="line"><span class="meta">@Bean(&quot;sqlSessionFactory&quot;)</span></span><br><span class="line"><span class="keyword">public</span> SqlSessionFactory <span class="title function_">sqlSessionFactoryBean</span><span class="params">(DynamicDataSource dynamicDataSource)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">SqlSessionFactoryBean</span> <span class="variable">sqlSessionFactoryBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SqlSessionFactoryBean</span>();</span><br><span class="line">    sqlSessionFactoryBean.setDataSource(dynamicDataSource);</span><br><span class="line">    org.apache.ibatis.session.<span class="type">Configuration</span> <span class="variable">configuration</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">org</span>.apache.ibatis.session.Configuration();</span><br><span class="line">    <span class="comment">// 自动将数据库中的下划线转换为驼峰格式</span></span><br><span class="line">    configuration.setMapUnderscoreToCamelCase(<span class="literal">true</span>);</span><br><span class="line">    configuration.setDefaultFetchSize(<span class="number">100</span>);</span><br><span class="line">    configuration.setDefaultStatementTimeout(<span class="number">30</span>);</span><br><span class="line">    sqlSessionFactoryBean.setConfiguration(configuration);</span><br><span class="line">    <span class="keyword">return</span> sqlSessionFactoryBean.getObject();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>与Mybatis整合很简单，只需要把数据源替换成自定义的动态数据源<code>DynamicDataSource</code></p>
</blockquote>
<p>那么动态数据源如何注入到IOC容器中呢？看上文自定义的<code>DynamicDataSource</code>构造方法，肯定需要两个数据源了，因此必须先注入两个或者多个数据源到IOC容器中，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@Bean</span>：向IOC容器中注入一个Bean</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@ConfigurationProperties</span>：使得配置文件中以spring.datasource为前缀的属性映射到Bean的属性中</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;spring.datasource&quot;)</span></span><br><span class="line"><span class="meta">@Bean(&quot;dataSource&quot;)</span></span><br><span class="line"><span class="keyword">public</span> DataSource <span class="title function_">dataSource</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DruidDataSource</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 向IOC容器中注入另外一个数据源</span></span><br><span class="line"><span class="comment">    * 全局配置文件中前缀是spring.datasource.his</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@Bean(name = SwitchSource.DEFAULT_NAME)</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;spring.datasource.his&quot;)</span></span><br><span class="line"><span class="keyword">public</span> DataSource <span class="title function_">hisDataSource</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DruidDataSource</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>以上构建的两个数据源，一个是<code>默认的数据源</code>，一个是需要<code>切换到的数据源(targetDataSources)</code>，这样就组成了动态数据源了。数据源的一些信息，比如<code>url</code>，<code>username</code>需要自己在全局配置文件中根据指定的前缀配置即可，代码不再贴出</p>
</blockquote>
<p>动态数据源的注入代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 创建动态数据源的SqlSessionFactory，传入的是动态数据源</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@Primary</span>这个注解很重要，如果项目中存在多个SqlSessionFactory，这个注解一定要加上</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@Primary</span></span><br><span class="line"><span class="meta">@Bean(&quot;sqlSessionFactory&quot;)</span></span><br><span class="line"><span class="keyword">public</span> SqlSessionFactory <span class="title function_">sqlSessionFactoryBean</span><span class="params">(DynamicDataSource dynamicDataSource)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">SqlSessionFactoryBean</span> <span class="variable">sqlSessionFactoryBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SqlSessionFactoryBean</span>();</span><br><span class="line">    sqlSessionFactoryBean.setDataSource(dynamicDataSource);</span><br><span class="line">    org.apache.ibatis.session.<span class="type">Configuration</span> <span class="variable">configuration</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">org</span>.apache.ibatis.session.Configuration();</span><br><span class="line">    <span class="comment">// 自动将数据库中的下划线转换为驼峰格式</span></span><br><span class="line">    configuration.setMapUnderscoreToCamelCase(<span class="literal">true</span>);</span><br><span class="line">    configuration.setDefaultFetchSize(<span class="number">100</span>);</span><br><span class="line">    configuration.setDefaultStatementTimeout(<span class="number">30</span>);</span><br><span class="line">    sqlSessionFactoryBean.setConfiguration(configuration);</span><br><span class="line">    <span class="keyword">return</span> sqlSessionFactoryBean.getObject();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>这里还有一个问题：IOC中存在多个数据源了，那么事务管理器怎么办呢？它也懵逼了，到底选择哪个数据源呢？因此事务管理器肯定还是要重新配置的</p>
</blockquote>
<p>事务管理器此时管理的数据源将是动态数据源<code>DynamicDataSource</code>，配置如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 重写事务管理器，管理动态数据源</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@Primary</span></span><br><span class="line"><span class="meta">@Bean(value = &quot;transactionManager2&quot;)</span></span><br><span class="line"><span class="keyword">public</span> PlatformTransactionManager <span class="title function_">annotationDrivenTransactionManager</span><span class="params">(DynamicDataSource dataSource)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DataSourceTransactionManager</span>(dataSource);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>至此，Mybatis与多数据源的整合就完成了</p>
<h1 id="源码地址"><a href="#源码地址" class="headerlink" title="源码地址"></a>源码地址</h1><p><a target="_blank" rel="noopener" href="https://github.com/wangweiye01/dynamic_datasource">GitHub</a></p>
<p>参考<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/Cm8dp7NhoEWwY0C-Fhv98Q">@dd</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://wangweiye01.github.io/blog/2022/05/13/response-entity/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="老枪">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Coding & Life">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Coding & Life">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/2022/05/13/response-entity/" class="post-title-link" itemprop="url">ResponseEntity的使用技巧</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-05-13 09:42:41" itemprop="dateCreated datePublished" datetime="2022-05-13T09:42:41+08:00">2022-05-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-06-16 15:54:53" itemprop="dateModified" datetime="2025-06-16T15:54:53+08:00">2025-06-16</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="ResponseEntity"><a href="#ResponseEntity" class="headerlink" title="ResponseEntity"></a>ResponseEntity</h2><p><code>ResponseEntity</code>对象是<code>Spring</code>对请求响应的封装。它集成了<code>HttpEntity</code>对象，包含了http的响应码(httpstatus)、响应头(header)、响应体(body)三个部分。一个获取用户信息的Spring MVC接口通常我们直接返回实体即可(配合<code>@RestController</code>)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/user&quot;)</span></span><br><span class="line"><span class="keyword">public</span> User <span class="title function_">userinfo</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">    user.setUsername(<span class="string">&quot;felord.cn&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> user;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>等同于使用<code>ResponseEntity</code>作为控制器接口的返回值：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/user&quot;)</span></span><br><span class="line"><span class="keyword">public</span> ResponseEntity&lt;User&gt; <span class="title function_">userinfo</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">    user.setUsername(<span class="string">&quot;felord.cn&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> ResponseEntity.ok(user);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但是使用<code>ResponseEntity</code>时我们可以做更多事情</p>
<h3 id="自定义响应码"><a href="#自定义响应码" class="headerlink" title="自定义响应码"></a>自定义响应码</h3><p>上面的<code>ResponseEntity.ok</code>已经包含了返回<code>200</code>Http响应码，我们还可以通过<code>ResponseEntity.status(HttpStatus|int)</code>来自定义返回的响应码</p>
<h3 id="自定义响应体"><a href="#自定义响应体" class="headerlink" title="自定义响应体"></a>自定义响应体</h3><p>放置响应的响应体，通常就是我们接口的数据，这里是一个例子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ResponseEntity.status(HttpStatus.ok).body(Object)</span><br></pre></td></tr></table></figure>

<h3 id="响应头"><a href="#响应头" class="headerlink" title="响应头"></a>响应头</h3><p>通常我们制定Spring MVC接口的响应头是通过<code>@RequestMapping</code>和其Restful系列注解中的<code>header()</code>、<code>consumes</code>、<code>produces()</code>这几个属性设置。如果你使用了<code>ResponseEntity</code>，可以通过链式调用来设置：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ResponseEntity.status(HttpStatus.ok)</span><br><span class="line">              .allow(HttpMethod.GET)</span><br><span class="line">              .contentType(MediaType.APPLICATION_JSON)</span><br><span class="line">              .contentLength(<span class="number">1048576</span>)</span><br><span class="line">              .header(<span class="string">&quot;My-Header&quot;</span>,<span class="string">&quot;felord.cn&quot;</span>)</span><br><span class="line">              .build();</span><br></pre></td></tr></table></figure>

<p>所有的标准请求头都有对应的设置方法，你也可以通过<code>header(String headerName, String... headerValues)</code>设置自定义请求头</p>
<h3 id="大致原理"><a href="#大致原理" class="headerlink" title="大致原理"></a>大致原理</h3><p>我们来看一个用来处理Spring MVC控制器接口返回值的抽象接口<code>HandlerMethodReturnValueHandler</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">HandlerMethodReturnValueHandler</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 支持的返回值类型</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">supportsReturnType</span><span class="params">(MethodParameter returnType)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *  将数据绑定到视图，并设置处理标志以指示已直接处理响应，后续的其它方法就不处理了，优先级非常高</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">handleReturnValue</span><span class="params">(<span class="meta">@Nullable</span> Object returnValue, MethodParameter returnType, ModelAndViewContainer mavContainer, NativeWebRequest webRequest)</span> <span class="keyword">throws</span> Exception;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>它的一个重要实现<code>HttpEntityMethodProcessor</code>就是处理返回类型为<code>HttpEntity</code>的控制器方法的处理器。它会把<code>ResponseEntity</code>携带的三种信息交给<code>ServletServerHttpResponse</code>对象渲染视图，并设置处理标志以指示已直接处理响应，后续的其他方法不处理了，优先级非常高</p>
<h3 id="实战运用"><a href="#实战运用" class="headerlink" title="实战运用"></a>实战运用</h3><p>通常让你写个下载文件接口都是拿到<code>HttpServletResponse</code>对象，然后配置好<code>Content-Type</code>往里面写流。如果用<code>ResponseEntity</code>会更加简单优雅</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/download&quot;)</span></span><br><span class="line"><span class="keyword">public</span> ResponseEntity&lt;Resource&gt; <span class="title function_">load</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">ClassPathResource</span> <span class="variable">classPathResource</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathResource</span>(<span class="string">&quot;application.yml&quot;</span>);</span><br><span class="line">    <span class="type">String</span> <span class="variable">filename</span> <span class="operator">=</span> classPathResource.getFilename();</span><br><span class="line">    <span class="type">HttpHeaders</span> <span class="variable">httpHeaders</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpHeaders</span>();</span><br><span class="line">    httpHeaders.setContentDisposition(ContentDisposition.inline().filename(filename, StandardCharsets.UTF_8).build());</span><br><span class="line">    <span class="keyword">return</span> ResponseEntity.ok().headers(httpHeaders).body(classPathResource);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面是一个把Spring Boot配置文件<code>application.yml</code>下载下来的例子。主要分为三步：</p>
<ul>
<li><p>将要下载的文件封装成<code>org.springframework.core.io.Resource</code>对象，它有很多实现。这里用了<code>ClassPathResource</code>，其他<code>InputStreamResource</code>、<code>PathResource</code>都是常用的实现。</p>
</li>
<li><p>然后配置下载请求头<code>Content-Disposition</code>。针对下载它有两种模式：<code>inline</code>表示在浏览器直接展示文件内容；<code>attachment</code>表示下载为文件。另外下载后的文件名也在这里指定，请不要忘记文件扩展名，例如这里<code>application.yml</code>。如果不指定<code>Content-Disposition</code>，你需要根据文件扩展名设置对应的<code>Content-Type</code>，会麻烦一些。</p>
</li>
<li><p>最后是组装<code>ResponseEntity&lt;Resource&gt;</code>返回。</p>
</li>
</ul>
<p>转载自<a target="_blank" rel="noopener" href="https://www.felord.cn/responseEntity.html">@felord.cn</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://wangweiye01.github.io/blog/2022/04/16/date-format/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="老枪">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Coding & Life">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Coding & Life">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/2022/04/16/date-format/" class="post-title-link" itemprop="url">Java新API的时间格式化</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-04-16 11:12:16" itemprop="dateCreated datePublished" datetime="2022-04-16T11:12:16+08:00">2022-04-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-06-16 15:54:53" itemprop="dateModified" datetime="2025-06-16T15:54:53+08:00">2025-06-16</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>时间过得真是快，现在已经是2022年了。作为开发来说，时间处理是非常繁琐的。从Java 8开始有了新的时间API、时间的处理更加优雅，不再需要借助三方类库，而且线程安全。今天来梳理一下新API的格式化</p>
<h2 id="新API的时间格式化"><a href="#新API的时间格式化" class="headerlink" title="新API的时间格式化"></a>新API的时间格式化</h2><p>新的时间API的时间格式化由<code>java.time.format.DateTimeFormatter</code>负责</p>
<h3 id="本地化时间"><a href="#本地化时间" class="headerlink" title="本地化时间"></a>本地化时间</h3><p>结合枚举<code>FormatStyle</code>定义的风格，<code>DateTimeFormatter</code>预定义了基于本地（<code>Local</code>）风格的时间格式。我们来看这段代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">format</span> <span class="operator">=</span> DateTimeFormatter.ofLocalizedDateTime(FormatStyle.MEDIUM).format(ZonedDateTime.now());</span><br></pre></td></tr></table></figure>

<p>如果你在中国，格式化结果：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2022</span>年<span class="number">1</span>月<span class="number">6</span>日 下午<span class="number">4</span>:<span class="number">22</span>:<span class="number">01</span></span><br></pre></td></tr></table></figure>

<p>如果你在美国：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Jan <span class="number">6</span>, <span class="number">2022</span>, <span class="number">4</span>:<span class="number">21</span>:<span class="number">10</span> PM</span><br></pre></td></tr></table></figure>

<p>有三个静态方法及其重载来格式化本地化时间，具体已经整了成了思维导图：</p>
<p><img src="http://gttx-test.guan2018.com/20220106163219-20220416.png" alt="格式化时间图"></p>
<h3 id="ISO-RFC规范格式"><a href="#ISO-RFC规范格式" class="headerlink" title="ISO&#x2F;RFC规范格式"></a>ISO&#x2F;RFC规范格式</h3><p><code>DateTimeFormatter</code>还内置了<strong>ISO</strong>和<strong>RFC</strong>的时间格式，基于内置的<code>DateTimeFormatter</code>静态实现。举个例子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 静态实例</span></span><br><span class="line"><span class="type">DateTimeFormatter</span> <span class="variable">isoWeekDateFormatter</span> <span class="operator">=</span> DateTimeFormatter.ISO_WEEK_DATE;</span><br><span class="line"><span class="comment">// 执行格式化</span></span><br><span class="line"><span class="type">String</span> <span class="variable">format</span> <span class="operator">=</span> isoWeekDateFormatter.format(LocalDateTime.now());</span><br><span class="line"><span class="comment">// format = 2022-W01-4</span></span><br></pre></td></tr></table></figure>

<p>其他的如下表格所示：</p>
<p><img src="http://gttx-test.guan2018.com/20220106173226-2022041602.png"></p>
<h3 id="范式格式化"><a href="#范式格式化" class="headerlink" title="范式格式化"></a>范式格式化</h3><p>这种方式应该是我们最常用的方式了。通过字母和符号构建一个范式(Patterns)，使用<code>ofPattern(String)</code>或者<code>ofPattern(String, Locale)</code>方式传递构建的范式。例如,<code>d MMM uuuu</code>将把<code>2011-12-03</code>格式化为<code>2011年12月3日</code>。从一个模式中创建的格式可以根据需要多次使用，它是不可改变的，并且是线程安全的。</p>
<p>相信什么<code>yyyy-MM-dd HH:mm:ss</code>你都玩腻了，下面给你看点没有见过的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 最后面是两个V 不是W 单个V会报错 </span></span><br><span class="line"><span class="type">String</span> <span class="variable">pattern</span> <span class="operator">=</span> <span class="string">&quot;G uuuu&#x27;年&#x27;MMMd&#x27;日&#x27; ZZZZZ VV&quot;</span>;</span><br><span class="line">String format= DateTimeFormatter.ofPattern(pattern).format(ZonedDateTime.now());</span><br><span class="line"><span class="comment">// format = 公元 2022年1月7日 +08:00 Asia/Shanghai</span></span><br></pre></td></tr></table></figure>

<p>表格给你整理好了，你试一试：</p>
<p><img src="http://gttx-test.guan2018.com/202201071254202022041603.png"></p>
<p>转载自<a target="_blank" rel="noopener" href="https://www.felord.cn/new-date-formatter.html">@felord.cn</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://wangweiye01.github.io/blog/2022/01/18/mysql-transaction-isolation/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="老枪">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Coding & Life">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Coding & Life">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/2022/01/18/mysql-transaction-isolation/" class="post-title-link" itemprop="url">mysql隔离性</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-01-18 13:47:33" itemprop="dateCreated datePublished" datetime="2022-01-18T13:47:33+08:00">2022-01-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-06-16 15:54:53" itemprop="dateModified" datetime="2025-06-16T15:54:53+08:00">2025-06-16</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>事务四个特性：原子性 一致性 隔离性 持久性，下面详细介绍事务的隔离性</p>
<h2 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h2><p>与原子性、持久性侧重于研究事务本身不同，隔离性研究的是不同事务之间的相互影响。隔离性是指，事务内部的操作与其他事务是隔离的，并发执行的各个事务之间不能互相干扰。严格的隔离性，对应了事务隔离级别中的 <strong>Serializable(可串行化)</strong> 但实际应用中出于性能方面的考虑很少会使用可串行化。</p>
<h2 id="锁机制"><a href="#锁机制" class="headerlink" title="锁机制"></a>锁机制</h2><p>首先来看两个事务的写操作之间的相互影响。隔离性要求同一时刻只能有一个事务对数据进行写操作，InnoDB通过锁机制来保证这一点。</p>
<p>锁机制的基本原理可以概括为：事务在修改数据之前，需要先获得相应的锁；获得锁之后，事务便可以修改数据；该事务操作期间，这部分数据是锁定的，其他事务如果需要修改数据，需要等待当前事务提交或回滚后释放锁。</p>
<h3 id="行锁与表锁"><a href="#行锁与表锁" class="headerlink" title="行锁与表锁"></a>行锁与表锁</h3><p>按照粒度，锁可以分为表锁、行锁以及其他位于两者之间的锁。表锁在操作数据时会锁定整张表，并发性能较差；行锁则只锁定需要操作的数据，并发性能好。但是由于加锁本身需要消耗资源（获得锁、检查锁、释放锁等都需要消耗资源），因此在锁定数据较多情况下使用表锁可以节省大量资源。MySQL中不同的存储引擎支持的锁是不一样的，例如MyIsam只支持表锁，而InnoDB同时支持表锁和行锁，且出于性能考虑，绝大多数情况下使用的都是行锁。</p>
<h3 id="如何查看锁信息"><a href="#如何查看锁信息" class="headerlink" title="如何查看锁信息"></a>如何查看锁信息</h3><p>有多种方法可以查看InnoDB中锁的情况，例如：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> information_schema.innodb_locks; #锁的概况</span><br><span class="line"><span class="keyword">show</span> engine innodb status; #InnoDB整体状态，其中包括锁的情况</span><br></pre></td></tr></table></figure>

<p>下面来看一个例子：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#在事务A中执行：</span><br><span class="line"><span class="keyword">start</span> transaction;</span><br><span class="line"><span class="keyword">update</span> account <span class="keyword">SET</span> balance <span class="operator">=</span> <span class="number">1000</span> <span class="keyword">where</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">#在事务B中执行：</span><br><span class="line"><span class="keyword">start</span> transaction;</span><br><span class="line"><span class="keyword">update</span> account <span class="keyword">SET</span> balance <span class="operator">=</span> <span class="number">2000</span> <span class="keyword">where</span> id <span class="operator">=</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<p>此时查看锁的情况：<br><img src="http://gttx-test.guan2018.com/20210118140916.png"></p>
<p>show engine innodb status查看锁相关的部分：<br><img src="http://gttx-test.guan2018.com/20210118141123.png"></p>
<p>通过上述命令可以查看事务24052和24053占用锁的情况；其中lock_type为RECORD，代表锁为行锁(记录锁)；lock_mode为X，代表排它锁(写锁)。</p>
<h3 id="脏读、不可重复读和幻读"><a href="#脏读、不可重复读和幻读" class="headerlink" title="脏读、不可重复读和幻读"></a>脏读、不可重复读和幻读</h3><p>首先来看并发情况下，读操作可能存在的三类问题：</p>
<ol>
<li>脏读：当前事务(A)中可以读到其他事务(B)未提交的数据，这种现象就是脏读。举例如下(以账户余额表为例)：</li>
</ol>
<p><img src="http://gttx-test.guan2018.com/1174710-20190128201003630-2050662608-%E8%84%8F%E8%AF%BB.png"></p>
<ol start="2">
<li>不可重复读：在事务A中先后两次读取同一数据，两次读取的结果不一样，这种现象成为不可重复读。脏读与不可重复读的区别在于：前者读到的是其他事务未提交的数据，后者读到的是其他事务已提交的数据。举例如下：</li>
</ol>
<p><img src="http://gttx-test.guan2018.com/1174710-20190128201011603-1317894910-%E4%B8%8D%E5%8F%AF%E9%87%8D%E5%A4%8D%E8%AF%BB.png"></p>
<ol start="3">
<li>幻读：在事务A中按照某个条件先后两次查询数据库，两次查询结果的条数不同，这种现象称为幻读。不可重复读与幻读的区别可以通俗的理解为：前者数据变了，后者是数据的行数变了。举例如下：</li>
</ol>
<p><img src="http://gttx-test.guan2018.com/1174710-20190128201021606-1089980279-%E5%B9%BB%E8%AF%BB.png"></p>
<h2 id="事务隔离级别"><a href="#事务隔离级别" class="headerlink" title="事务隔离级别"></a>事务隔离级别</h2><p>SQL标准中定义了四种隔离级别，并规定了每种隔离级别下上述几个问题是否存在。一般来说，隔离级别越低，系统开销越低，可支持的并发越高，但隔离性也越差。隔离级别与读问题的关系如下：</p>
<p><img src="http://gttx-test.guan2018.com/1174710-20190128201034603-681355962-%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB.png"></p>
<p>在实际应用中 <strong>读未提交</strong> 在并发时会导致很多问题，而性能相对于其他隔离级别提高缺很有限，因此使用较少 <strong>可串行化</strong> 强制事务串行，并发效率很低，只有当数据一致性要求极高且可以接受没有并发时使用，因此使用也较少。因此在大多数数据库系统中，默认的隔离级别是 <strong>读已提交(如Oracle)</strong> 或 <strong>可重复读(后文简称RR)</strong></p>
<p>可以通过如下两个命令分别查看全局隔离级别和本次会话的隔离级别：</p>
<p><img src="http://gttx-test.guan2018.com/1174710-20190128201103652-719570401%E5%85%A8%E5%B1%80%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB.png"></p>
<p><img src="http://gttx-test.guan2018.com/1174710-20190128201111615-210490190%E4%BC%9A%E8%AF%9D%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB.png"></p>
<p>InnoDB默认的隔离级别是RR，后文会重点介绍RR。需要注意的是，在SQL标准中，RR是无法避免幻读问题的，但是InnoDB实现的RR避免了幻读问题。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://wangweiye01.github.io/blog/2021/11/15/load/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="老枪">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Coding & Life">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Coding & Life">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/2021/11/15/load/" class="post-title-link" itemprop="url">java加载顺序</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-11-15 10:43:57" itemprop="dateCreated datePublished" datetime="2021-11-15T10:43:57+08:00">2021-11-15</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-06-16 15:54:53" itemprop="dateModified" datetime="2025-06-16T15:54:53+08:00">2025-06-16</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123; <span class="comment">// 1.第一步，准备加载类</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Main</span>(); <span class="comment">// 4.第四步，执行main方法，new一个类，但在new之前要处理匿名代码块</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="type">int</span> <span class="variable">num</span> <span class="operator">=</span> <span class="number">4</span>; <span class="comment">// 2.第二步，静态变量和静态代码块的加载顺序由编写先后决定</span></span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">        num += <span class="number">3</span>;</span><br><span class="line">        System.out.println(<span class="string">&quot;b&quot;</span>); <span class="comment">// 5.第五步，按照顺序加载匿名代码块，代码块中有打印</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="variable">a</span> <span class="operator">=</span> <span class="number">5</span>; <span class="comment">// 6.第六步，按照顺序加载变量</span></span><br><span class="line"></span><br><span class="line">    &#123; <span class="comment">// 成员变量第三个</span></span><br><span class="line">        System.out.println(<span class="string">&quot;c&quot;</span>); <span class="comment">// 7.第七步，按照顺序打印c</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Main() &#123; <span class="comment">// 类的构造函数，第四个加载</span></span><br><span class="line">        System.out.println(<span class="string">&quot;d&quot;</span>); <span class="comment">// 8.第八步，最后加载构造函数，完成对象的建立</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123; <span class="comment">// 3.第三步，静态块，然后执行静态代码块，因为有输出，故打印a</span></span><br><span class="line">        System.out.println(<span class="string">&quot;a&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> <span class="comment">// 静态方法，调用的时候才加载 注意看，e没有加载</span></span><br><span class="line">    &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;e&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>执行以上代码可以总结加载顺序：静态代码块（静态变量） -&gt; 匿名代码块（成员变量） -&gt; 构造方法 -&gt; 静态方法（不调用不加载</strong></p>
<ul>
<li>静态代码块只加载一次</li>
<li>静态方法只有调用才会加载</li>
<li>静态代码块和静态变量按照代码编写前后顺序执行</li>
<li>匿名代码块和成员变量按照代码编写前后顺序执行</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Print</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Print</span><span class="params">(String s)</span> &#123;</span><br><span class="line">        System.out.println(s + <span class="string">&quot; &quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Parent</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">Print</span> <span class="variable">obj1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Print</span>(<span class="string">&quot;1&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">Print</span> <span class="variable">obj2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Print</span>(<span class="string">&quot;2&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">Print</span> <span class="variable">obj3</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Print</span>(<span class="string">&quot;3&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Print</span>(<span class="string">&quot;4&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">Print</span> <span class="variable">obj4</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Print</span>(<span class="string">&quot;5&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">Print</span> <span class="variable">obj5</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Print</span>(<span class="string">&quot;6&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Parent</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Print</span>(<span class="string">&quot;7&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Child</span> <span class="keyword">extends</span> <span class="title class_">Parent</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Print</span>(<span class="string">&quot;a&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">Print</span> <span class="variable">obj1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Print</span>(<span class="string">&quot;b&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">Print</span> <span class="variable">obj2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Print</span>(<span class="string">&quot;c&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Child</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Print</span>(<span class="string">&quot;d&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">Print</span> <span class="variable">obj3</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Print</span>(<span class="string">&quot;e&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">Print</span> <span class="variable">obj4</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Print</span>(<span class="string">&quot;f&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Parent</span> <span class="variable">obj1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Child</span>();</span><br><span class="line"></span><br><span class="line">        <span class="type">Parent</span> <span class="variable">obj2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Child</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>执行main方法打印顺序：1 3 4 5 a b e 2 6 7 c f d 2 6 7 c f d</strong></p>
<ul>
<li>先执行父类的静态代码块和静态变量初始化，并且静态代码块和静态变量的执行顺序只跟代码中出现的顺序有关；</li>
<li>执行子类的静态代码块和静态变量初始化；</li>
<li>执行父类的实例变量初始化；</li>
<li>执行父类的构造函数；</li>
<li>执行子类的实例变量初始化；</li>
<li>执行子类的构造函数；</li>
</ul>
<p>如果类已经被加载，则静态代码块和静态变量就不用重复执行，再创建类对象时，只执行与实例相关变量初始化和构造方法</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://wangweiye01.github.io/blog/2021/07/14/security23/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="老枪">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Coding & Life">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Coding & Life">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/2021/07/14/security23/" class="post-title-link" itemprop="url">Spring Security23 - 图解认证管理器AuthenticationManager</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-07-14 09:42:28" itemprop="dateCreated datePublished" datetime="2021-07-14T09:42:28+08:00">2021-07-14</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-06-16 15:54:53" itemprop="dateModified" datetime="2025-06-16T15:54:53+08:00">2025-06-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Spring-Security/" itemprop="url" rel="index"><span itemprop="name">Spring Security</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="1-前言"><a href="#1-前言" class="headerlink" title="1. 前言"></a>1. 前言</h2><p>我们上一篇介绍了<code>UsernamePasswordAuthenticationFilter</code>的工作流程，留下了一个小小的伏笔，作为一个<strong>Servlet Filter</strong>应该存在一个<code>doFilter</code>实现方法，而它却没有，其实它的父类<code>AbstractAuthenticationProcessingFilter</code>提供了具体的实现。稍后我们会根据这个实现引出今天的主角<code>AuthenticationManager</code>，来继续介绍用户的认证过程。</p>
<h2 id="2-AbstractAuthenticationProcessingFilter"><a href="#2-AbstractAuthenticationProcessingFilter" class="headerlink" title="2. AbstractAuthenticationProcessingFilter"></a>2. AbstractAuthenticationProcessingFilter</h2><p><code>AbstractAuthenticationProcessingFilter</code>作为<code>UsernamePasswordAuthenticationFilter</code>的父类，实现了认证过滤器的处理逻辑。我们来看看它的核心方法<code>doFilter</code>的实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest req, ServletResponse res, FilterChain chain)</span></span><br><span class="line">      <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line"></span><br><span class="line">   <span class="type">HttpServletRequest</span> <span class="variable">request</span> <span class="operator">=</span> (HttpServletRequest) req;</span><br><span class="line">   <span class="type">HttpServletResponse</span> <span class="variable">response</span> <span class="operator">=</span> (HttpServletResponse) res;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 先通过请求的uri来判断是否需要认证,比如默认的/login </span></span><br><span class="line">   <span class="keyword">if</span> (!requiresAuthentication(request, response)) &#123;</span><br><span class="line">      chain.doFilter(request, response);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">      logger.debug(<span class="string">&quot;Request is to process authentication&quot;</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   Authentication authResult;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">       <span class="comment">// 接着就是执行子类钩子方法attemptAuthentication来获取认证结果对象Authentication ，这个对象不能是空 否则直接返回</span></span><br><span class="line">      authResult = attemptAuthentication(request, response);</span><br><span class="line">      <span class="keyword">if</span> (authResult == <span class="literal">null</span>) &#123;</span><br><span class="line">         <span class="comment">// return immediately as subclass has indicated that it hasn&#x27;t completed</span></span><br><span class="line">         <span class="comment">// authentication</span></span><br><span class="line">         <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">       <span class="comment">// 处理session 策略，这里默认没有任何策略</span></span><br><span class="line">      sessionStrategy.onAuthentication(authResult, request, response);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">catch</span> (InternalAuthenticationServiceException failed) &#123;</span><br><span class="line">      logger.error(</span><br><span class="line">            <span class="string">&quot;An internal error occurred while trying to authenticate the user.&quot;</span>,</span><br><span class="line">            failed);</span><br><span class="line">       <span class="comment">// 如果遇到异常 就会交给认证失败处理器 AuthenticationFailureHandler 来处理</span></span><br><span class="line">      unsuccessfulAuthentication(request, response, failed);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">catch</span> (AuthenticationException failed) &#123;</span><br><span class="line">      <span class="comment">// Authentication failed</span></span><br><span class="line">      unsuccessfulAuthentication(request, response, failed);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">//  认证成功后继续其它过滤器链 并最终交给认证成功处理器 AuthenticationSuccessHandler 处理</span></span><br><span class="line">   <span class="keyword">if</span> (continueChainBeforeSuccessfulAuthentication) &#123;</span><br><span class="line">      chain.doFilter(request, response);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   successfulAuthentication(request, response, chain, authResult);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>大部分逻辑这里是清晰的，关键在于<code>attemptAuthentication</code>方法，这个我们已经在上一文分析了是通过<code>AuthenticationManager</code>的<code>authenticate</code>方法进行认证逻辑的处理，接下来我们将重点分析这个接口来帮助我们了解<strong>Spring Seucirty</strong>的认证过程。</p>
<h2 id="3-AuthenticationManager"><a href="#3-AuthenticationManager" class="headerlink" title="3. AuthenticationManager"></a>3. AuthenticationManager</h2><p><code>AuthenticationManager</code>这个接口方法非常奇特，入参和返回值的类型都是<code>Authentication</code>。该接口的作用是对用户的未授信凭据进行认证，认证通过则返回授信状态的凭据，否则将抛出认证异常<code>AuthenticationException</code>。</p>
<h3 id="3-1-AuthenticationManager的初始化流程"><a href="#3-1-AuthenticationManager的初始化流程" class="headerlink" title="3.1 AuthenticationManager的初始化流程"></a>3.1 AuthenticationManager的初始化流程</h3><p>那么<code>AbstractAuthenticationProcessingFilter</code>中的 <code>AuthenticationManager</code>是在哪里配置的呢？看过之前文章的应该知道<code>WebSecurityConfigurerAdapter</code>中的<code>void configure(AuthenticationManagerBuilder auth)</code>是配置<code>AuthenticationManager</code>的地方，我根据源码总结了一下<code>AuthenticationManager</code>的初始化流程，相信可以帮助你去阅读相关的源码：</p>
<p><img src="https://blog-1256050353.file.myqcloud.com/20200720151419-20210714.png"></p>
<p>需要注意的是如果我们使用自定义配置一定不能按照类似下面的错误示范：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">DaoAuthenticationProvider</span> <span class="variable">daoAuthenticationProvider</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DaoAuthenticationProvider</span>();</span><br><span class="line">    daoAuthenticationProvider.setUserDetailsService(weChatSecurityConfigProperties.getUserDetailsService());</span><br><span class="line">    daoAuthenticationProvider.setPasswordEncoder(multiPasswordEncoder());</span><br><span class="line">    auth.authenticationProvider(daoAuthenticationProvider);</span><br><span class="line">    <span class="comment">// 调用 super 将导致不生效 所以下面语句不要写</span></span><br><span class="line">    <span class="built_in">super</span>.configure(auth);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-2-AuthenticationManager的认证过程"><a href="#3-2-AuthenticationManager的认证过程" class="headerlink" title="3.2 AuthenticationManager的认证过程"></a>3.2 AuthenticationManager的认证过程</h3><p><code>AuthenticationManager</code>的实现<code>ProviderManager</code>管理了众多的<code>AuthenticationProvider</code>。每一个<code>AuthenticationProvider</code>都只支持特定类型的<code>Authentication</code>，然后是对适配到的<code>Authentication</code>进行认证，只要有一个<code>AuthenticationProvider</code>认证成功，那么就认为认证成功，所有的都没有通过才认为是认证失败。认证成功后的<code>Authentication</code>就变成授信凭据，并触发认证成功的事件。认证失败的就抛出异常触发认证失败的事件。</p>
<p><img src="https://blog-1256050353.file.myqcloud.com/20200720235936-20210714.png"></p>
<p>从这里我们可以看出认证管理器<code>AuthenticationManager</code>针对特定的<code>Authentication</code>提供了特定的认证功能，我们可以借此来实现多种认证并存。</p>
<h2 id="4-总结"><a href="#4-总结" class="headerlink" title="4. 总结"></a>4. 总结</h2><p>通过本文我们对<strong>Spring Security</strong>认证管理器<code>AuthenticationManager</code>的初始化过程和认证过程进行了分析，如果你熟悉了<code>AuthenticationManager</code>的逻辑可以实现多种认证方式的并存等能力，实现很多有用的逻辑，这对集成<strong>Spring Security</strong>到项目中非常重要。</p>
<p>转载自<a target="_blank" rel="noopener" href="https://www.felord.cn/authenticationManager.html">@felord.cn</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://wangweiye01.github.io/blog/2021/07/14/security24/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="老枪">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Coding & Life">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Coding & Life">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/2021/07/14/security24/" class="post-title-link" itemprop="url">Spring Security24 - 从零手写一个验证码登录</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-07-14 09:42:18" itemprop="dateCreated datePublished" datetime="2021-07-14T09:42:18+08:00">2021-07-14</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-06-16 15:54:53" itemprop="dateModified" datetime="2025-06-16T15:54:53+08:00">2025-06-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Spring-Security/" itemprop="url" rel="index"><span itemprop="name">Spring Security</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="1-前言"><a href="#1-前言" class="headerlink" title="1. 前言"></a>1. 前言</h2><p>前面关于<strong>Spring Security</strong>写了两篇文章，一篇是介绍<code>UsernamePasswordAuthenticationFilter</code>，另一篇是介绍 <code>AuthenticationManager</code>。很多同学表示无法理解这两个东西有什么用，能解决哪些实际问题？所以今天就对这两篇理论进行实战运用，我们从零写一个短信验证码登录并适配到<strong>Spring Security</strong>体系中。如果你在阅读中有什么疑问可以回头看看这两篇文章，能解决很多疑惑。</p>
<blockquote>
<p>当然你可以修改成邮箱或者其它通讯设备的验证码登录。</p>
</blockquote>
<h2 id="2-验证码生命周期"><a href="#2-验证码生命周期" class="headerlink" title="2. 验证码生命周期"></a>2. 验证码生命周期</h2><blockquote>
<p>验证码存在有效期，一般5分钟。 一般逻辑是用户输入手机号后去获取验证码，服务端对验证码进行缓存。在最大有效期内用户只能使用验证码验证成功一次（避免验证码浪费）；超过最大时间后失效。</p>
</blockquote>
<p>验证码的缓存生命周期</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">CaptchaCacheStorage</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 验证码放入缓存.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> phone the phone</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String <span class="title function_">put</span><span class="params">(String phone)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 从缓存取验证码.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> phone the phone</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String <span class="title function_">get</span><span class="params">(String phone)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 验证码手动过期.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> phone the phone</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">expire</span><span class="params">(String phone)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们一般会借助于缓存中间件，比如<strong>Redis</strong>、<strong>Ehcache</strong>、<strong>Memcached</strong>等等来做这个事情。为了方便收看该教程的同学们所使用的不同的中间件。这里我结合<strong>Spring Cache</strong>特意抽象了验证码的缓存处理。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">SMS_CAPTCHA_CACHE</span> <span class="operator">=</span> <span class="string">&quot;captcha&quot;</span>;</span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line">CaptchaCacheStorage <span class="title function_">captchaCacheStorage</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CaptchaCacheStorage</span>() &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@CachePut(cacheNames = SMS_CAPTCHA_CACHE, key = &quot;#phone&quot;)</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">put</span><span class="params">(String phone)</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> RandomUtil.randomNumbers(<span class="number">5</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Cacheable(cacheNames = SMS_CAPTCHA_CACHE, key = &quot;#phone&quot;)</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">get</span><span class="params">(String phone)</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@CacheEvict(cacheNames = SMS_CAPTCHA_CACHE, key = &quot;#phone&quot;)</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">expire</span><span class="params">(String phone)</span> &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>务必保证缓存的可靠性，这与用户的体验息息相关。</p>
</blockquote>
<p>接着我们就来编写和业务无关的验证码服务了，验证码服务的核心功能有两个：<strong>发送验证码</strong>和<strong>验证码校验</strong>。其它的诸如统计、黑名单、历史记录可根据实际业务定制。这里只实现核心功能。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 验证码服务.</span></span><br><span class="line"><span class="comment"> * 两个功能： 发送和校验.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> captchaCacheStorage the captcha cache storage</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> the captcha service</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> CaptchaService <span class="title function_">captchaService</span><span class="params">(CaptchaCacheStorage captchaCacheStorage)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CaptchaService</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">sendCaptcha</span><span class="params">(String phone)</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">existed</span> <span class="operator">=</span> captchaCacheStorage.get(phone);</span><br><span class="line">            <span class="keyword">if</span> (StringUtils.hasText(existed)) &#123;</span><br><span class="line">                <span class="comment">// 节约成本的话如果缓存中有当前手机可用的验证码 不再发新的验证码</span></span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 生成验证码并放入缓存</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">captchaCode</span> <span class="operator">=</span> captchaCacheStorage.put(phone);</span><br><span class="line">            log.info(<span class="string">&quot;captcha: &#123;&#125;&quot;</span>, captchaCode);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//todo 这里自行完善调用第三方短信服务发送验证码</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">verifyCaptcha</span><span class="params">(String phone, String code)</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">cacheCode</span> <span class="operator">=</span> captchaCacheStorage.get(phone);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (Objects.equals(cacheCode, code)) &#123;</span><br><span class="line">                <span class="comment">// 验证通过手动过期</span></span><br><span class="line">                captchaCacheStorage.expire(phone);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接下来就可以根据<code>CaptchaService</code>编写短信发送接口<code>/captcha/&#123;phone&#125;</code>了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/captcha&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CaptchaController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    CaptchaService captchaService;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 模拟手机号发送验证码.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> phone the mobile</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the rest</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/&#123;phone&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Rest&lt;?&gt; captchaByMobile(<span class="meta">@PathVariable</span> String phone) &#123;</span><br><span class="line">        <span class="comment">//todo 手机号 正则自行验证</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (captchaService.sendCaptcha(phone))&#123;</span><br><span class="line">            <span class="keyword">return</span> RestBody.ok(<span class="string">&quot;验证码发送成功&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> RestBody.failure(-<span class="number">999</span>,<span class="string">&quot;验证码发送失败&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-集成到Spring-Security"><a href="#3-集成到Spring-Security" class="headerlink" title="3. 集成到Spring Security"></a>3. 集成到Spring Security</h2><p>下面的教程就必须用到前两篇介绍的知识了。我们要实现验证码登录就必须定义一个<strong>Servlet Filter</strong>进行处理。它的作用这里再重复一下：</p>
<ul>
<li>拦截短信登录接口。</li>
<li>获取登录参数并封装为<code>Authentication</code>凭据。</li>
<li>交给<code>AuthenticationManager</code>认证。</li>
</ul>
<p>我们需要先定制<code>Authentication</code>和<code>AuthenticationManager</code></p>
<h3 id="3-1-验证码凭据"><a href="#3-1-验证码凭据" class="headerlink" title="3.1 验证码凭据"></a>3.1 验证码凭据</h3><p><code>Authentication</code>在我看来就是一个载体，在未得到认证之前它用来携带登录的关键参数，比如用户名和密码、验证码；在认证成功后它携带用户的信息和角色集。所以模仿<code>UsernamePasswordAuthenticationToken</code>来实现一个<code>CaptchaAuthenticationToken</code>，去掉不必要的功能，抄就完事儿了:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.felord.spring.security.captcha;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.security.authentication.AbstractAuthenticationToken;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.GrantedAuthority;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.SpringSecurityCoreVersion;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Collection;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 验证码认证凭据.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> felord.cn</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CaptchaAuthenticationToken</span> <span class="keyword">extends</span> <span class="title class_">AbstractAuthenticationToken</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> SpringSecurityCoreVersion.SERIAL_VERSION_UID;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Object principal;</span><br><span class="line">    <span class="keyword">private</span> String captcha;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 此构造函数用来初始化未授信凭据.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> principal   the principal</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> captcha the captcha</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> CaptchaAuthenticationToken#CaptchaAuthenticationToken(Object, String, Collection)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CaptchaAuthenticationToken</span><span class="params">(Object principal, String captcha)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(<span class="literal">null</span>);</span><br><span class="line">        <span class="built_in">this</span>.principal =  principal;</span><br><span class="line">        <span class="built_in">this</span>.captcha = captcha;</span><br><span class="line">        setAuthenticated(<span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 此构造函数用来初始化授信凭据.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> principal       the principal</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> captcha     the captcha</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> authorities the authorities</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> CaptchaAuthenticationToken#CaptchaAuthenticationToken(Object, String)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CaptchaAuthenticationToken</span><span class="params">(Object principal, String captcha,</span></span><br><span class="line"><span class="params">                                      Collection&lt;? extends GrantedAuthority&gt; authorities)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(authorities);</span><br><span class="line">        <span class="built_in">this</span>.principal = principal;</span><br><span class="line">        <span class="built_in">this</span>.captcha = captcha;</span><br><span class="line">        <span class="built_in">super</span>.setAuthenticated(<span class="literal">true</span>); <span class="comment">// must use super, as we override</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">getCredentials</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.captcha;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">getPrincipal</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.principal;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAuthenticated</span><span class="params">(<span class="type">boolean</span> isAuthenticated)</span> <span class="keyword">throws</span> IllegalArgumentException &#123;</span><br><span class="line">        <span class="keyword">if</span> (isAuthenticated) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(</span><br><span class="line">                    <span class="string">&quot;Cannot set this token to trusted - use constructor which takes a GrantedAuthority list instead&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">super</span>.setAuthenticated(<span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">eraseCredentials</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.eraseCredentials();</span><br><span class="line">        captcha = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-2-验证码认证管理器"><a href="#3-2-验证码认证管理器" class="headerlink" title="3.2 验证码认证管理器"></a>3.2 验证码认证管理器</h3><p>我们还需要定制一个<code>AuthenticationManager</code>来对上面定义的凭据<code>CaptchaAuthenticationToken</code>进行认证处理。下面这张图有必要再拿出来看一下：</p>
<p><img src="https://blog-1256050353.file.myqcloud.com/20200720235936-20210714.png"></p>
<p>要定义<code>AuthenticationManager</code>只需要定义其实现<code>ProviderManager</code>。而<code>ProviderManager</code>又需要依赖<code>AuthenticationProvider</code>。所以我们要实现一个专门处理<code>CaptchaAuthenticationToken</code>的<code>AuthenticationProvider</code>。<code>AuthenticationProvider</code>的流程是：</p>
<ol>
<li>从<code>CaptchaAuthenticationToken</code>拿到手机号、验证码。</li>
<li>利用手机号从数据库查询用户信息，并判断用户是否是有效用户，实际上就是实现<code>UserDetailsService</code>接口</li>
<li>验证码校验。</li>
<li>校验成功则封装授信的凭据。</li>
<li>校验失败抛出认证异常。</li>
</ol>
<p>根据这个流程实现如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.felord.spring.security.captcha;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.InitializingBean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.MessageSource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.MessageSourceAware;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.support.MessageSourceAccessor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.authentication.AuthenticationProvider;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.authentication.BadCredentialsException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.Authentication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.AuthenticationException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.GrantedAuthority;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.SpringSecurityMessageSource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.authority.mapping.GrantedAuthoritiesMapper;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.authority.mapping.NullAuthoritiesMapper;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UserDetails;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UserDetailsService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.Assert;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Collection;</span><br><span class="line"><span class="keyword">import</span> java.util.Objects;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 验证码认证器.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> felord.cn</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CaptchaAuthenticationProvider</span> <span class="keyword">implements</span> <span class="title class_">AuthenticationProvider</span>, InitializingBean, MessageSourceAware &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">GrantedAuthoritiesMapper</span> <span class="variable">authoritiesMapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NullAuthoritiesMapper</span>();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> UserDetailsService userDetailsService;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> CaptchaService captchaService;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">MessageSourceAccessor</span> <span class="variable">messages</span> <span class="operator">=</span> SpringSecurityMessageSource.getAccessor();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Instantiates a new Captcha authentication provider.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userDetailsService the user details service</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> captchaService     the captcha service</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CaptchaAuthenticationProvider</span><span class="params">(UserDetailsService userDetailsService, CaptchaService captchaService)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.userDetailsService = userDetailsService;</span><br><span class="line">        <span class="built_in">this</span>.captchaService = captchaService;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Authentication <span class="title function_">authenticate</span><span class="params">(Authentication authentication)</span> <span class="keyword">throws</span> AuthenticationException &#123;</span><br><span class="line">        Assert.isInstanceOf(CaptchaAuthenticationToken.class, authentication,</span><br><span class="line">                () -&gt; messages.getMessage(</span><br><span class="line">                        <span class="string">&quot;CaptchaAuthenticationProvider.onlySupports&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;Only CaptchaAuthenticationToken is supported&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="type">CaptchaAuthenticationToken</span> <span class="variable">unAuthenticationToken</span> <span class="operator">=</span> (CaptchaAuthenticationToken) authentication;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">phone</span> <span class="operator">=</span> unAuthenticationToken.getName();</span><br><span class="line">        <span class="type">String</span> <span class="variable">rawCode</span> <span class="operator">=</span> (String) unAuthenticationToken.getCredentials();</span><br><span class="line"></span><br><span class="line">        <span class="type">UserDetails</span> <span class="variable">userDetails</span> <span class="operator">=</span> userDetailsService.loadUserByUsername(phone);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 此处省略对UserDetails 的可用性 是否过期  是否锁定 是否失效的检验  建议根据实际情况添加  或者在 UserDetailsService 的实现中处理</span></span><br><span class="line">        <span class="keyword">if</span> (Objects.isNull(userDetails)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BadCredentialsException</span>(<span class="string">&quot;Bad credentials&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 验证码校验</span></span><br><span class="line">        <span class="keyword">if</span> (captchaService.verifyCaptcha(phone, rawCode)) &#123;</span><br><span class="line">            <span class="keyword">return</span> createSuccessAuthentication(authentication, userDetails);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BadCredentialsException</span>(<span class="string">&quot;captcha is not matched&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">supports</span><span class="params">(Class&lt;?&gt; authentication)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> CaptchaAuthenticationToken.class.isAssignableFrom(authentication);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterPropertiesSet</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Assert.notNull(userDetailsService, <span class="string">&quot;userDetailsService must not be null&quot;</span>);</span><br><span class="line">        Assert.notNull(captchaService, <span class="string">&quot;captchaService must not be null&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setMessageSource</span><span class="params">(MessageSource messageSource)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.messages = <span class="keyword">new</span> <span class="title class_">MessageSourceAccessor</span>(messageSource);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 认证成功将非授信凭据转为授信凭据.</span></span><br><span class="line"><span class="comment">     * 封装用户信息 角色信息。</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> authentication the authentication</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> user           the user</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the authentication</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> Authentication <span class="title function_">createSuccessAuthentication</span><span class="params">(Authentication authentication, UserDetails user)</span> &#123;</span><br><span class="line"></span><br><span class="line">        Collection&lt;? <span class="keyword">extends</span> <span class="title class_">GrantedAuthority</span>&gt; authorities = authoritiesMapper.mapAuthorities(user.getAuthorities());</span><br><span class="line">        <span class="type">CaptchaAuthenticationToken</span> <span class="variable">authenticationToken</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CaptchaAuthenticationToken</span>(user, <span class="literal">null</span>, authorities);</span><br><span class="line">        authenticationToken.setDetails(authentication.getDetails());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> authenticationToken;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后就可以组装<code>ProviderManager</code>了：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ProviderManager</span> <span class="variable">providerManager</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ProviderManager</span>(Collections.singletonList(captchaAuthenticationProvider));</span><br></pre></td></tr></table></figure>

<p>经过<strong>3.1</strong>和<strong>3.2</strong>的准备，我们的准备工作就完成了。</p>
<h3 id="3-3-验证码认证过滤器"><a href="#3-3-验证码认证过滤器" class="headerlink" title="3.3 验证码认证过滤器"></a>3.3 验证码认证过滤器</h3><p>定制好验证码凭据和验证码认证管理器后我们就可以定义验证码认证过滤器了。修改一下<code>UsernamePasswordAuthenticationFilter</code>就能满足需求：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.felord.spring.security.captcha;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.lang.Nullable;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.authentication.AuthenticationServiceException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.Authentication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.AuthenticationException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.web.authentication.AbstractAuthenticationProcessingFilter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.web.util.matcher.AntPathRequestMatcher;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CaptchaAuthenticationFilter</span> <span class="keyword">extends</span> <span class="title class_">AbstractAuthenticationProcessingFilter</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">SPRING_SECURITY_FORM_PHONE_KEY</span> <span class="operator">=</span> <span class="string">&quot;phone&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">SPRING_SECURITY_FORM_CAPTCHA_KEY</span> <span class="operator">=</span> <span class="string">&quot;captcha&quot;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CaptchaAuthenticationFilter</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(<span class="keyword">new</span> <span class="title class_">AntPathRequestMatcher</span>(<span class="string">&quot;/clogin&quot;</span>, <span class="string">&quot;POST&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Authentication <span class="title function_">attemptAuthentication</span><span class="params">(HttpServletRequest request,</span></span><br><span class="line"><span class="params">                                                HttpServletResponse response)</span> <span class="keyword">throws</span> AuthenticationException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!request.getMethod().equals(<span class="string">&quot;POST&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AuthenticationServiceException</span>(</span><br><span class="line">                    <span class="string">&quot;Authentication method not supported: &quot;</span> + request.getMethod());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">phone</span> <span class="operator">=</span> obtainPhone(request);</span><br><span class="line">        <span class="type">String</span> <span class="variable">captcha</span> <span class="operator">=</span> obtainCaptcha(request);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (phone == <span class="literal">null</span>) &#123;</span><br><span class="line">            phone = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (captcha == <span class="literal">null</span>) &#123;</span><br><span class="line">            captcha = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        phone = phone.trim();</span><br><span class="line"></span><br><span class="line">        <span class="type">CaptchaAuthenticationToken</span> <span class="variable">authRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CaptchaAuthenticationToken</span>(</span><br><span class="line">                phone, captcha);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Allow subclasses to set the &quot;details&quot; property</span></span><br><span class="line">        setDetails(request, authRequest);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.getAuthenticationManager().authenticate(authRequest);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="keyword">protected</span> String <span class="title function_">obtainCaptcha</span><span class="params">(HttpServletRequest request)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> request.getParameter(SPRING_SECURITY_FORM_CAPTCHA_KEY);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="keyword">protected</span> String <span class="title function_">obtainPhone</span><span class="params">(HttpServletRequest request)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> request.getParameter(SPRING_SECURITY_FORM_PHONE_KEY);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">setDetails</span><span class="params">(HttpServletRequest request,</span></span><br><span class="line"><span class="params">                              CaptchaAuthenticationToken authRequest)</span> &#123;</span><br><span class="line">        authRequest.setDetails(authenticationDetailsSource.buildDetails(request));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里我们指定了拦截验证码登陆的请求为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">POST /clogin?phone=手机号&amp;captcha=验证码 HTTP/1.1</span><br><span class="line"></span><br><span class="line">Host: localhost:8082</span><br></pre></td></tr></table></figure>

<p>接下来就是配置了。</p>
<h3 id="3-4-配置"><a href="#3-4-配置" class="headerlink" title="3.4 配置"></a>3.4 配置</h3><p>我把所有的验证码认证的相关配置集中了起来，并加上了注释。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.felord.spring.security.captcha;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.util.RandomUtil;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Qualifier;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cache.annotation.CacheEvict;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cache.annotation.CachePut;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cache.annotation.Cacheable;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.authentication.ProviderManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.authority.AuthorityUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.User;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UserDetailsService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.web.authentication.AuthenticationFailureHandler;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.web.authentication.AuthenticationSuccessHandler;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.StringUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Collections;</span><br><span class="line"><span class="keyword">import</span> java.util.Objects;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 验证码认证配置.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> felord.cn</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 13 :23</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CaptchaAuthenticationConfiguration</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">SMS_CAPTCHA_CACHE</span> <span class="operator">=</span> <span class="string">&quot;captcha&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * spring cache 管理验证码的生命周期.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the captcha cache storage</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    CaptchaCacheStorage <span class="title function_">captchaCacheStorage</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CaptchaCacheStorage</span>() &#123;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@CachePut(cacheNames = SMS_CAPTCHA_CACHE, key = &quot;#phone&quot;)</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> String <span class="title function_">put</span><span class="params">(String phone)</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> RandomUtil.randomNumbers(<span class="number">5</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Cacheable(cacheNames = SMS_CAPTCHA_CACHE, key = &quot;#phone&quot;)</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> String <span class="title function_">get</span><span class="params">(String phone)</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@CacheEvict(cacheNames = SMS_CAPTCHA_CACHE, key = &quot;#phone&quot;)</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">expire</span><span class="params">(String phone)</span> &#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 验证码服务.</span></span><br><span class="line"><span class="comment">     * 两个功能： 发送和校验.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> captchaCacheStorage the captcha cache storage</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the captcha service</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> CaptchaService <span class="title function_">captchaService</span><span class="params">(CaptchaCacheStorage captchaCacheStorage)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CaptchaService</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">sendCaptcha</span><span class="params">(String phone)</span> &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">existed</span> <span class="operator">=</span> captchaCacheStorage.get(phone);</span><br><span class="line">                <span class="keyword">if</span> (StringUtils.hasText(existed)) &#123;</span><br><span class="line">                    <span class="comment">// 节约成本的话如果缓存存在可用的验证码 不再发新的验证码</span></span><br><span class="line">                    log.warn(<span class="string">&quot;captcha code 【 &#123;&#125; 】 is available now&quot;</span>, existed);</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 生成验证码并放入缓存</span></span><br><span class="line">                <span class="type">String</span> <span class="variable">captchaCode</span> <span class="operator">=</span> captchaCacheStorage.put(phone);</span><br><span class="line">                log.info(<span class="string">&quot;captcha: &#123;&#125;&quot;</span>, captchaCode);</span><br><span class="line"></span><br><span class="line">                <span class="comment">//todo 这里自行完善调用第三方短信服务</span></span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">verifyCaptcha</span><span class="params">(String phone, String code)</span> &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">cacheCode</span> <span class="operator">=</span> captchaCacheStorage.get(phone);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (Objects.equals(cacheCode, code)) &#123;</span><br><span class="line">                    <span class="comment">// 验证通过手动过期</span></span><br><span class="line">                    captchaCacheStorage.expire(phone);</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 自行实现根据手机号查询可用的用户，这里简单举例.</span></span><br><span class="line"><span class="comment">     * 注意该接口可能出现多态。所以最好加上注解<span class="doctag">@Qualifier</span></span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the user details service</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@Qualifier(&quot;captchaUserDetailsService&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> UserDetailsService <span class="title function_">captchaUserDetailsService</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 验证码登陆后密码无意义了但是需要填充一下</span></span><br><span class="line">        <span class="keyword">return</span> username -&gt; User.withUsername(username).password(<span class="string">&quot;TEMP&quot;</span>)</span><br><span class="line">                <span class="comment">//todo  这里权限 你需要自己注入</span></span><br><span class="line">                .authorities(AuthorityUtils.createAuthorityList(<span class="string">&quot;ROLE_ADMIN&quot;</span>, <span class="string">&quot;ROLE_APP&quot;</span>)).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 验证码认证器.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> captchaService     the captcha service</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userDetailsService the user details service</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the captcha authentication provider</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> CaptchaAuthenticationProvider <span class="title function_">captchaAuthenticationProvider</span><span class="params">(CaptchaService captchaService,</span></span><br><span class="line"><span class="params">                                                                       <span class="meta">@Qualifier(&quot;captchaUserDetailsService&quot;)</span></span></span><br><span class="line"><span class="params">                                                                               UserDetailsService userDetailsService)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CaptchaAuthenticationProvider</span>(userDetailsService, captchaService);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 验证码认证过滤器.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> authenticationSuccessHandler  the authentication success handler</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> authenticationFailureHandler  the authentication failure handler</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> captchaAuthenticationProvider the captcha authentication provider</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the captcha authentication filter</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> CaptchaAuthenticationFilter <span class="title function_">captchaAuthenticationFilter</span><span class="params">(AuthenticationSuccessHandler authenticationSuccessHandler,</span></span><br><span class="line"><span class="params">                                                                   AuthenticationFailureHandler authenticationFailureHandler,</span></span><br><span class="line"><span class="params">                                                                   CaptchaAuthenticationProvider captchaAuthenticationProvider)</span> &#123;</span><br><span class="line">        <span class="type">CaptchaAuthenticationFilter</span> <span class="variable">captchaAuthenticationFilter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CaptchaAuthenticationFilter</span>();</span><br><span class="line">        <span class="comment">// 配置 authenticationManager</span></span><br><span class="line">        <span class="type">ProviderManager</span> <span class="variable">providerManager</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ProviderManager</span>(Collections.singletonList(captchaAuthenticationProvider));</span><br><span class="line">        captchaAuthenticationFilter.setAuthenticationManager(providerManager);</span><br><span class="line">        <span class="comment">// 成功处理器</span></span><br><span class="line">        captchaAuthenticationFilter.setAuthenticationSuccessHandler(authenticationSuccessHandler);</span><br><span class="line">        <span class="comment">// 失败处理器</span></span><br><span class="line">        captchaAuthenticationFilter.setAuthenticationFailureHandler(authenticationFailureHandler);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> captchaAuthenticationFilter;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然而这并没有完，你需要将<code>CaptchaAuthenticationFilter</code>配置到整个<strong>Spring Security</strong>的过滤器链中，这种看了胖哥教程的同学应该非常熟悉了。</p>
<p><img src="https://blog-1256050353.file.myqcloud.com/20200722123108-20210714.png"></p>
<blockquote>
<p><strong>请特别注意：</strong>务必保证登录接口和验证码接口可以匿名访问，如果是动态权限可以给接口添加<code>ROLE_ANONYMOUS</code>角色。</p>
</blockquote>
<p>大功告成，测试如下：</p>
<p><img src="https://blog-1256050353.file.myqcloud.com/20200722124800-20210714.png"><br><img src="https://blog-1256050353.file.myqcloud.com/20200722124800-2021071402.png"></p>
<p>而且原先的登录方式不受影响。</p>
<h2 id="4-总结"><a href="#4-总结" class="headerlink" title="4. 总结"></a>4. 总结</h2><p>通过对UsernamePasswordAuthenticationFilter和 AuthenticationManager的系统学习，我们了解了Spring Security认证的整个流程，本文是对这两篇的一个实际运用。相信看到这一篇后你就不会对前几篇的图解懵逼了，这也是理论到实践的一次尝试。</p>
<p>代码在<code>day11</code>分支</p>
<p>转载自<a target="_blank" rel="noopener" href="https://www.felord.cn/captchaAuthenticationFilter.html">@felord.cn</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://wangweiye01.github.io/blog/2021/07/13/security22/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="老枪">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Coding & Life">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Coding & Life">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/2021/07/13/security22/" class="post-title-link" itemprop="url">Spring Security22 - 图解认证过滤器UsernamePasswordAuthenticationFilter</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-07-13 14:05:06" itemprop="dateCreated datePublished" datetime="2021-07-13T14:05:06+08:00">2021-07-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-06-16 15:54:53" itemprop="dateModified" datetime="2025-06-16T15:54:53+08:00">2025-06-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Spring-Security/" itemprop="url" rel="index"><span itemprop="name">Spring Security</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="1-前言"><a href="#1-前言" class="headerlink" title="1. 前言"></a>1. 前言</h2><p>欢迎阅读Spring Security 实战干货系列文章，在集成<strong>Spring Security</strong>安全框架的时候我们最先处理的可能就是根据我们项目的实际需要来定制注册登录了，尤其是<strong>Http</strong>登录认证。根据以前的相关文章介绍，<strong>Http</strong>登录认证由过滤器<code>UsernamePasswordAuthenticationFilter</code>进行处理。我们只有把这个过滤器搞清楚才能做一些定制化。今天我们就简单分析它的源码和工作流程。</p>
<h2 id="2-UsernamePasswordAuthenticationFilter-源码分析"><a href="#2-UsernamePasswordAuthenticationFilter-源码分析" class="headerlink" title="2. UsernamePasswordAuthenticationFilter 源码分析"></a>2. UsernamePasswordAuthenticationFilter 源码分析</h2><p><code>UsernamePasswordAuthenticationFilter</code>继承于<code>AbstractAuthenticationProcessingFilter</code>（另文分析）。它的作用是拦截登录请求并获取账号和密码，然后把账号密码封装到认证凭据<code>UsernamePasswordAuthenticationToken</code>中，然后把凭据交给特定配置的<code>AuthenticationManager</code>去作认证。源码分析如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UsernamePasswordAuthenticationFilter</span> <span class="keyword">extends</span></span><br><span class="line">      <span class="title class_">AbstractAuthenticationProcessingFilter</span> &#123;</span><br><span class="line">    <span class="comment">// 默认取账户名、密码的key</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">SPRING_SECURITY_FORM_USERNAME_KEY</span> <span class="operator">=</span> <span class="string">&quot;username&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">SPRING_SECURITY_FORM_PASSWORD_KEY</span> <span class="operator">=</span> <span class="string">&quot;password&quot;</span>;</span><br><span class="line">    <span class="comment">// 可以通过对应的set方法修改</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">usernameParameter</span> <span class="operator">=</span> SPRING_SECURITY_FORM_USERNAME_KEY;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">passwordParameter</span> <span class="operator">=</span> SPRING_SECURITY_FORM_PASSWORD_KEY;</span><br><span class="line">    <span class="comment">// 默认只支持 POST 请求</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">postOnly</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment">//  初始化一个用户密码 认证过滤器  默认的登录uri 是 /login 请求方式是POST</span></span><br><span class="line">   <span class="keyword">public</span> <span class="title function_">UsernamePasswordAuthenticationFilter</span><span class="params">()</span> &#123;</span><br><span class="line">      <span class="built_in">super</span>(<span class="keyword">new</span> <span class="title class_">AntPathRequestMatcher</span>(<span class="string">&quot;/login&quot;</span>, <span class="string">&quot;POST&quot;</span>));</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 实现其父类 AbstractAuthenticationProcessingFilter 提供的钩子方法 用去尝试认证</span></span><br><span class="line">   <span class="keyword">public</span> Authentication <span class="title function_">attemptAuthentication</span><span class="params">(HttpServletRequest request,</span></span><br><span class="line"><span class="params">         HttpServletResponse response)</span> <span class="keyword">throws</span> AuthenticationException &#123;</span><br><span class="line">       <span class="comment">// 判断请求方式是否是POST</span></span><br><span class="line">      <span class="keyword">if</span> (postOnly &amp;&amp; !request.getMethod().equals(<span class="string">&quot;POST&quot;</span>)) &#123;</span><br><span class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AuthenticationServiceException</span>(</span><br><span class="line">               <span class="string">&quot;Authentication method not supported: &quot;</span> + request.getMethod());</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment">// 先去 HttpServletRequest 对象中获取账号名、密码</span></span><br><span class="line">      <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> obtainUsername(request);</span><br><span class="line">      <span class="type">String</span> <span class="variable">password</span> <span class="operator">=</span> obtainPassword(request);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (username == <span class="literal">null</span>) &#123;</span><br><span class="line">         username = <span class="string">&quot;&quot;</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (password == <span class="literal">null</span>) &#123;</span><br><span class="line">         password = <span class="string">&quot;&quot;</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      username = username.trim();</span><br><span class="line"></span><br><span class="line">       <span class="comment">// 然后把账号名、密码封装到 一个认证Token对象中，这是就是一个通行证，但是这时的状态时不可信的，一旦通过认证就变为可信的</span></span><br><span class="line">      <span class="type">UsernamePasswordAuthenticationToken</span> <span class="variable">authRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UsernamePasswordAuthenticationToken</span>(</span><br><span class="line">            username, password);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 会将 HttpServletRequest 中的一些细节 request.getRemoteAddr()   request.getSession 存入的到Token中</span></span><br><span class="line">      setDetails(request, authRequest);</span><br><span class="line"></span><br><span class="line">       <span class="comment">// 然后 使用 父类中的 AuthenticationManager 对Token 进行认证 </span></span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">this</span>.getAuthenticationManager().authenticate(authRequest);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">// 获取密码 很重要 如果你想改变获取密码的方式要么在此处重写，要么通过自定义一个前置的过滤器保证能此处能get到</span></span><br><span class="line">   <span class="meta">@Nullable</span></span><br><span class="line">   <span class="keyword">protected</span> String <span class="title function_">obtainPassword</span><span class="params">(HttpServletRequest request)</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> request.getParameter(passwordParameter);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 获取账户很重要 如果你想改变获取密码的方式要么在此处重写，要么通过自定义一个前置的过滤器保证能此处能get到</span></span><br><span class="line">   <span class="meta">@Nullable</span></span><br><span class="line">   <span class="keyword">protected</span> String <span class="title function_">obtainUsername</span><span class="params">(HttpServletRequest request)</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> request.getParameter(usernameParameter);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 参见上面对应的说明为凭据设置一些请求细节</span></span><br><span class="line">   <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">setDetails</span><span class="params">(HttpServletRequest request,</span></span><br><span class="line"><span class="params">         UsernamePasswordAuthenticationToken authRequest)</span> &#123;</span><br><span class="line">      authRequest.setDetails(authenticationDetailsSource.buildDetails(request));</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 设置账户参数的key</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setUsernameParameter</span><span class="params">(String usernameParameter)</span> &#123;</span><br><span class="line">      Assert.hasText(usernameParameter, <span class="string">&quot;Username parameter must not be empty or null&quot;</span>);</span><br><span class="line">      <span class="built_in">this</span>.usernameParameter = usernameParameter;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 设置密码参数的key</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setPasswordParameter</span><span class="params">(String passwordParameter)</span> &#123;</span><br><span class="line">      Assert.hasText(passwordParameter, <span class="string">&quot;Password parameter must not be empty or null&quot;</span>);</span><br><span class="line">      <span class="built_in">this</span>.passwordParameter = passwordParameter;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 认证的请求方式是只支持POST请求</span></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setPostOnly</span><span class="params">(<span class="type">boolean</span> postOnly)</span> &#123;</span><br><span class="line">      <span class="built_in">this</span>.postOnly = postOnly;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">final</span> String <span class="title function_">getUsernameParameter</span><span class="params">()</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> usernameParameter;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">final</span> String <span class="title function_">getPasswordParameter</span><span class="params">()</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> passwordParameter;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>为了加强对流程的理解，我特意画了一张图来对这个流程进行清晰的说明：</p>
<p><img src="https://blog-1256050353.file.myqcloud.com/20200716005029-20210714.png"></p>
<h2 id="3-我们可以定制什么"><a href="#3-我们可以定制什么" class="headerlink" title="3. 我们可以定制什么"></a>3. 我们可以定制什么</h2><p>根据上面的流程，我们理解了<code>UsernamePasswordAuthenticationFilter</code>工作流程后可以做这些事情：</p>
<ul>
<li>定制我们的登录请求URI和请求方式。</li>
<li>登录请求参数的格式定制化，比如可以使用<strong>JSON</strong>格式提交甚至几种并存。</li>
<li>将用户名和密码封装入凭据<code>UsernamePasswordAuthenticationToken</code>，定制业务场景需要的特殊凭据。</li>
</ul>
<h2 id="4-我们会有什么疑问"><a href="#4-我们会有什么疑问" class="headerlink" title="4. 我们会有什么疑问"></a>4. 我们会有什么疑问</h2><p><code>AuthenticationManager</code>从哪儿来，它又是什么，它是如何对凭据进行认证的，认证成功的后续细节是什么，认证失败的后续细节是什么。不要走开，持续关注为你揭晓这个答案。</p>
<p>转载自<a target="_blank" rel="noopener" href="https://www.felord.cn/usernamePasswordAuthenticationFilter.html">@felord.cn</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="Previous page" aria-label="Previous page" href="/blog/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/blog/">1</a><span class="page-number current">2</span><a class="page-number" href="/blog/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/blog/page/10/">10</a><a class="extend next" rel="next" title="Next page" aria-label="Next page" href="/blog/page/3/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">老枪</span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>

</body>
</html>
