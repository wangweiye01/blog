<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/blog/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/blog/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/blog/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/blog/images/logo.svg" color="#222">

<link rel="stylesheet" href="/blog/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha256-dABdfBfUoC8vJUBOwGVdm8L9qlMWaHTIfXt+7GnZCIo=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"wangweiye01.github.io","root":"/blog/","images":"/blog/images","scheme":"Muse","darkmode":false,"version":"8.23.1","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"codeblock":{"theme":{"light":"default","dark":"stackoverflow-dark"},"prism":{"light":"prism","dark":"prism-dark"},"copy_button":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"language":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/blog/js/config.js" defer></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="Coding &amp; Life">
<meta property="og:url" content="https://wangweiye01.github.io/blog/page/4/index.html">
<meta property="og:site_name" content="Coding &amp; Life">
<meta property="og:locale">
<meta property="article:author" content="老枪">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://wangweiye01.github.io/blog/page/4/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-Hans","comments":"","permalink":"","path":"page/4/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Coding & Life</title>
  








  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
<script src="/blog/js/utils.js" defer></script><script src="/blog/js/motion.js" defer></script><script src="/blog/js/sidebar.js" defer></script><script src="/blog/js/next-boot.js" defer></script>

  






  





  <noscript>
    <link rel="stylesheet" href="/blog/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
    </div>
  </div>

  <div class="site-meta">

    <a href="/blog/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Coding & Life</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">求知若饥，虚心若愚</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>







</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">老枪</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/blog/archives/">
          <span class="site-state-item-count">90</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/blog/categories/">
        <span class="site-state-item-count">2</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">tags</span>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://wangweiye01.github.io/blog/2021/07/08/security10/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="老枪">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Coding & Life">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Coding & Life">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/2021/07/08/security10/" class="post-title-link" itemprop="url">Spring Security10 - 登录后返回 JWT Token</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-07-08 14:49:43" itemprop="dateCreated datePublished" datetime="2021-07-08T14:49:43+08:00">2021-07-08</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-06-16 15:54:53" itemprop="dateModified" datetime="2025-06-16T15:54:53+08:00">2025-06-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Spring-Security/" itemprop="url" rel="index"><span itemprop="name">Spring Security</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="1-前言"><a href="#1-前言" class="headerlink" title="1. 前言"></a>1. 前言</h2><p>我们实现了 <strong>JWT</strong> 工具。本篇我们将一起探讨如何将 <strong>JWT</strong> 与 <strong>Spring Security</strong> 结合起来，在认证成功后不再跳转到指定页面而是直接返回 <strong>JWT Token</strong> 。 本文的<strong>DEMO 可通过文末的方式获取</strong></p>
<h2 id="2-流程"><a href="#2-流程" class="headerlink" title="2. 流程"></a>2. 流程</h2><p><strong>JWT</strong> 适用于前后端分离。我们在登录成功后不在跳转到首页，将会直接返回 <strong>JWT Token</strong> 对（DEMO中为<code>JwtTokenPair</code>），登录失败后返回认证失败相关的信息。</p>
<h2 id="3-实现登录成功-失败返回逻辑"><a href="#3-实现登录成功-失败返回逻辑" class="headerlink" title="3. 实现登录成功&#x2F;失败返回逻辑"></a>3. 实现登录成功&#x2F;失败返回逻辑</h2><h3 id="3-1-AuthenticationSuccessHandler-返回-JWT-Token"><a href="#3-1-AuthenticationSuccessHandler-返回-JWT-Token" class="headerlink" title="3.1 AuthenticationSuccessHandler 返回 JWT Token"></a>3.1 AuthenticationSuccessHandler 返回 JWT Token</h3><p><code>AuthenticationSuccessHandler</code> 用于处理登录成功后的逻辑，我们编写实现并注入 <strong>Spring IoC</strong> 容器：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 处理登录成功后返回 JWT Token 对.</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> jwtTokenGenerator the jwt token generator</span></span><br><span class="line"><span class="comment">* <span class="doctag">@return</span> the authentication success handler</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> AuthenticationSuccessHandler <span class="title function_">authenticationSuccessHandler</span><span class="params">(JwtTokenGenerator jwtTokenGenerator)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (request, response, authentication) -&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> (response.isCommitted()) &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;Response has already been committed&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        Map&lt;String, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(<span class="number">5</span>);</span><br><span class="line">        map.put(<span class="string">&quot;time&quot;</span>, LocalDateTime.now().format(DateTimeFormatter.ofPattern(<span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>)));</span><br><span class="line">        map.put(<span class="string">&quot;flag&quot;</span>, <span class="string">&quot;success_login&quot;</span>);</span><br><span class="line">        <span class="type">User</span> <span class="variable">principal</span> <span class="operator">=</span> (User) authentication.getPrincipal();</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> principal.getUsername();</span><br><span class="line">        Collection&lt;GrantedAuthority&gt; authorities = principal.getAuthorities();</span><br><span class="line">        Set&lt;String&gt; roles = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">if</span> (CollectionUtil.isNotEmpty(authorities)) &#123;</span><br><span class="line">            <span class="keyword">for</span> (GrantedAuthority authority : authorities) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">roleName</span> <span class="operator">=</span> authority.getAuthority();</span><br><span class="line">                roles.add(roleName);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">JwtTokenPair</span> <span class="variable">jwtTokenPair</span> <span class="operator">=</span> jwtTokenGenerator.jwtTokenPair(username, roles, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        map.put(<span class="string">&quot;access_token&quot;</span>, jwtTokenPair.getAccessToken());</span><br><span class="line">        map.put(<span class="string">&quot;refresh_token&quot;</span>, jwtTokenPair.getRefreshToken());</span><br><span class="line"></span><br><span class="line">        ResponseUtil.responseJsonWriter(response, RestBody.okData(map, <span class="string">&quot;登录成功&quot;</span>));</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-2-AuthenticationFailureHandler-返回认证失败信息"><a href="#3-2-AuthenticationFailureHandler-返回认证失败信息" class="headerlink" title="3.2 AuthenticationFailureHandler 返回认证失败信息"></a>3.2 AuthenticationFailureHandler 返回认证失败信息</h3><p><code>AuthenticationFailureHandler</code> 处理认证失败后的逻辑，前端根据此返回进行跳转处理逻辑，我们也实现它并注入 <strong>Spring IoC</strong> 容器：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 失败登录处理器 处理登录失败后的逻辑 登录失败返回信息 以此为依据跳转</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> the authentication failure handler</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> AuthenticationFailureHandler <span class="title function_">authenticationFailureHandler</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (request, response, exception) -&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> (response.isCommitted()) &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;Response has already been committed&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        Map&lt;String, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        map.put(<span class="string">&quot;time&quot;</span>, LocalDateTime.now().format(DateTimeFormatter.ofPattern(<span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>)));</span><br><span class="line">        map.put(<span class="string">&quot;flag&quot;</span>, <span class="string">&quot;failure_login&quot;</span>);</span><br><span class="line">        ResponseUtil.responseJsonWriter(response, RestBody.build(HttpStatus.UNAUTHORIZED.value(), map, <span class="string">&quot;认证失败&quot;</span>,<span class="string">&quot;-9999&quot;</span>));</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="4-配置"><a href="#4-配置" class="headerlink" title="4. 配置"></a>4. 配置</h2><p>把上面写好的两个 Handler Bean 写入 登录配置，相关片断如下，详情参见文末 DEMO：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">httpSecurity.formLogin().loginProcessingUrl(LOGIN_PROCESSING_URL).successHandler(authenticationSuccessHandler).failureHandler(authenticationFailureHandler)</span><br></pre></td></tr></table></figure>

<h2 id="5-验证"><a href="#5-验证" class="headerlink" title="5. 验证"></a>5. 验证</h2><p>我们依然通过<a target="_blank" rel="noopener" href="https://www.wangweiye.cc/blog/2021/07/03/security6/">Spring Security6 - 玩转自定义登录</a> 一文中章节 <strong>6.4 测试</strong> 来运行。结果如下：</p>
<h3 id="5-1-登录成功结果"><a href="#5-1-登录成功结果" class="headerlink" title="5.1 登录成功结果"></a>5.1 登录成功结果</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;httpStatus&quot;</span><span class="punctuation">:</span> <span class="number">200</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;data&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;access_token&quot;</span><span class="punctuation">:</span> <span class="string">&quot;eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJhbGwiLCJhdWQiOiJGZWxvcmRjbiIsInJvbGVzIjoiW10iLCJpc3MiOiJmZWxvcmQuY24iLCJleHAiOiIyMDE5LTExLTI3IDExOjMxOjMyIiwiaWF0IjoiMjAxOS0xMC0yOCAxMTozMTozMiIsImp0aSI6IjdmYTBlOWFiYjk5OTRjZGRhNGM5NjI4YzExNGM3YTk4In0.PvVsc8w10_0C5UIifJS1S5dEia5PQoVc_6wMfLAZOf574kt-VopHBVEp2zkjC1CNN3ltchy5rx6samaBDQvqWgoeFLXbRgNOa9Qhdf0wMLf-pUqoKRHuhBZV9HsvXSyQCFjZWlIguv4FSPZhbEff6D_8QUXmdWjlF_XEG2BPMr4&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;refresh_token&quot;</span><span class="punctuation">:</span> <span class="string">&quot;eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJhbGwiLCJhdWQiOiJGZWxvcmRjbiIsInJvbGVzIjoiW10iLCJpc3MiOiJmZWxvcmQuY24iLCJleHAiOiIyMDIwLTAxLTI2IDExOjMxOjMyIiwiaWF0IjoiMjAxOS0xMC0yOCAxMTozMTozMiIsImp0aSI6IjdmYTBlOWFiYjk5OTRjZGRhNGM5NjI4YzExNGM3YTk4In0.Caj4AAothdUwZAFl8IjcAZmmXHgTt76z8trVG1sf_WHZucFVcHR8FWjShhITpArsQpmokP6GBTMsCvWDl08fUVZBpOWc1CdPUAIIEdArHCFzO64HXc_DLSyg9v0C-qYfxaTlf0npL5QxpBBr9sJcyzxZF3CnpfZpAxm8WZzXG6o&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;time&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2019-10-28 11:32:11&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;flag&quot;</span><span class="punctuation">:</span> <span class="string">&quot;success_login&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;msg&quot;</span><span class="punctuation">:</span> <span class="string">&quot;登录成功&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;identifier&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>我们取 <code>access_token</code> 使用官网<a target="_blank" rel="noopener" href="https://jwt.io/">jwt.io</a> 提供的解码功能进行解码如下：</p>
<p><img src="https://blog-1256050353.file.myqcloud.com/Ha36f18e5c6714caba127695db1a0e8153-20210708.png"></p>
<h3 id="5-2-登录失败结果"><a href="#5-2-登录失败结果" class="headerlink" title="5.2 登录失败结果"></a>5.2 登录失败结果</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;httpStatus&quot;</span><span class="punctuation">:</span> <span class="number">401</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;data&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;time&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2019-10-28 12:54:10&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;flag&quot;</span><span class="punctuation">:</span> <span class="string">&quot;failure_login&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;msg&quot;</span><span class="punctuation">:</span> <span class="string">&quot;认证失败&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;identifier&quot;</span><span class="punctuation">:</span> <span class="string">&quot;-9999&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="6-总结"><a href="#6-总结" class="headerlink" title="6. 总结"></a>6. 总结</h2><p>今天我们将 <strong>JWT</strong> 和 <strong>Spring Security</strong> 联系了起来，实现了 登录成功后返回 <strong>JWT Token</strong> 。 这仅仅是一个开始，在下一篇我们将介绍 客户端如何使用 <strong>JWT Token</strong> 、服务端如何验证 <strong>JWT Token</strong> ，敬请关注。</p>
<p>文章相关的 <strong>DEMO</strong> 在分支<code>day06</code></p>
<p>转载自<a target="_blank" rel="noopener" href="https://www.felord.cn/spring-security-login-jwt.html">@felord.cn</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://wangweiye01.github.io/blog/2021/07/08/security9/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="老枪">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Coding & Life">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Coding & Life">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/2021/07/08/security9/" class="post-title-link" itemprop="url">Spring Security9 - 手把手教你实现JWT Token</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-07-08 11:51:56" itemprop="dateCreated datePublished" datetime="2021-07-08T11:51:56+08:00">2021-07-08</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-06-16 15:54:53" itemprop="dateModified" datetime="2025-06-16T15:54:53+08:00">2025-06-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Spring-Security/" itemprop="url" rel="index"><span itemprop="name">Spring Security</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="1-前言"><a href="#1-前言" class="headerlink" title="1. 前言"></a>1. 前言</h2><p><strong>Json Web Token</strong> （<code>JWT</code>） 近几年是前后端分离常用的 <strong>Token</strong> 技术，是目前最流行的跨域身份验证解决方案。今天我们来手写一个通用的 <code>JWT</code> 服务。<strong>DEMO</strong> 获取方式在文末，实现在 jwt 相关包下</p>
<h2 id="2-spring-security-jwt"><a href="#2-spring-security-jwt" class="headerlink" title="2. spring-security-jwt"></a>2. spring-security-jwt</h2><p><code>spring-security_jwt</code>是<strong>Spring Security Crypto</strong>提供的<code>JWT</code>工具包</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.security<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-security-jwt<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring-security-jwt.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>核心类只有一个：<code>org.springframework.security.jwt.JwtHelper</code>。它提供了两个非常有用的静态方法。</p>
<h2 id="3-JWT编码"><a href="#3-JWT编码" class="headerlink" title="3. JWT编码"></a>3. JWT编码</h2><p><code>JwtHelper</code> 提供的第一个静态方法就是 <code>encode(CharSequence content, Signer signer)</code> 这个是用来生成jwt的方法 需要指定 <strong>payload</strong> 跟 <strong>signer</strong> 签名算法。<strong>payload</strong> 存放了一些可用的<strong>不敏感</strong>信息：</p>
<ul>
<li><code>iss</code> jwt签发者</li>
<li><code>sub</code> jwt所面向的用户</li>
<li><code>aud</code> 接收jwt的一方</li>
<li><code>iat</code> jwt的签发时间</li>
<li><code>exp</code> jwt的过期时间，这个过期时间必须要大于签发时间<code>iat</code></li>
<li><code>jti</code> jwt的唯一身份标识，主要用来作为一次性token，从而回避重放攻击</li>
</ul>
<p>除了以上提供的基本信息外，我们可以定义一些我们需要传递的信息，比如目标用户的权限集 等等。<strong>切记不要传递密码等敏感信息</strong> ，因为 <code>JWT</code> 的前两段都是用了 <code>BASE64</code> 编码，几乎算是明文了。</p>
<h3 id="3-1-构建JWT中的payload"><a href="#3-1-构建JWT中的payload" class="headerlink" title="3.1 构建JWT中的payload"></a>3.1 构建JWT中的payload</h3><p>我们先来构建payload:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 构建 jwt payload</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Felordcn</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 11:27 2019/10/25</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JwtPayloadBuilder</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, String&gt; payload = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 附加的属性</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, String&gt; additional;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * jwt签发者</span></span><br><span class="line"><span class="comment">     **/</span></span><br><span class="line">    <span class="keyword">private</span> String iss;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * jwt所面向的用户</span></span><br><span class="line"><span class="comment">     **/</span></span><br><span class="line">    <span class="keyword">private</span> String sub;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 接收jwt的一方</span></span><br><span class="line"><span class="comment">     **/</span></span><br><span class="line">    <span class="keyword">private</span> String aud;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * jwt的过期时间，这个过期时间必须要大于签发时间</span></span><br><span class="line"><span class="comment">     **/</span></span><br><span class="line">    <span class="keyword">private</span> LocalDateTime exp;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * jwt的签发时间</span></span><br><span class="line"><span class="comment">     **/</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">LocalDateTime</span> <span class="variable">iat</span> <span class="operator">=</span> LocalDateTime.now();</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 权限集</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Set&lt;String&gt; roles = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * jwt的唯一身份标识，主要用来作为一次性token,从而回避重放攻击</span></span><br><span class="line"><span class="comment">     **/</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">jti</span> <span class="operator">=</span> IdUtil.simpleUUID();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> JwtPayloadBuilder <span class="title function_">iss</span><span class="params">(String iss)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.iss = iss;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> JwtPayloadBuilder <span class="title function_">sub</span><span class="params">(String sub)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.sub = sub;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> JwtPayloadBuilder <span class="title function_">aud</span><span class="params">(String aud)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.aud = aud;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> JwtPayloadBuilder <span class="title function_">roles</span><span class="params">(Set&lt;String&gt; roles)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.roles = roles;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> JwtPayloadBuilder <span class="title function_">expDays</span><span class="params">(<span class="type">int</span> days)</span> &#123;</span><br><span class="line">        Assert.isTrue(days &gt; <span class="number">0</span>, <span class="string">&quot;jwt expireDate must after now&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.exp = <span class="built_in">this</span>.iat.plusDays(days);</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> JwtPayloadBuilder <span class="title function_">additional</span><span class="params">(Map&lt;String, String&gt; additional)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.additional = additional;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">builder</span><span class="params">()</span> &#123;</span><br><span class="line">        payload.put(<span class="string">&quot;iss&quot;</span>, <span class="built_in">this</span>.iss);</span><br><span class="line">        payload.put(<span class="string">&quot;sub&quot;</span>, <span class="built_in">this</span>.sub);</span><br><span class="line">        payload.put(<span class="string">&quot;aud&quot;</span>, <span class="built_in">this</span>.aud);</span><br><span class="line">        payload.put(<span class="string">&quot;exp&quot;</span>, <span class="built_in">this</span>.exp.format(DateTimeFormatter.ofPattern(<span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>)));</span><br><span class="line">        payload.put(<span class="string">&quot;iat&quot;</span>, <span class="built_in">this</span>.iat.format(DateTimeFormatter.ofPattern(<span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>)));</span><br><span class="line">        payload.put(<span class="string">&quot;jti&quot;</span>, <span class="built_in">this</span>.jti);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!CollectionUtils.isEmpty(additional)) &#123;</span><br><span class="line">            payload.putAll(additional);</span><br><span class="line">        &#125;</span><br><span class="line">        payload.put(<span class="string">&quot;roles&quot;</span>, JSONUtil.toJsonStr(<span class="built_in">this</span>.roles));</span><br><span class="line">        <span class="keyword">return</span> JSONUtil.toJsonStr(JSONUtil.parse(payload));</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过建造类 <code>JwtPayloadBuilder</code> 我们可以很方便来构建 <code>JWT</code> 所需要的 <strong>payload</strong> <code>json</code> 字符串传递给 <code>encode(CharSequence content, Signer signer)</code> 中的 <code>content</code> 。</p>
<h3 id="3-2-生成-RSA-密钥并进行签名"><a href="#3-2-生成-RSA-密钥并进行签名" class="headerlink" title="3.2 生成 RSA 密钥并进行签名"></a>3.2 生成 RSA 密钥并进行签名</h3><p>为了生成 <strong>JWT Token</strong> 我们还需要使用 <strong>RSA</strong> 算法来进行签名。 这里我们使用 <strong>JDK</strong> 提供的证书管理工具 <strong>Keytool</strong> 来生成 <strong>RSA</strong> 证书 ，格式为 <code>jks</code> 格式。</p>
<p>生成证书命令参考：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">keytool -genkey -alias felordcn -keypass felordcn -keyalg RSA -storetype PKCS12 -keysize 1024 -validity 365 -keystore d:/keystores/felordcn.jks -storepass 123456  -dname &quot;CN=(Felord), OU=(felordcn), O=(felordcn), L=(zz), ST=(hn), C=(cn)&quot;</span><br></pre></td></tr></table></figure>

<p>其中 <code>-alias felordcn -storepass 123456</code> 我们要作为配置使用要记下来。我们要使用下面定义的这个类来读取证书</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.felord.spring.security.jwt;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.core.io.ClassPathResource;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.security.KeyFactory;</span><br><span class="line"><span class="keyword">import</span> java.security.KeyPair;</span><br><span class="line"><span class="keyword">import</span> java.security.KeyStore;</span><br><span class="line"><span class="keyword">import</span> java.security.PublicKey;</span><br><span class="line"><span class="keyword">import</span> java.security.interfaces.RSAPrivateCrtKey;</span><br><span class="line"><span class="keyword">import</span> java.security.spec.RSAPublicKeySpec;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * KeyPairFactory</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Felordcn</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 13:41 2019/10/25</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">KeyPairFactory</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> KeyStore store;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取公私钥.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> keyPath  jks 文件在 resources 下的classpath</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> keyAlias  keytool 生成的 -alias 值  felordcn</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> keyPass  keytool 生成的  -storepass 值  123456</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the key pair 公私钥对</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">   KeyPair <span class="title function_">create</span><span class="params">(String keyPath, String keyAlias, String keyPass)</span> &#123;</span><br><span class="line">        <span class="type">ClassPathResource</span> <span class="variable">resource</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathResource</span>(keyPath);</span><br><span class="line">        <span class="type">char</span>[] pem = keyPass.toCharArray();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (lock) &#123;</span><br><span class="line">                <span class="keyword">if</span> (store == <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">synchronized</span> (lock) &#123;</span><br><span class="line">                        store = KeyStore.getInstance(<span class="string">&quot;jks&quot;</span>);</span><br><span class="line">                        store.load(resource.getInputStream(), pem);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">RSAPrivateCrtKey</span> <span class="variable">key</span> <span class="operator">=</span> (RSAPrivateCrtKey) store.getKey(keyAlias, pem);</span><br><span class="line">            <span class="type">RSAPublicKeySpec</span> <span class="variable">spec</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RSAPublicKeySpec</span>(key.getModulus(), key.getPublicExponent());</span><br><span class="line">            <span class="type">PublicKey</span> <span class="variable">publicKey</span> <span class="operator">=</span> KeyFactory.getInstance(<span class="string">&quot;RSA&quot;</span>).generatePublic(spec);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">KeyPair</span>(publicKey, key);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;Cannot load keys from store: &quot;</span> + resource, e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>获取了 <code>KeyPair</code> 就能获取公私钥 生成 <code>Jwt</code> 的两个要素就完成了。我们可以和之前定义的 <code>JwtPayloadBuilder</code> 一起封装出生成 <strong>Jwt Token</strong> 的方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> String <span class="title function_">jwtToken</span><span class="params">(String aud, <span class="type">int</span> exp, Set&lt;String&gt; roles, Map&lt;String, String&gt; additional)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> jwtPayloadBuilder</span><br><span class="line">            .iss(jwtProperties.getIss())</span><br><span class="line">            .sub(jwtProperties.getSub())</span><br><span class="line">            .aud(aud)</span><br><span class="line">            .additional(additional)</span><br><span class="line">            .roles(roles)</span><br><span class="line">            .expDays(exp)</span><br><span class="line">            .builder();</span><br><span class="line">    <span class="type">RSAPrivateKey</span> <span class="variable">privateKey</span> <span class="operator">=</span> (RSAPrivateKey) keyPair.getPrivate();</span><br><span class="line"></span><br><span class="line">    <span class="type">RsaSigner</span> <span class="variable">signer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RsaSigner</span>(privateKey);</span><br><span class="line">    <span class="keyword">return</span> JwtHelper.encode(payload, signer).getEncoded();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通常情况下 Jwt Token 都是成对出现的，一个为平常请求携带的 <code>accessToken</code>， 另一个只作为刷新 <code>accessToken</code> 之用的 <code>refreshToken</code> 。而且 <code>refreshToken</code> 的过期时间要相对长一些。当 <code>accessToken</code> 失效而<code>refreshToken</code> 有效时，我们可以通过 <code>refreshToken</code> 来获取新的 <strong>Jwt Token</strong>对 ；当两个都失效就用户就必须重新登录了。</p>
<p>生成 <strong>Jwt Token</strong>对 的方法如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> JwtTokenPair <span class="title function_">jwtTokenPair</span><span class="params">(String aud, Set&lt;String&gt; roles, Map&lt;String, String&gt; additional)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">accessToken</span> <span class="operator">=</span> jwtToken(aud, jwtProperties.getAccessExpDays(), roles, additional);</span><br><span class="line">    <span class="type">String</span> <span class="variable">refreshToken</span> <span class="operator">=</span> jwtToken(aud, jwtProperties.getRefreshExpDays(), roles, additional);</span><br><span class="line"></span><br><span class="line">    <span class="type">JwtTokenPair</span> <span class="variable">jwtTokenPair</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JwtTokenPair</span>();</span><br><span class="line">    jwtTokenPair.setAccessToken(accessToken);</span><br><span class="line">    jwtTokenPair.setRefreshToken(refreshToken);</span><br><span class="line">    <span class="comment">// 放入缓存</span></span><br><span class="line">    jwtTokenStorage.put(jwtTokenPair, aud);</span><br><span class="line">    <span class="keyword">return</span> jwtTokenPair;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通常 <strong>Jwt Token</strong>对 会在返回给前台的同时放入缓存中。过期策略你可以选择分开处理，也可以选择以<code>refreshToken</code>的过期时间为准。</p>
<h2 id="4-JWT解码以及验证"><a href="#4-JWT解码以及验证" class="headerlink" title="4. JWT解码以及验证"></a>4. JWT解码以及验证</h2><p><code>JwtHelper</code> 提供的第二个静态方法是<code>Jwt decodeAndVerify(String token, SignatureVerifier verifier)</code> 用来 验证和解码 <strong>Jwt Token</strong> 。我们获取到请求中的token后会解析出用户的一些信息。通过这些信息去缓存中对应的token ，然后比对并验证是否有效（包括是否过期）。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 解码 并校验签名 过期不予解析</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> jwtToken the jwt token</span></span><br><span class="line"><span class="comment">* <span class="doctag">@return</span> the jwt claims</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> JSONObject <span class="title function_">decodeAndVerify</span><span class="params">(String jwtToken)</span> &#123;</span><br><span class="line">    Assert.hasText(jwtToken, <span class="string">&quot;jwt token must not be bank&quot;</span>);</span><br><span class="line">    <span class="type">RSAPublicKey</span> <span class="variable">rsaPublicKey</span> <span class="operator">=</span> (RSAPublicKey) <span class="built_in">this</span>.keyPair.getPublic();</span><br><span class="line">    <span class="type">SignatureVerifier</span> <span class="variable">rsaVerifier</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RsaVerifier</span>(rsaPublicKey);</span><br><span class="line">    <span class="type">Jwt</span> <span class="variable">jwt</span> <span class="operator">=</span> JwtHelper.decodeAndVerify(jwtToken, rsaVerifier);</span><br><span class="line">    <span class="type">String</span> <span class="variable">claims</span> <span class="operator">=</span> jwt.getClaims();</span><br><span class="line">    <span class="type">JSONObject</span> <span class="variable">jsonObject</span> <span class="operator">=</span> JSONUtil.parseObj(claims);</span><br><span class="line">    <span class="type">String</span> <span class="variable">exp</span> <span class="operator">=</span> jsonObject.getStr(JWT_EXP_KEY);</span><br><span class="line"><span class="comment">// 是否过期</span></span><br><span class="line">    <span class="keyword">if</span> (isExpired(exp)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;jwt token is expired&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> jsonObject;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面我们将有效的 <strong>Jwt Token</strong> 中的 <code>payload</code> 解析为 <strong>JSON对象</strong> ，方便后续的操作。</p>
<h2 id="5-配置"><a href="#5-配置" class="headerlink" title="5. 配置"></a>5. 配置</h2><p>我们将 <strong>JWT</strong> 的可配置项抽出来放入 <code>JwtProperties</code> 如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Jwt 在 springboot application.yml 中的配置文件</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Felordcn</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 15 :06 2019/10/25</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix=JWT_PREFIX)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JwtProperties</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String JWT_PREFIX= <span class="string">&quot;jwt.config&quot;</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 是否可用</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> enabled;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * jks 路径</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String keyLocation;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * key alias</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String keyAlias;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * key store pass</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String keyPass;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * jwt签发者</span></span><br><span class="line"><span class="comment">     **/</span></span><br><span class="line">    <span class="keyword">private</span> String iss;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * jwt所面向的用户</span></span><br><span class="line"><span class="comment">     **/</span></span><br><span class="line">    <span class="keyword">private</span> String sub;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * access jwt token 有效天数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> accessExpDays;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * refresh jwt token 有效天数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> refreshExpDays;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后我们就可以配置<strong>JWT</strong>的<code>javaConfig</code>如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * JwtConfiguration</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Felordcn</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 16 :54 2019/10/25</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties(JwtProperties.class)</span></span><br><span class="line"><span class="meta">@ConditionalOnProperty(prefix = &quot;jwt.config&quot;,name = &quot;enabled&quot;)</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JwtConfiguration</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Jwt token storage .</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the jwt token storage</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> JwtTokenStorage <span class="title function_">jwtTokenStorage</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">JwtTokenCacheStorage</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Jwt token generator.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> jwtTokenStorage the jwt token storage</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> jwtProperties   the jwt properties</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the jwt token generator</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> JwtTokenGenerator <span class="title function_">jwtTokenGenerator</span><span class="params">(JwtTokenStorage jwtTokenStorage, JwtProperties jwtProperties)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">JwtTokenGenerator</span>(jwtTokenStorage, jwtProperties);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后你就可以通过 <code>JwtTokenGenerator</code> 编码&#x2F;解码验证 <strong>Jwt Token</strong> 对 ，通过 <code>JwtTokenStorage</code> 来处理 <strong>Jwt Token</strong> 缓存。缓存这里我用了<strong>Spring Cache Ehcache</strong> 来实现,你也可以切换到 <strong>Redis</strong> 。相关单元测试参见 DEMO</p>
<h2 id="6-总结"><a href="#6-总结" class="headerlink" title="6. 总结"></a>6. 总结</h2><p>今天我们利用 <code>spring-security-jwt</code> 手写了一套 <strong>JWT</strong> 逻辑。无论对你后续结合 <strong>Spring Security</strong> 还是 <strong>Shiro</strong> 都十分有借鉴意义。下一篇我们会讲解 <strong>JWT</strong> 结合<strong>Spring Security</strong>。</p>
<p>本节代码分支在<code>day05</code></p>
<p>转载自<a target="_blank" rel="noopener" href="https://www.felord.cn/spring-security-custom-jwt.html">@felord.cn</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://wangweiye01.github.io/blog/2021/07/06/security8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="老枪">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Coding & Life">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Coding & Life">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/2021/07/06/security8/" class="post-title-link" itemprop="url">Spring Security8 - 实现自定义退出登录</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-07-06 17:32:03" itemprop="dateCreated datePublished" datetime="2021-07-06T17:32:03+08:00">2021-07-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-06-16 15:54:53" itemprop="dateModified" datetime="2025-06-16T15:54:53+08:00">2025-06-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Spring-Security/" itemprop="url" rel="index"><span itemprop="name">Spring Security</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="1-前言"><a href="#1-前言" class="headerlink" title="1. 前言"></a>1. 前言</h2><p>上一篇对 <code>Spring Security</code> 所有内置的 <code>Filter</code> 进行了介绍。今天我们来实战如何安全退出应用程序。</p>
<h2 id="2-我们使用-Spring-Security-登录后都做了什么"><a href="#2-我们使用-Spring-Security-登录后都做了什么" class="headerlink" title="2. 我们使用 Spring Security 登录后都做了什么"></a>2. 我们使用 Spring Security 登录后都做了什么</h2><p>这个问题我们必须搞清楚！一般登录后，服务端会给用户发一个凭证。常见有以下的两种：</p>
<ul>
<li>基于 <code>Session</code> 客户端会存 <code>cookie</code> 来保存一个 <code>sessionId</code> ，服务端存一个 <code>Session</code> 。</li>
<li>基于 <code>token</code> 客户端存一个 <code>token</code> 串，服务端会在缓存中存一个用来校验此 <code>token</code> 的信息。</li>
</ul>
<h2 id="3-退出登录需要我们做什么"><a href="#3-退出登录需要我们做什么" class="headerlink" title="3. 退出登录需要我们做什么"></a>3. 退出登录需要我们做什么</h2><ol>
<li>当前的用户登录状态失效。这就需要我们清除服务端的用户状态。</li>
<li>退出登录接口并不是 <code>permitAll</code>， 只有携带对应用户的凭证才退出。</li>
<li>将退出结果返回给请求方。</li>
<li>退出登录后用户可以通过重新登录来认证该用户。</li>
</ol>
<h2 id="4-Spring-Security-中的退出登录"><a href="#4-Spring-Security-中的退出登录" class="headerlink" title="4. Spring Security 中的退出登录"></a>4. Spring Security 中的退出登录</h2><p>接下来我们来分析并实战 <strong>如何定制退出登录逻辑</strong>。首先我们要了解 LogoutFilter 。</p>
<h3 id="4-1-LogoutFilter"><a href="#4-1-LogoutFilter" class="headerlink" title="4.1 LogoutFilter"></a>4.1 LogoutFilter</h3><p>通过前文我们知道退出登录逻辑是由过滤器 <code>LogoutFilter</code> 来执行的。 它持有三个接口类型的属性：</p>
<ol>
<li><code>RequestMatcher logoutRequestMatcher</code> 这个用来拦截退出请求的 <code>URL</code></li>
<li><code>LogoutHandler handler</code> 用来处理退出的具体逻辑</li>
<li><code>LogoutSuccessHandler logoutSuccessHandler</code> 退出成功后执行的逻辑</li>
</ol>
<p>我们通过对以上三个接口的实现就能实现我们自定义的退出逻辑。</p>
<h3 id="4-2-LogoutConfigurer"><a href="#4-2-LogoutConfigurer" class="headerlink" title="4.2 LogoutConfigurer"></a>4.2 LogoutConfigurer</h3><p>我们一般不会直接操作 <code>LogoutFilter</code> ，而是通过 <code>LogoutConfigurer</code> 来配置 <code>LogoutFilter</code>。 你可以通过 <code>HttpSecurity.logout()</code> 方法来初始化一个 <code>LogoutConfigurer</code> 。 接下来我们来实战操作一下。</p>
<h4 id="4-2-1-实现自定义退出登录请求URL"><a href="#4-2-1-实现自定义退出登录请求URL" class="headerlink" title="4.2.1 实现自定义退出登录请求URL"></a>4.2.1 实现自定义退出登录请求URL</h4><p><code>LogoutConfigurer</code> 提供了 <code>logoutRequestMatcher(RequestMatcher logoutRequestMatcher)</code>、<code>logoutUrl(Sring logoutUrl)</code> 两种方式来定义退出登录请求的 <code>URL</code> 。它们作用是相同的，你选择其中一种方式即可。</p>
<h4 id="4-2-2-处理具体的逻辑"><a href="#4-2-2-处理具体的逻辑" class="headerlink" title="4.2.2 处理具体的逻辑"></a>4.2.2 处理具体的逻辑</h4><p>默认情况下 <strong>Spring Security</strong> 是基于 <code>Session</code> 的。<code>LogoutConfigurer</code> 提供了一些直接配置来满足你的需要。如下：</p>
<ul>
<li><code>clearAuthentication(boolean clearAuthentication)</code> 是否在退出时清除当前用户的认证信息</li>
<li><code>deleteCookies(String... cookieNamesToClear)</code> 删除指定的 <code>cookies</code></li>
<li><code>invalidateHttpSession(boolean invalidateHttpSession)</code> 是否移除 <code>HttpSession</code></li>
</ul>
<p>如果上面满足不了你的需要就需要你来定制 <code>LogoutHandler</code> 了。</p>
<h4 id="4-2-3-退出成功逻辑"><a href="#4-2-3-退出成功逻辑" class="headerlink" title="4.2.3 退出成功逻辑"></a>4.2.3 退出成功逻辑</h4><ul>
<li><code>logoutSuccessUrl(String logoutSuccessUrl)</code> 退出成功后会被重定向到此 <code>URL</code> ，<strong>你可以写一个Controller 来完成最终返回，但是需要支持 <code>GET</code> 请求和 匿名访问 。</strong> 通过 <code>setDefaultTargetUrl</code> 方法注入到 <code>LogoutSuccessHandler</code></li>
<li><code>defaultLogoutSuccessHandlerFor(LogoutSuccessHandler handler, RequestMatcher preferredMatcher)</code> 用来构造默认的 <code>LogoutSuccessHandler</code> 我们可以通过添加多个来实现从不同 <code>URL</code> 退出执行不同的逻辑。</li>
<li><code>LogoutSuccessHandler logoutSuccessHandler</code> 退出成功后执行的逻辑的抽象根本接口。</li>
</ul>
<h3 id="4-3-Spring-Security-退出登录实战"><a href="#4-3-Spring-Security-退出登录实战" class="headerlink" title="4.3 Spring Security 退出登录实战"></a>4.3 Spring Security 退出登录实战</h3><p>现在前后端分离比较多，退出后返回json。 而且只有用户在线才能退出登录。否则不能进行退出操作。我们采用实现 <code>LogoutHandler</code> 和 <code>LogoutSuccessHandler</code> 接口这种编程的方式来配置 。退出请求的 <code>url</code> 依然通过 <code>LogoutConfigurer.logoutUrl(String logoutUrl)</code>来定义。</p>
<h4 id="4-3-1-自定义-LogoutHandler"><a href="#4-3-1-自定义-LogoutHandler" class="headerlink" title="4.3.1 自定义 LogoutHandler"></a>4.3.1 自定义 LogoutHandler</h4><p>默认情况下清除认证信息 （<code>invalidateHttpSession</code>），和Session 失效（<code>invalidateHttpSession） 已经由内置的</code>SecurityContextLogoutHandler<code>来完成。我们自定义的</code>LogoutHandler<code> 会在</code>SecurityContextLogoutHandler&#96; 来执行。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomLogoutHandler</span> <span class="keyword">implements</span> <span class="title class_">LogoutHandler</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">logout</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Authentication authentication)</span> &#123;</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> (User) authentication.getPrincipal();</span><br><span class="line">        <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> user.getUsername();</span><br><span class="line">        log.info(<span class="string">&quot;username: &#123;&#125;  is offline now&quot;</span>, username);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以上是我们实现的 <code>LogoutHandler</code> 。 我们可以从 <code>logout</code> 方法的 <code>authentication</code> 变量中 获取当前用户信息。你可以通过这个来实现你具体想要的业务。比如记录用户下线退出时间、IP 等等。</p>
<h4 id="4-3-2-自定义-LogoutSuccessHandler"><a href="#4-3-2-自定义-LogoutSuccessHandler" class="headerlink" title="4.3.2 自定义 LogoutSuccessHandler"></a>4.3.2 自定义 LogoutSuccessHandler</h4><p>如果我们实现了自定义的 <code>LogoutSuccessHandler</code> 就不必要设置 <code>LogoutConfigurer#logoutSuccessUrl(String logoutSuccessUrl)</code> 了。该处理器处理后会响应给前端。你可以转发到其它控制器。重定向到登录页面，也可以自行实现其它 <code>MediaType</code> ,可以是 <code>json</code> 或者页面</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomLogoutSuccessHandler</span> <span class="keyword">implements</span> <span class="title class_">LogoutSuccessHandler</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onLogoutSuccess</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Authentication authentication)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> (User) authentication.getPrincipal();</span><br><span class="line">        <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> user.getUsername();</span><br><span class="line">        log.info(<span class="string">&quot;username: &#123;&#125;  is offline now&quot;</span>, username);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        responseJsonWriter(response, RestBody.ok(<span class="string">&quot;退出成功&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">responseJsonWriter</span><span class="params">(HttpServletResponse response, Rest rest)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        response.setStatus(HttpServletResponse.SC_OK);</span><br><span class="line">        response.setCharacterEncoding(<span class="string">&quot;utf-8&quot;</span>);</span><br><span class="line">        response.setContentType(MediaType.APPLICATION_JSON_VALUE);</span><br><span class="line">        <span class="type">ObjectMapper</span> <span class="variable">objectMapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();</span><br><span class="line">        <span class="type">String</span> <span class="variable">resBody</span> <span class="operator">=</span> objectMapper.writeValueAsString(rest);</span><br><span class="line">        <span class="type">PrintWriter</span> <span class="variable">printWriter</span> <span class="operator">=</span> response.getWriter();</span><br><span class="line">        printWriter.print(resBody);</span><br><span class="line">        printWriter.flush();</span><br><span class="line">        printWriter.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="4-3-3-自定义退出的-Spring-Security-配置"><a href="#4-3-3-自定义退出的-Spring-Security-配置" class="headerlink" title="4.3.3 自定义退出的 Spring Security 配置"></a>4.3.3 自定义退出的 Spring Security 配置</h4><p>为了方便调试我 注释掉了我们 <em>实现的自定义登录</em>，你可以通过 http:localhost:8080&#x2F;login 来登录，然后通过 http:localhost:8080&#x2F;logout 测试退出。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">     <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            http.csrf().disable()</span><br><span class="line">                    .cors()</span><br><span class="line">                    .and()</span><br><span class="line">                    .authorizeRequests().anyRequest().authenticated()</span><br><span class="line">                    .and()</span><br><span class="line"><span class="comment">//                    .addFilterBefore(preLoginFilter, UsernamePasswordAuthenticationFilter.class)</span></span><br><span class="line">                    <span class="comment">// 登录</span></span><br><span class="line">                    .formLogin().loginProcessingUrl(LOGIN_PROCESSING_URL).successForwardUrl(<span class="string">&quot;/login/success&quot;</span>).failureForwardUrl(<span class="string">&quot;/login/failure&quot;</span>)</span><br><span class="line">                    .and().logout().addLogoutHandler(<span class="keyword">new</span> <span class="title class_">CustomLogoutHandler</span>()).logoutSuccessHandler(<span class="keyword">new</span> <span class="title class_">CustomLogoutSuccessHandler</span>());</span><br><span class="line"></span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<h2 id="5-总结"><a href="#5-总结" class="headerlink" title="5. 总结"></a>5. 总结</h2><p>本篇 我们实现了 在 <strong>Spring Security</strong> 下的自定义退出逻辑。相对比较简单，你可以根据你的业务需要来实现你的退出逻辑。代码在<code>day04</code>分支</p>
<p>转载自<a target="_blank" rel="noopener" href="https://www.felord.cn/spring-security-logout.html">@felord.cn</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://wangweiye01.github.io/blog/2021/07/06/security7/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="老枪">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Coding & Life">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Coding & Life">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/2021/07/06/security7/" class="post-title-link" itemprop="url">Spring Security7 - 内置 Filter 全解析</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-07-06 11:42:21" itemprop="dateCreated datePublished" datetime="2021-07-06T11:42:21+08:00">2021-07-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-06-16 15:54:53" itemprop="dateModified" datetime="2025-06-16T15:54:53+08:00">2025-06-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Spring-Security/" itemprop="url" rel="index"><span itemprop="name">Spring Security</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="1-前言"><a href="#1-前言" class="headerlink" title="1. 前言"></a>1. 前言</h2><p>上一文我们使用 <strong>Spring Security</strong> 实现了各种登录聚合的场面。其中我们是通过在 <code>UsernamePasswordAuthenticationFilter</code> 之前一个自定义的过滤器实现的。我怎么知道自定义过滤器要加在 <code>UsernamePasswordAuthenticationFilter</code> 之前。我在这个系列开篇说了 <strong>Spring Security</strong> 权限控制的一个核心关键就是 <strong>过滤器链</strong> ，这些过滤器如下图进行过滤传递，甚至比这个更复杂！这只是一个最小单元。</p>
<p><img src="https://blog-1256050353.file.myqcloud.com/2021070601.png"></p>
<p><strong>Spring Security</strong> 内置了一些过滤器，他们各有各的本事。如果你掌握了这些过滤器，很多实际开发中的需求和问题都很容易解决。今天我们来见识一下这些内置的过滤器。</p>
<h2 id="2-内置过滤器初始化"><a href="#2-内置过滤器初始化" class="headerlink" title="2. 内置过滤器初始化"></a>2. 内置过滤器初始化</h2><p>在 <strong>Spring Security</strong> 初始化核心过滤器时 <code>HttpSecurity</code> 会通过将 <strong>Spring Security</strong> 内置的一些过滤器以 <code>FilterComparator</code> 提供的规则进行比较按照比较结果进行排序注册。</p>
<h3 id="2-1-排序规则"><a href="#2-1-排序规则" class="headerlink" title="2.1 排序规则"></a>2.1 排序规则</h3><p><code>FilterComparator</code> 维护了一个顺序的注册表 <code>filterToOrder</code> 。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">FilterComparator() &#123;</span><br><span class="line">    <span class="type">Step</span> <span class="variable">order</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Step</span>(INITIAL_ORDER, ORDER_STEP);</span><br><span class="line">    put(ChannelProcessingFilter.class, order.next());</span><br><span class="line">    put(ConcurrentSessionFilter.class, order.next());</span><br><span class="line">    put(WebAsyncManagerIntegrationFilter.class, order.next());</span><br><span class="line">    put(SecurityContextPersistenceFilter.class, order.next());</span><br><span class="line">    put(HeaderWriterFilter.class, order.next());</span><br><span class="line">    put(CorsFilter.class, order.next());</span><br><span class="line">    put(CsrfFilter.class, order.next());</span><br><span class="line">    put(LogoutFilter.class, order.next());</span><br><span class="line">    filterToOrder.put(</span><br><span class="line">        <span class="string">&quot;org.springframework.security.oauth2.client.web.OAuth2AuthorizationRequestRedirectFilter&quot;</span>,</span><br><span class="line">            order.next());</span><br><span class="line">    filterToOrder.put(</span><br><span class="line">            <span class="string">&quot;org.springframework.security.saml2.provider.service.servlet.filter.Saml2WebSsoAuthenticationRequestFilter&quot;</span>,</span><br><span class="line">            order.next());</span><br><span class="line">    put(X509AuthenticationFilter.class, order.next());</span><br><span class="line">    put(AbstractPreAuthenticatedProcessingFilter.class, order.next());</span><br><span class="line">    filterToOrder.put(<span class="string">&quot;org.springframework.security.cas.web.CasAuthenticationFilter&quot;</span>,</span><br><span class="line">            order.next());</span><br><span class="line">    filterToOrder.put(</span><br><span class="line">        <span class="string">&quot;org.springframework.security.oauth2.client.web.OAuth2LoginAuthenticationFilter&quot;</span>,</span><br><span class="line">            order.next());</span><br><span class="line">    filterToOrder.put(</span><br><span class="line">            <span class="string">&quot;org.springframework.security.saml2.provider.service.servlet.filter.Saml2WebSsoAuthenticationFilter&quot;</span>,</span><br><span class="line">            order.next());</span><br><span class="line">    put(UsernamePasswordAuthenticationFilter.class, order.next());</span><br><span class="line">    put(ConcurrentSessionFilter.class, order.next());</span><br><span class="line">    filterToOrder.put(</span><br><span class="line">            <span class="string">&quot;org.springframework.security.openid.OpenIDAuthenticationFilter&quot;</span>, order.next());</span><br><span class="line">    put(DefaultLoginPageGeneratingFilter.class, order.next());</span><br><span class="line">    put(DefaultLogoutPageGeneratingFilter.class, order.next());</span><br><span class="line">    put(ConcurrentSessionFilter.class, order.next());</span><br><span class="line">    put(DigestAuthenticationFilter.class, order.next());</span><br><span class="line">    filterToOrder.put(</span><br><span class="line">            <span class="string">&quot;org.springframework.security.oauth2.server.resource.web.BearerTokenAuthenticationFilter&quot;</span>, order.next());</span><br><span class="line">    put(BasicAuthenticationFilter.class, order.next());</span><br><span class="line">    put(RequestCacheAwareFilter.class, order.next());</span><br><span class="line">    put(SecurityContextHolderAwareRequestFilter.class, order.next());</span><br><span class="line">    put(JaasApiIntegrationFilter.class, order.next());</span><br><span class="line">    put(RememberMeAuthenticationFilter.class, order.next());</span><br><span class="line">    put(AnonymousAuthenticationFilter.class, order.next());</span><br><span class="line">    filterToOrder.put(</span><br><span class="line">        <span class="string">&quot;org.springframework.security.oauth2.client.web.OAuth2AuthorizationCodeGrantFilter&quot;</span>,</span><br><span class="line">            order.next());</span><br><span class="line">    put(SessionManagementFilter.class, order.next());</span><br><span class="line">    put(ExceptionTranslationFilter.class, order.next());</span><br><span class="line">    put(FilterSecurityInterceptor.class, order.next());</span><br><span class="line">    put(SwitchUserFilter.class, order.next());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这些就是所有内置的过滤器。他们是通过下面的方法获取自己的序号：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Integer <span class="title function_">getOrder</span><span class="params">(Class&lt;?&gt; clazz)</span> &#123;</span><br><span class="line">    <span class="keyword">while</span> (clazz != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">result</span> <span class="operator">=</span> filterToOrder.get(clazz.getName());</span><br><span class="line">        <span class="keyword">if</span> (result != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line">        clazz = clazz.getSuperclass();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>通过过滤器的类全限定名从注册表 <code>filterToOrder</code> 中获取自己的序号，如果没有直接获取到序号通过递归获取父类在注册表中的序号作为自己的序号，序号越小优先级越高。上面的过滤器并非全部会被初始化。有的需要额外引入一些功能包，有的看 <code>HttpSecurity</code> 的配置情况。</strong> 在上一篇文章中。我们禁用了 <code>CSRF</code> 功能，就意味着 <code>CsrfFilter</code> 不会被注册。</p>
<h2 id="3-内置过滤器讲解"><a href="#3-内置过滤器讲解" class="headerlink" title="3. 内置过滤器讲解"></a>3. 内置过滤器讲解</h2><p>接下来我们就对这些内置过滤器进行一个系统的认识。<strong>我们将按照默认顺序进行讲解。</strong></p>
<h3 id="3-1-ChannelProcessingFilter"><a href="#3-1-ChannelProcessingFilter" class="headerlink" title="3.1 ChannelProcessingFilter"></a>3.1 ChannelProcessingFilter</h3><p><code>ChannelProcessingFilter</code> 通常是用来过滤哪些请求必须用 <code>https</code> 协议， 哪些请求必须用 <code>http</code> 协议， 哪些请求随便用哪个协议都行。它主要有两个属性：</p>
<ul>
<li><p><code>ChannelDecisionManager</code> 用来判断请求是否符合既定的协议规则。它维护了一个 <code>ChannelProcessor</code> 列表 这些<code>ChannelProcessor</code> 是具体用来执行 <code>ANY_CHANNEL</code> 策略 （任何通道都可以）, <code>REQUIRES_SECURE_CHANNEL</code> 策略 （只能通过<code>https</code>通道）, <code>REQUIRES_INSECURE_CHANNEL</code> 策略 （只能通过 <code>http</code> 通道）。</p>
</li>
<li><p><code>FilterInvocationSecurityMetadataSource</code> 用来存储 <code>url</code> 与 对应的<code>ANY_CHANNEL</code>、<code>REQUIRES_SECURE_CHANNEL</code>、<code>REQUIRES_INSECURE_CHANNEL</code> 的映射关系。</p>
</li>
</ul>
<p><code>ChannelProcessingFilter</code>通过 <code>HttpScurity#requiresChannel()</code> 等相关方法引入其配置对象 <code>ChannelSecurityConfigurer</code> 来进行配置。</p>
<h3 id="3-2-ConcurrentSessionFilter"><a href="#3-2-ConcurrentSessionFilter" class="headerlink" title="3.2 ConcurrentSessionFilter"></a><a name="3.2">3.2 ConcurrentSessionFilter</a></h3><p><code>ConcurrentSessionFilter</code> 主要用来判断<code>session</code>是否过期以及更新最新的访问时间。其流程为：</p>
<ol>
<li><code>session</code> 检测，如果不存在直接放行去执行下一个过滤器。存在则进行下一步。</li>
<li>根据<code>sessionid</code>从<code>SessionRegistry</code>中获取<code>SessionInformation</code>，从<code>SessionInformation</code>中获取<code>session</code>是否过期；没有过期则更新<code>SessionInformation</code>中的访问日期；<br>如果过期，则执行<code>doLogout()</code>方法，这个方法会将<code>session</code>无效，并将 <code>SecurityContext</code> 中的<code>Authentication</code>中的权限置空，同时在<code>SecurityContenxtHoloder</code>中清除<code>SecurityContext</code>然后查看是否有跳转的 <code>expiredUrl</code>，如果有就跳转，没有就输出提示信息。</li>
</ol>
<p><code>ConcurrentSessionFilter</code> 通过<code>SessionManagementConfigurer</code> 来进行配置。</p>
<h3 id="3-3-WebAsyncManagerIntegrationFilter"><a href="#3-3-WebAsyncManagerIntegrationFilter" class="headerlink" title="3.3 WebAsyncManagerIntegrationFilter"></a>3.3 WebAsyncManagerIntegrationFilter</h3><p><code>WebAsyncManagerIntegrationFilter</code>用于集成SecurityContext到Spring异步执行机制中的WebAsyncManager。用来处理异步请求的安全上下文。具体逻辑为：</p>
<ol>
<li>从请求属性上获取所绑定的<code>WebAsyncManager</code>，如果尚未绑定，先做绑定。</li>
<li>从<code>asyncManager</code>中获取 <code>key</code> 为 <code>CALLABLE_INTERCEPTOR_KEY</code> 的安全上下文多线程处理器 <code>SecurityContextCallableProcessingInterceptor</code>, 如果获取到的为 <code>null</code>，<br>新建一个 <code>SecurityContextCallableProcessingInterceptor</code> 并绑定 <code>CALLABLE_INTERCEPTOR_KEY</code> 注册到 <code>asyncManager</code> 中。</li>
</ol>
<p>这里简单说一下 <code>SecurityContextCallableProcessingInterceptor</code> 。它实现了接口 <code>CallableProcessingInterceptor</code>，<br>当它被应用于一次异步执行时，<code>beforeConcurrentHandling()</code> 方法会在调用者线程执行，该方法会相应地从当前线程获取<code>SecurityContext</code>,然后被调用者线程中执行逻辑时，会使用这个 <code>SecurityContext</code>，从而实现安全上下文从调用者线程到被调用者线程的传输。</p>
<p><code>WebAsyncManagerIntegrationFilter</code> 通过 <code>WebSecurityConfigurerAdapter#getHttp()</code>方法添加到 <code>HttpSecurity</code> 中成为 <code>DefaultSecurityFilterChain</code> 的一个链节。</p>
<h3 id="3-4-SecurityContextPersistenceFilter"><a href="#3-4-SecurityContextPersistenceFilter" class="headerlink" title="3.4 SecurityContextPersistenceFilter"></a>3.4 SecurityContextPersistenceFilter</h3><p><code>SecurityContextPersistenceFilter</code> 主要控制 <code>SecurityContext</code> 的在一次请求中的生命周期 。 请求来临时，创建<code>SecurityContext</code> 安全上下文信息，请求结束时清空 <code>SecurityContextHolder</code>。</p>
<p><code>SecurityContextPersistenceFilter</code> 通过 <code>HttpScurity#securityContext()</code> 及相关方法引入其配置对象 <code>SecurityContextConfigurer</code> 来进行配置。</p>
<h3 id="3-5-HeaderWriterFilter"><a href="#3-5-HeaderWriterFilter" class="headerlink" title="3.5 HeaderWriterFilter"></a>3.5 HeaderWriterFilter</h3><p><code>HeaderWriterFilter</code> 用来给 <code>http</code> 响应添加一些 <code>Header</code>,比如 <code>X-Frame-Options</code>, <code>X-XSS-Protection</code> ，<code>X-Content-Type-Options</code>。</p>
<p>你可以通过 <code>HttpScurity#headers()</code> 来定制请求<code>Header</code> 。</p>
<h3 id="3-6-CorsFilter"><a href="#3-6-CorsFilter" class="headerlink" title="3.6 CorsFilter"></a>3.6 CorsFilter</h3><p>跨域相关的过滤器。这是<code>Spring MVC Java</code>配置和<code>XML</code> 命名空间 <code>CORS</code> 配置的替代方法， 仅对依赖于<code>spring-web</code>的应用程序有用（不适用于<code>spring-webmvc</code>）或 要求在<code>javax.servlet.Filter</code> 级别进行CORS检查的安全约束链接。这个是目前官方的一些解读，但是我还是不太清楚实际机制。</p>
<p>你可以通过 <code>HttpSecurity#cors()</code> 来定制。</p>
<h3 id="3-7-CsrfFilter"><a href="#3-7-CsrfFilter" class="headerlink" title="3.7 CsrfFilter"></a>3.7 CsrfFilter</h3><p><code>CsrfFilter</code> 用于防止<code>csrf</code>攻击，前后端使用json交互需要注意的一个问题。</p>
<p>你可以通过 <code>HttpSecurity.csrf()</code> 来开启或者关闭它。在你使用 <code>jwt</code> 等 <code>token</code> 技术时，是不需要这个的。</p>
<h3 id="3-8-LogoutFilter"><a href="#3-8-LogoutFilter" class="headerlink" title="3.8 LogoutFilter"></a>3.8 LogoutFilter</h3><p><code>LogoutFilter</code> 很明显这是处理注销的过滤器。</p>
<p>你可以通过 <code>HttpSecurity.logout()</code> 来定制注销逻辑，非常有用。</p>
<h3 id="3-9-OAuth2AuthorizationRequestRedirectFilter"><a href="#3-9-OAuth2AuthorizationRequestRedirectFilter" class="headerlink" title="3.9 OAuth2AuthorizationRequestRedirectFilter"></a>3.9 OAuth2AuthorizationRequestRedirectFilter</h3><p>和上面的有所不同，这个需要依赖 <code>spring-scurity-oauth2</code> 相关的模块。该过滤器是处理 <code>OAuth2</code> 请求首选重定向相关逻辑的。以后会我会带你们认识它，请多多关注公众号：<code>Felordcn</code> 。</p>
<h3 id="3-10-Saml2WebSsoAuthenticationRequestFilter"><a href="#3-10-Saml2WebSsoAuthenticationRequestFilter" class="headerlink" title="3.10 Saml2WebSsoAuthenticationRequestFilter"></a>3.10 Saml2WebSsoAuthenticationRequestFilter</h3><p>这个需要用到 <code>Spring Security SAML</code> 模块，这是一个基于 <code>SMAL</code> 的 <code>SSO</code> 单点登录请求认证过滤器。</p>
<h4 id="关于SAM"><a href="#关于SAM" class="headerlink" title="关于SAM"></a><a name="saml">关于SAM</a></h4><p><code>SAML</code> 即安全断言标记语言，英文全称是 <code>Security Assertion Markup Language</code>。它是一个基于 <code>XML</code> 的标准，用于在不同的安全域（<code>security domain</code>）之间交换认证和授权数据。在 <code>SAML</code> 标准定义了身份提供者 (<code>identity provider</code>) 和服务提供者 (<code>service provider</code>)，这两者构成了前面所说的不同的安全域。 <code>SAML</code> 是 <code>OASIS</code> 组织安全服务技术委员会(<strong>Security Services Technical Committee</strong>) 的产品。</p>
<p><code>SAML</code>（<strong>Security Assertion Markup Language</strong>）是一个 <code>XML</code> 框架，也就是一组协议，可以用来传输安全声明。比如，两台远程机器之间要通讯，为了保证安全，我们可以采用加密等措施，也可以采用 <code>SAML</code> 来传输，传输的数据以 <code>XML</code> 形式，符合 <code>SAML</code> 规范，这样我们就可以不要求两台机器采用什么样的系统，只要求能理解 <code>SAML</code> 规范即可，显然比传统的方式更好。<code>SAML</code> 规范是一组 <code>Schema</code> 定义。</p>
<p>可以这么说，在 <code>Web Service</code> 领域，<code>schema</code> 就是规范，在 <code>Java</code> 领域，<code>API</code> 就是规范</p>
<h3 id="3-11-X509AuthenticationFilter"><a href="#3-11-X509AuthenticationFilter" class="headerlink" title="3.11 X509AuthenticationFilter"></a>3.11 X509AuthenticationFilter</h3><p><code>X509</code> 认证过滤器。你可以通过 <code>HttpSecurity#X509()</code> 来启用和配置相关功能。</p>
<h3 id="3-12-AbstractPreAuthenticatedProcessingFilter"><a href="#3-12-AbstractPreAuthenticatedProcessingFilter" class="headerlink" title="3.12 AbstractPreAuthenticatedProcessingFilter"></a>3.12 AbstractPreAuthenticatedProcessingFilter</h3><p><code>AbstractPreAuthenticatedProcessingFilter</code> 处理经过预先认证的身份验证请求的过滤器的基类，其中认证主体已经由外部系统进行了身份验证。 目的只是从传入请求中提取主体上的必要信息，而不是对它们进行身份验证。</p>
<p>你可以继承该类进行具体实现并通过 <code>HttpSecurity#addFilter</code> 方法来添加个性化的<code>AbstractPreAuthenticatedProcessingFilter</code> 。</p>
<h3 id="3-13-CasAuthenticationFilter"><a href="#3-13-CasAuthenticationFilter" class="headerlink" title="3.13 CasAuthenticationFilter"></a>3.13 CasAuthenticationFilter</h3><p><code>CAS</code> 单点登录认证过滤器 。依赖 Spring Security CAS 模块</p>
<h3 id="3-14-OAuth2LoginAuthenticationFilter"><a href="#3-14-OAuth2LoginAuthenticationFilter" class="headerlink" title="3.14 OAuth2LoginAuthenticationFilter"></a>3.14 OAuth2LoginAuthenticationFilter</h3><p>这个需要依赖 <code>spring-scurity-oauth2</code> 相关的模块。<code>OAuth2</code> 登录认证过滤器。处理通过 OAuth2 进行认证登录的逻辑。</p>
<h3 id="3-15-Saml2WebSsoAuthenticationFilter"><a href="#3-15-Saml2WebSsoAuthenticationFilter" class="headerlink" title="3.15 Saml2WebSsoAuthenticationFilter"></a>3.15 Saml2WebSsoAuthenticationFilter</h3><p>这个需要用到 <code>Spring Security SAML</code> 模块，这是一个基于 <code>SMAL</code> 的 <code>SSO</code> 单点登录认证过滤器。<a href="#saml">关于SAML</a></p>
<h3 id="3-16-UsernamePasswordAuthenticationFilter"><a href="#3-16-UsernamePasswordAuthenticationFilter" class="headerlink" title="3.16 UsernamePasswordAuthenticationFilter"></a>3.16 UsernamePasswordAuthenticationFilter</h3><p>这个看过我相关文章的应该不陌生了。处理用户以及密码认证的核心过滤器。认证请求提交的<code>username</code>和 <code>password</code>，被封装成<code>token</code>进行一系列的认证，便是主要通过这个过滤器完成的，在表单认证的方法中，这是最最关键的过滤器。</p>
<p>你可以通过 <code>HttpSecurity.formLogin()</code> 及相关方法引入其配置对象 <code>FormLoginConfigurer</code> 来进行配置。 我们在<a target="_blank" rel="noopener" href="https://www.wangweiye.cc/blog/2021/07/03/security6/">Spring Security6 - 玩转自定义登录</a> 已经对其进行过个性化的配置和魔改。</p>
<h3 id="3-17-ConcurrentSessionFilter"><a href="#3-17-ConcurrentSessionFilter" class="headerlink" title="3.17 ConcurrentSessionFilter"></a>3.17 ConcurrentSessionFilter</h3><p>参见 <a href="#3.2">3.2 ConcurrentSessionFilter</a>。 该过滤器可能会被多次执行。</p>
<h3 id="3-18-OpenIDAuthenticationFilter"><a href="#3-18-OpenIDAuthenticationFilter" class="headerlink" title="3.18 OpenIDAuthenticationFilter"></a>3.18 OpenIDAuthenticationFilter</h3><p>基于<code>OpenID</code> 认证协议的认证过滤器。 你需要在依赖中依赖额外的相关模块才能启用它。</p>
<h3 id="3-19-DefaultLoginPageGeneratingFilter"><a href="#3-19-DefaultLoginPageGeneratingFilter" class="headerlink" title="3.19 DefaultLoginPageGeneratingFilter"></a>3.19 DefaultLoginPageGeneratingFilter</h3><p>生成默认的登录页。默认 <code>/login</code></p>
<h3 id="3-20-DefaultLogoutPageGeneratingFilter"><a href="#3-20-DefaultLogoutPageGeneratingFilter" class="headerlink" title="3.20 DefaultLogoutPageGeneratingFilter"></a>3.20 DefaultLogoutPageGeneratingFilter</h3><p>生成默认的退出页。 默认 <code>/logout</code></p>
<h3 id="3-21-ConcurrentSessionFilter"><a href="#3-21-ConcurrentSessionFilter" class="headerlink" title="3.21 ConcurrentSessionFilter"></a>3.21 ConcurrentSessionFilter</h3><p>参见 <a href="#3.2">3.2 ConcurrentSessionFilter</a>。 该过滤器可能会被多次执行。</p>
<h3 id="3-23-DigestAuthenticationFilter"><a href="#3-23-DigestAuthenticationFilter" class="headerlink" title="3.23 DigestAuthenticationFilter"></a>3.23 DigestAuthenticationFilter</h3><p><code>Digest</code>身份验证是 <code>Web</code> 应用程序中流行的可选的身份验证机制 。<code>DigestAuthenticationFilter</code> 能够处理 <code>HTTP</code> 头中显示的摘要式身份验证凭据。你可以通过 <code>HttpSecurity.addFilter()</code> 来启用和配置相关功能。</p>
<h3 id="3-24-BasicAuthenticationFilter"><a href="#3-24-BasicAuthenticationFilter" class="headerlink" title="3.24 BasicAuthenticationFilter"></a>3.24 BasicAuthenticationFilter</h3><p>和<code>Digest</code>身份验证一样都是<code>Web</code> 应用程序中流行的可选的身份验证机制 。 <code>BasicAuthenticationFilter</code> 负责处理 <code>HTTP</code> 头中显示的基本身份验证凭据。这个 <strong>Spring Security</strong> 的 <strong>Spring Boot</strong> 自动配置默认是启用的 。</p>
<p><code>BasicAuthenticationFilter</code> 通过 <code>HttpSecurity.httpBasic()</code> 及相关方法引入其配置对象 <code>HttpBasicConfigurer</code> 来进行配置。</p>
<h3 id="3-25-RequestCacheAwareFilter"><a href="#3-25-RequestCacheAwareFilter" class="headerlink" title="3.25 RequestCacheAwareFilter"></a>3.25 RequestCacheAwareFilter</h3><p>用于用户认证成功后，重新恢复因为登录被打断的请求。当匿名访问一个需要授权的资源时。会跳转到认证处理逻辑，此时请求被缓存。在认证逻辑处理完毕后，从缓存中获取最开始的资源请求进行再次请求。</p>
<p><code>RequestCacheAwareFilter</code> 通过 <code>HttpScurity.requestCache()</code> 及相关方法引入其配置对象 <code>RequestCacheConfigurer</code> 来进行配置。</p>
<h3 id="3-26-SecurityContextHolderAwareRequestFilter"><a href="#3-26-SecurityContextHolderAwareRequestFilter" class="headerlink" title="3.26 SecurityContextHolderAwareRequestFilter"></a>3.26 SecurityContextHolderAwareRequestFilter</h3><p>用来 实现<code>j2ee</code>中 <code>Servlet Api</code> 一些接口方法, 比如 <code>getRemoteUser</code> 方法、<code>isUserInRole</code> 方法，在使用 <strong>Spring Security</strong> 时其实就是通过这个过滤器来实现的。</p>
<p><code>SecurityContextHolderAwareRequestFilter</code> 通过 <code>HttpSecurity.servletApi()</code> 及相关方法引入其配置对象 <code>ServletApiConfigurer</code> 来进行配置。</p>
<h3 id="3-27-JaasApiIntegrationFilter"><a href="#3-27-JaasApiIntegrationFilter" class="headerlink" title="3.27 JaasApiIntegrationFilter"></a>3.27 JaasApiIntegrationFilter</h3><p>适用于<code>JAAS</code> （<code>Java</code> 认证授权服务）。 如果 <code>SecurityContextHolder</code> 中拥有的 <code>Authentication</code> 是一个 <code>JaasAuthenticationToken</code>，那么该 <code>JaasApiIntegrationFilter</code> 将使用包含在 <code>JaasAuthenticationToken</code> 中的 <code>Subject</code> 继续执行 <code>FilterChain</code>。</p>
<h3 id="3-28-RememberMeAuthenticationFilter"><a href="#3-28-RememberMeAuthenticationFilter" class="headerlink" title="3.28 RememberMeAuthenticationFilter"></a>3.28 RememberMeAuthenticationFilter</h3><p>处理 <code>记住我</code> 功能的过滤器。</p>
<p><code>RememberMeAuthenticationFilter</code> 通过 <code>HttpSecurity.rememberMe()</code> 及相关方法引入其配置对象 <code>RememberMeConfigurer</code> 来进行配置。</p>
<h3 id="3-29-AnonymousAuthenticationFilter"><a href="#3-29-AnonymousAuthenticationFilter" class="headerlink" title="3.29 AnonymousAuthenticationFilter"></a>3.29 AnonymousAuthenticationFilter</h3><p>匿名认证过滤器。<strong>对于 <code>Spring Security</code> 来说，所有对资源的访问都是有 <code>Authentication</code> 的。对于无需登录（<code>UsernamePasswordAuthenticationFilter</code> ）直接可以访问的资源，会授予其匿名用户身份。</strong></p>
<p><code>AnonymousAuthenticationFilter</code> 通过 <code>HttpSecurity.anonymous()</code> 及相关方法引入其配置对象 <code>AnonymousConfigurer</code> 来进行配置。</p>
<h3 id="3-30-SessionManagementFilter"><a href="#3-30-SessionManagementFilter" class="headerlink" title="3.30 SessionManagementFilter"></a>3.30 SessionManagementFilter</h3><p><code>Session</code> 管理器过滤器，内部维护了一个 <code>SessionAuthenticationStrategy</code> 用于管理 <code>Session</code> 。</p>
<p><code>SessionManagementFilter</code> 通过 <code>HttpScurity.sessionManagement()</code> 及相关方法引入其配置对象 <code>SessionManagementConfigurer</code> 来进行配置。</p>
<h3 id="3-31-ExceptionTranslationFilter"><a href="#3-31-ExceptionTranslationFilter" class="headerlink" title="3.31 ExceptionTranslationFilter"></a>3.31 ExceptionTranslationFilter</h3><p>主要来传输异常事件，还记得之前我们见过的 <code>DefaultAuthenticationEventPublisher</code> 吗？</p>
<h3 id="3-32-FilterSecurityInterceptor"><a href="#3-32-FilterSecurityInterceptor" class="headerlink" title="3.32 FilterSecurityInterceptor"></a>3.32 FilterSecurityInterceptor</h3><p>这个过滤器决定了访问特定路径应该具备的权限，访问的用户的角色，权限是什么？访问的路径需要什么样的角色和权限？这些判断和处理都是由该类进行的。<strong>如果你要实现动态权限控制就必须研究该类</strong> 。</p>
<h3 id="3-33-SwitchUserFilter"><a href="#3-33-SwitchUserFilter" class="headerlink" title="3.33 SwitchUserFilter"></a>3.33 SwitchUserFilter</h3><p><code>SwitchUserFilter</code> 是用来做账户切换的。默认的切换账号的<code>url</code>为<code>/login/impersonate</code>，默认注销切换账号的<code>url</code>为<code>/logout/impersonate</code>，默认的账号参数为<code>username</code> 。</p>
<p>你可以通过此类实现自定义的账户切换。</p>
<h2 id="4-总结"><a href="#4-总结" class="headerlink" title="4. 总结"></a>4. 总结</h2><p>所有内置的 31个过滤器作用都讲解完了，<strong>有一些默认已经启用。有一些需要引入特定的包并且对 <code>HttpSecurity</code> 进行配置才会生效 。而且它们的顺序是既定的。</strong> 只有你了解这些过滤器你才能基于业务深度定制 <strong>Spring Security</strong> 。</p>
<p>转载自<a target="_blank" rel="noopener" href="https://www.felord.cn/spring-security-filters.html">@felord.cn</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://wangweiye01.github.io/blog/2021/07/03/security6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="老枪">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Coding & Life">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Coding & Life">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/2021/07/03/security6/" class="post-title-link" itemprop="url">Spring Security6 - 玩转自定义登录</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-07-03 16:11:40" itemprop="dateCreated datePublished" datetime="2021-07-03T16:11:40+08:00">2021-07-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-06-16 15:54:53" itemprop="dateModified" datetime="2025-06-16T15:54:53+08:00">2025-06-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Spring-Security/" itemprop="url" rel="index"><span itemprop="name">Spring Security</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="1-前言"><a href="#1-前言" class="headerlink" title="1. 前言"></a>1. 前言</h2><p>安全访问的第一步就是认证（<code>Authentication</code>），认证的第一步就是登录。今天我们要通过对 <strong>Spring Security</strong> 的自定义，来设计一个可扩展，可伸缩的 <strong>form</strong> 登录功能。</p>
<h2 id="2-form-登录的流程"><a href="#2-form-登录的流程" class="headerlink" title="2. form 登录的流程"></a>2. form 登录的流程</h2><p>下面是form登录的基本流程:</p>
<p><img src="https://blog-1256050353.file.myqcloud.com/2021070303.png"></p>
<p>只要是 form 登录基本都能转化为上面的流程。接下来我们看看 Spring Security 是如何处理的。</p>
<h2 id="3-Spring-Security-中的登录"><a href="#3-Spring-Security-中的登录" class="headerlink" title="3. Spring Security 中的登录"></a>3. Spring Security 中的登录</h2><p>上一篇中已经讲到了我们通常的自定义访问控制主要是通过 <code>HttpSecurity</code> 来构建的。默认它提供了三种登录方式：</p>
<ul>
<li><code>formLogin()</code> 普通表单登录</li>
<li><code>oauth2Login()</code> 基于 <code>OAuth2.0</code> 认证&#x2F;授权协议</li>
<li><code>openidLogin()</code> 基于 <code>OpenID</code> 身份认证规范</li>
</ul>
<p>以上三种方式统统是 <code>AbstractAuthenticationFilterConfigurer</code> 实现的。</p>
<h2 id="4-HttpSecurity-中的-form-表单登录"><a href="#4-HttpSecurity-中的-form-表单登录" class="headerlink" title="4. HttpSecurity 中的 form 表单登录"></a>4. HttpSecurity 中的 form 表单登录</h2><p>启用表单登录通过两种方式一种是通过 <code>HttpSecurity</code> 的 <code>apply(C configurer)</code> 方法自己构造一个 <code>AbstractAuthenticationFilterConfigurer</code> 的实现，这种是比较高级的玩法。 另一种是我们常见的使用 <code>HttpSecurity</code> 的 <code>formLogin()</code> 方法来自定义 <code>FormLoginConfigurer</code> 。我们先搞一下比较常规的第二种。</p>
<h3 id="4-1-FormLoginConfigurer"><a href="#4-1-FormLoginConfigurer" class="headerlink" title="4.1 FormLoginConfigurer"></a>4.1 FormLoginConfigurer</h3><p>该类是 <strong>form</strong> 表单登录的配置类。它提供了一些我们常用的配置方法：</p>
<ul>
<li><code>loginPage(String loginPage)</code> : 登录<strong>页面</strong>而并不是接口，对于前后分离模式需要我们进行改造 默认为 <code>/login</code>。</li>
<li><code>loginProcessingUrl(String loginProcessingUrl)</code>实际表单向后台提交用户信息的 <code>Action</code>，再由过滤器<code>UsernamePasswordAuthenticationFilter</code>拦截处理，该 <code>Action</code> 其实不会处理任何逻辑。</li>
<li><code>usernameParameter(String usernameParameter)</code> 用来自定义用户参数名，默认 <code>username</code>。</li>
<li><code>passwordParameter(String passwordParameter)</code>用来自定义用户密码名，默认<code>password</code></li>
<li><code>failureUrl(String authenticationFailureUrl)</code>登录失败后会重定向到此路径， 一般前后分离不会使用它。</li>
<li><code>failureForwardUrl(String forwardUrl)</code> 登录失败会转发到此， 一般前后分离用到它。 可定义一个 <code>Controller</code> （控制器）来处理返回值,但是要注意 <code>RequestMethod</code>。</li>
<li><code>defaultSuccessUrl(String defaultSuccessUrl, boolean alwaysUse)</code> 默认登陆成功后跳转到此，如果 <code>alwaysUse</code> 为 <code>true</code> 只要进行认证流程而且成功，会一直跳转到此。一般推荐默认值 <code>false</code></li>
<li><code>successForwardUrl(String forwardUrl)</code> 效果等同于上面 <code>defaultSuccessUrl</code> 的 <code>alwaysUse</code> 为 <code>true</code> 但是要注意 <code>RequestMethod</code>。</li>
<li><code>successHandler(AuthenticationSuccessHandler successHandler)</code>自定义认证成功处理器，可替代上面所有的 <code>success</code> 方式</li>
<li><code>failureHandler(AuthenticationFailureHandler authenticationFailureHandler)</code> 自定义失败处理器，可替代上面所有的 <code>failure</code> 方式</li>
<li><code>permitAll(boolean permitAll)</code> <strong>form</strong> 表单登录是否放开</li>
</ul>
<p>知道了这些我们就能来搞个定制化的登录了。</p>
<h2 id="5-Spring-Security-聚合登录-实战"><a href="#5-Spring-Security-聚合登录-实战" class="headerlink" title="5. Spring Security 聚合登录 实战"></a>5. Spring Security 聚合登录 实战</h2><p>接下来是我们最激动人心的实战登录操作。 有疑问的可认真阅读以往的预热文章</p>
<h3 id="5-1-简单需求"><a href="#5-1-简单需求" class="headerlink" title="5.1 简单需求"></a>5.1 简单需求</h3><p>我们的接口访问都要通过认证，登陆错误后返回错误信息（json），成功后前台可以获取到对应数据库用户信息（json）（<strong>实战中记得脱敏</strong>）。</p>
<p>我们定义处理成功失败的控制器：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/login&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoginController</span> &#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> SysUserService sysUserService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 登录失败返回 401 以及提示信息.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> the rest</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/failure&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Rest <span class="title function_">loginFailure</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> RestBody.failure(HttpStatus.UNAUTHORIZED.value(), <span class="string">&quot;登录失败了，老哥&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 登录成功后拿到个人信息.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> the rest</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/success&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Rest <span class="title function_">loginSuccess</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 登录成功后用户的认证信息 UserDetails会存在 安全上下文寄存器 SecurityContextHolder 中</span></span><br><span class="line">        <span class="type">User</span> <span class="variable">principal</span> <span class="operator">=</span> (User) SecurityContextHolder.getContext().getAuthentication().getPrincipal();</span><br><span class="line">        <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> principal.getUsername();</span><br><span class="line">        <span class="type">SysUser</span> <span class="variable">sysUser</span> <span class="operator">=</span> sysUserService.queryByUsername(username);</span><br><span class="line">        <span class="comment">// 脱敏</span></span><br><span class="line">        sysUser.setEncodePassword(<span class="string">&quot;[PROTECT]&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> RestBody.okData(sysUser,<span class="string">&quot;登录成功&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后，我们自定义配置重写<code>void configure(HttpSecurity http)</code>方法进行如下配置（这里需要禁用crsf）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConditionalOnClass(WebSecurityConfigurerAdapter.class)</span></span><br><span class="line"><span class="meta">@ConditionalOnWebApplication(type = ConditionalOnWebApplication.Type.SERVLET)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomSpringBootWebSecurityConfiguration</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Configuration</span></span><br><span class="line">    <span class="meta">@Order(SecurityProperties.BASIC_AUTH_ORDER)</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">DefaultConfigurerAdapter</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            <span class="built_in">super</span>.configure(auth);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(WebSecurity web)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            <span class="built_in">super</span>.configure(web);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            http.csrf().disable()</span><br><span class="line">                    .cors()</span><br><span class="line">                    .and()</span><br><span class="line">                    .authorizeRequests().anyRequest().authenticated()</span><br><span class="line">                    .and()</span><br><span class="line">                    .formLogin()</span><br><span class="line">                    .loginProcessingUrl(<span class="string">&quot;/process&quot;</span>)</span><br><span class="line">                    .successForwardUrl(<span class="string">&quot;/login/success&quot;</span>).</span><br><span class="line">                    failureForwardUrl(<span class="string">&quot;/login/failure&quot;</span>);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用 Postman 或者其它工具进行 Post 方式的表单提交 <code>http://localhost:8080/process?username=Felordcn&amp;password=12345</code> 会返回用户信息：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;httpStatus&quot;</span><span class="punctuation">:</span> <span class="number">200</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;data&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;userId&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;username&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Felordcn&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;encodePassword&quot;</span><span class="punctuation">:</span> <span class="string">&quot;[PROTECT]&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;age&quot;</span><span class="punctuation">:</span> <span class="number">18</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;msg&quot;</span><span class="punctuation">:</span> <span class="string">&quot;登录成功&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;identifier&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>把密码修改为其它值再次请求认证失败后：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;httpStatus&quot;</span><span class="punctuation">:</span> <span class="number">401</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;data&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;msg&quot;</span><span class="punctuation">:</span> <span class="string">&quot;登录失败了，老哥&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;identifier&quot;</span><span class="punctuation">:</span> <span class="string">&quot;-9999&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="6-多种登录方式并存的实现"><a href="#6-多种登录方式并存的实现" class="headerlink" title="6. 多种登录方式并存的实现"></a>6. 多种登录方式并存的实现</h2><p>就这么完了了么？现在登录的花样繁多。常规的就有短信、邮箱、扫码 ，第三方是以后我要讲的不在今天范围之内。 如何应对想法多的产品经理？ 我们来搞一个可扩展各种姿势的登录方式。我们在上面 <strong>2. form 登录的流程</strong> 中的 <strong>用户</strong> 和 <strong>判定</strong> 之间增加一个适配器来适配即可。 我们知道这个所谓的<strong>判定</strong>就是<code>UsernamePasswordAuthenticationFilter</code>。</p>
<p><strong>我们只需要保证 <code>uri</code> 为上面配置的<code>/process</code> 并且能够通过 <code>getParameter(String name)</code> 获取用户名和密码即可</strong></p>
<p>我突然觉得可以模仿 <code>DelegatingPasswordEncoder</code> 的搞法， 维护一个注册表执行不同的处理策略。当然我们要实现一个 <code>GenericFilterBean</code> 在 <code>UsernamePasswordAuthenticationFilter</code> 之前执行。同时制定登录的策略。</p>
<h3 id="6-1-登录方式定义"><a href="#6-1-登录方式定义" class="headerlink" title="6.1 登录方式定义"></a>6.1 登录方式定义</h3><p>定义登录方式枚举</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">LoginTypeEnum</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 原始登录方式.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    FORM,</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Json 提交.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    JSON,</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 验证码.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    CAPTCHA</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="6-2-定义前置处理器接口"><a href="#6-2-定义前置处理器接口" class="headerlink" title="6.2 定义前置处理器接口"></a>6.2 定义前置处理器接口</h3><p>定义前置处理器接口用来处理接收的各种特色的登录参数 并处理具体的逻辑。这个借口其实有点随意 ，重要的是你要学会思路。我实现了一个 默认的 form 表单登录 和 通过<code>RequestBody</code>放入<code>json</code> 的两种方式，篇幅限制这里就不展示了。具体的 DEMO 参见底部。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">LoginPostProcessor</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 获取 登录类型</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> the type</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    LoginTypeEnum <span class="title function_">getLoginTypeEnum</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 获取用户名</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> request the request</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> the string</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    String <span class="title function_">obtainUsername</span><span class="params">(ServletRequest request)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 获取密码</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> request the request</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> the string</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    String <span class="title function_">obtainPassword</span><span class="params">(ServletRequest request)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="6-3-实现登录前置处理过滤器"><a href="#6-3-实现登录前置处理过滤器" class="headerlink" title="6.3 实现登录前置处理过滤器"></a>6.3 实现登录前置处理过滤器</h3><p>该过滤器维护了 <code>LoginPostProcessor</code> 映射表。 通过前端来判定登录方式进行策略上的预处理，最终还是会交给 <code>UsernamePasswordAuthenticationFilter</code> 。通过 <code>HttpSecurity</code> 的 <code>addFilterBefore(preLoginFilter, UsernamePasswordAuthenticationFilter.class)</code>方法进行前置。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.felord.spring.security.filter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.felord.spring.security.enumation.LoginTypeEnum;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.web.util.matcher.AntPathRequestMatcher;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.web.util.matcher.RequestMatcher;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.Assert;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.CollectionUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.filter.GenericFilterBean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.FilterChain;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletResponse;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.Collection;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter.SPRING_SECURITY_FORM_PASSWORD_KEY;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter.SPRING_SECURITY_FORM_USERNAME_KEY;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 预登录控制器</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* <span class="doctag">@author</span> Felordcn</span></span><br><span class="line"><span class="comment">* <span class="doctag">@since</span> 16 :21 2019/10/17</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PreLoginFilter</span> <span class="keyword">extends</span> <span class="title class_">GenericFilterBean</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">LOGIN_TYPE_KEY</span> <span class="operator">=</span> <span class="string">&quot;login_type&quot;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> RequestMatcher requiresAuthenticationRequestMatcher;</span><br><span class="line">    <span class="keyword">private</span> Map&lt;LoginTypeEnum, LoginPostProcessor&gt; processors = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">PreLoginFilter</span><span class="params">(String loginProcessingUrl, Collection&lt;LoginPostProcessor&gt; loginPostProcessors)</span> &#123;</span><br><span class="line">        Assert.notNull(loginProcessingUrl, <span class="string">&quot;loginProcessingUrl must not be null&quot;</span>);</span><br><span class="line">        requiresAuthenticationRequestMatcher = <span class="keyword">new</span> <span class="title class_">AntPathRequestMatcher</span>(loginProcessingUrl, <span class="string">&quot;POST&quot;</span>);</span><br><span class="line">        <span class="type">LoginPostProcessor</span> <span class="variable">loginPostProcessor</span> <span class="operator">=</span> defaultLoginPostProcessor();</span><br><span class="line">        processors.put(loginPostProcessor.getLoginTypeEnum(), loginPostProcessor);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!CollectionUtils.isEmpty(loginPostProcessors)) &#123;</span><br><span class="line">            loginPostProcessors.forEach(element -&gt; processors.put(element.getLoginTypeEnum(), element));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> LoginTypeEnum <span class="title function_">getTypeFromReq</span><span class="params">(ServletRequest request)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">parameter</span> <span class="operator">=</span> request.getParameter(LOGIN_TYPE_KEY);</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> Integer.parseInt(parameter);</span><br><span class="line">        LoginTypeEnum[] values = LoginTypeEnum.values();</span><br><span class="line">        <span class="keyword">return</span> values[i];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 默认还是Form .</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> the login post processor</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">private</span> LoginPostProcessor <span class="title function_">defaultLoginPostProcessor</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">LoginPostProcessor</span>() &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> LoginTypeEnum <span class="title function_">getLoginTypeEnum</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> LoginTypeEnum.FORM;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> String <span class="title function_">obtainUsername</span><span class="params">(ServletRequest request)</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> request.getParameter(SPRING_SECURITY_FORM_USERNAME_KEY);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> String <span class="title function_">obtainPassword</span><span class="params">(ServletRequest request)</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> request.getParameter(SPRING_SECURITY_FORM_PASSWORD_KEY);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain chain)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">        <span class="type">ParameterRequestWrapper</span> <span class="variable">parameterRequestWrapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ParameterRequestWrapper</span>((HttpServletRequest) request);</span><br><span class="line">        <span class="keyword">if</span> (requiresAuthenticationRequestMatcher.matches((HttpServletRequest) request)) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="type">LoginTypeEnum</span> <span class="variable">typeFromReq</span> <span class="operator">=</span> getTypeFromReq(request);</span><br><span class="line"></span><br><span class="line">            <span class="type">LoginPostProcessor</span> <span class="variable">loginPostProcessor</span> <span class="operator">=</span> processors.get(typeFromReq);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> loginPostProcessor.obtainUsername(request);</span><br><span class="line"></span><br><span class="line">            <span class="type">String</span> <span class="variable">password</span> <span class="operator">=</span> loginPostProcessor.obtainPassword(request);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            parameterRequestWrapper.setAttribute(SPRING_SECURITY_FORM_USERNAME_KEY, username);</span><br><span class="line">            parameterRequestWrapper.setAttribute(SPRING_SECURITY_FORM_PASSWORD_KEY, password);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        chain.doFilter(parameterRequestWrapper, response);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="6-4-验证"><a href="#6-4-验证" class="headerlink" title="6.4 验证"></a>6.4 验证</h3><p>通过<code>POST</code>表单提交方式<code>http://localhost:8080/process?username=Felordcn&amp;password=12345&amp;login_type=0</code>可以请求成功。或者以下列方式也可以提交成功：</p>
<p><img src="https://blog-1256050353.file.myqcloud.com/2021070304.png"></p>
<p>更多的方式 只需要实现接口 <code>LoginPostProcessor</code> 注入 <code>PreLoginFilter</code></p>
<h2 id="7-总结"><a href="#7-总结" class="headerlink" title="7. 总结"></a>7. 总结</h2><p>今天我们通过各种技术的运用实现了从简单登录到可动态扩展的多种方式并存的实战运用，其实我们还间接实现了前后端分离的接口登录方式。相信对你来说会有不小的收获。代码在<code>day03</code>分支</p>
<p>转载自<a target="_blank" rel="noopener" href="https://felord.cn/spring-security-login.html">@felord.cn</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://wangweiye01.github.io/blog/2021/07/03/security5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="老枪">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Coding & Life">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Coding & Life">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/2021/07/03/security5/" class="post-title-link" itemprop="url">Spring Security5 - 自定义配置类入口WebSecurityConfigurerAdapter</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-07-03 15:01:08" itemprop="dateCreated datePublished" datetime="2021-07-03T15:01:08+08:00">2021-07-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-06-16 15:54:53" itemprop="dateModified" datetime="2025-06-16T15:54:53+08:00">2025-06-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Spring-Security/" itemprop="url" rel="index"><span itemprop="name">Spring Security</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="1-前言"><a href="#1-前言" class="headerlink" title="1. 前言"></a>1. 前言</h2><p>今天我们要进一步的的学习如何自定义配置 <code>Spring Security</code> 我们已经多次提到了 <code>WebSecurityConfigurerAdapter</code> ，而且我们知道 Spring Boot 中的自动配置实际上是通过自动配置包下的 <code>SecurityAutoConfiguration</code> 总配置类上导入的 Spring Boot Web 安全配置类 <code>SpringBootWebSecurityConfiguration</code> 来配置的。所以我们就拿它开刀</p>
<h2 id="2-自定义-Spring-Boot-Web-安全配置类"><a href="#2-自定义-Spring-Boot-Web-安全配置类" class="headerlink" title="2. 自定义 Spring Boot Web 安全配置类"></a>2. 自定义 Spring Boot Web 安全配置类</h2><p>我们使用我们最擅长的 <code>Ctrl + C</code> 、<code>Ctrl + V</code> 抄源码中的 <code>SpringBootWebSecurityConfiguration</code> ，命名为我们自定义的 <code>CustomSpringBootWebSecurityConfiguration</code> :</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConditionalOnClass(WebSecurityConfigurerAdapter.class)</span></span><br><span class="line"><span class="meta">@ConditionalOnWebApplication(type = ConditionalOnWebApplication.Type.SERVLET)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomSpringBootWebSecurityConfiguration</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Configuration</span></span><br><span class="line">    <span class="meta">@Order(SecurityProperties.BASIC_AUTH_ORDER)</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">DefaultConfigurerAdapter</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            <span class="built_in">super</span>.configure(auth);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(WebSecurity web)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            <span class="built_in">super</span>.configure(web);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            <span class="built_in">super</span>.configure(http);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>相信已经有人注意到了上面 <code>DefaultConfigurerAdapter</code> 中我覆写（<code>@Override</code>）了三个方法，我们一般会通过自定义配置这三个方法来自定义我们的安全访问策略。</p>
<h3 id="2-1-认证管理器配置方法"><a href="#2-1-认证管理器配置方法" class="headerlink" title="2.1 认证管理器配置方法"></a>2.1 认证管理器配置方法</h3><p><code>void configure(AuthenticationManagerBuilder auth)</code> 用来配置认证管理器<code>AuthenticationManager</code>。说白了就是所有 <code>UserDetails</code> 相关的它都管，包含 <code>PasswordEncoder</code> 密码机。本文对 <code>AuthenticationManager</code> 不做具体分析讲解，后面会有专门的文章来讲这个东西。</p>
<h3 id="2-2-核心过滤器配置方法"><a href="#2-2-核心过滤器配置方法" class="headerlink" title="2.2  核心过滤器配置方法"></a>2.2  核心过滤器配置方法</h3><p><code>void configure(WebSecurity web)</code> 用来配置 <code>WebSecurity</code> 。而 <code>WebSecurity</code> 是基于 <code>Servlet Filter</code> 用来配置 <code>springSecurityFilterChain</code> 。而 <code>springSecurityFilterChain</code> 又被委托给了 <strong>Spring Security 核心过滤器 Bean</strong> <code>DelegatingFilterProxy</code> 。 相关逻辑你可以在 <code>WebSecurityConfiguration</code> 中找到。我们一般不会过多来自定义 <code>WebSecurity</code> , 使用较多的是其<code>ignoring()</code> 方法用来忽略 <strong>Spring Security</strong> 对静态资源的控制。</p>
<h3 id="2-3-安全过滤器链配置方法"><a href="#2-3-安全过滤器链配置方法" class="headerlink" title="2.3 安全过滤器链配置方法"></a>2.3 安全过滤器链配置方法</h3><p><code>void configure(HttpSecurity http)</code> 这个是我们使用最多的，用来配置 <code>HttpSecurity</code> 。 HttpSecurity 用于构建一个安全过滤器链 <code>SecurityFilterChain</code> 。<code>SecurityFilterChain</code> 最终被注入<strong>核心过滤器</strong> 。 <code>HttpSecurity</code> 有许多我们需要的配置。我们可以通过它来进行自定义安全访问策略。所以我们单独开一章来讲解这个东西。</p>
<h2 id="3-HttpSecurity-配置"><a href="#3-HttpSecurity-配置" class="headerlink" title="3. HttpSecurity 配置"></a>3. HttpSecurity 配置</h2><p><code>HttpSecurity</code> 是后面几篇文章的重点，我们将实际操作它来实现一些实用功能。所以本文要着重介绍它。</p>
<h3 id="3-1-默认配置"><a href="#3-1-默认配置" class="headerlink" title="3.1 默认配置"></a>3.1 默认配置</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    logger.debug(<span class="string">&quot;Using default configure(HttpSecurity). If subclassed this will potentially override subclass configure(HttpSecurity).&quot;</span>);</span><br><span class="line"></span><br><span class="line">    http</span><br><span class="line">        .authorizeRequests()</span><br><span class="line">            .anyRequest().authenticated()</span><br><span class="line">            .and()</span><br><span class="line">        .formLogin().and()</span><br><span class="line">        .httpBasic();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面是 <strong>Spring Security</strong> 在 <strong>Spring Boot</strong> 中的默认配置。通过以上的配置，你的应用具备了一下的功能：</p>
<ul>
<li>所有的请求访问都需要被授权。</li>
<li>使用<code>form</code>表单进行登陆(默认路径为<code>/login</code>)，也就是前几篇我们见到的登录页。</li>
<li>防止<code>CSRF</code>攻击、 <code>XSS</code> 攻击。</li>
<li>启用 <code>HTTP Basic</code> 认证</li>
</ul>
<h3 id="3-2-常用方法解读"><a href="#3-2-常用方法解读" class="headerlink" title="3.2 常用方法解读"></a>3.2 常用方法解读</h3><p><code>HttpSecurity</code>使用了<code>builder</code>的构建方式来灵活制定访问策略。最早基于 <code>XML</code> 标签对 <code>HttpSecurity</code> 进行配置。现在大部分使用<code>javaConfig</code>方式。常用的方法解读如下：</p>
<table>
<thead>
<tr>
<th>方法</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>openidLogin()</td>
<td>用于基于 OpenId 的验证</td>
</tr>
<tr>
<td>headers()</td>
<td>将安全标头添加到响应,比如说简单的 XSS 保护</td>
</tr>
<tr>
<td>cors()</td>
<td>配置跨域资源共享（ CORS ）</td>
</tr>
<tr>
<td>sessionManagement()</td>
<td>允许配置会话管理</td>
</tr>
<tr>
<td>portMapper()</td>
<td>允许配置一个PortMapper(HttpSecurity#(getSharedObject(class)))，其他提供SecurityConfigurer的对象使用 PortMapper 从 HTTP 重定向到 HTTPS 或者从 HTTPS 重定向到 HTTP。默认情况下，Spring Security使用一个PortMapperImpl映射 HTTP 端口8080到 HTTPS 端口443，HTTP 端口80到 HTTPS 端口443</td>
</tr>
<tr>
<td>jee()</td>
<td>配置基于容器的预认证。 在这种情况下，认证由Servlet容器管理</td>
</tr>
<tr>
<td>x509()</td>
<td>配置基于x509的认证</td>
</tr>
<tr>
<td>rememberMe</td>
<td>允许配置“记住我”的验证</td>
</tr>
<tr>
<td>authorizeRequests()</td>
<td>允许基于使用HttpServletRequest限制访问</td>
</tr>
<tr>
<td>requestCache()</td>
<td>允许配置请求缓存</td>
</tr>
<tr>
<td>exceptionHandling()</td>
<td>允许配置错误处理</td>
</tr>
<tr>
<td>securityContext()</td>
<td>在HttpServletRequests之间的SecurityContextHolder上设置SecurityContext的管理。 当使用WebSecurityConfigurerAdapter时，这将自动应用</td>
</tr>
<tr>
<td>servletApi()</td>
<td>将HttpServletRequest方法与在其上找到的值集成到SecurityContext中。 当使用WebSecurityConfigurerAdapter时，这将自动应用</td>
</tr>
<tr>
<td>csrf()</td>
<td>添加 CSRF 支持，使用WebSecurityConfigurerAdapter时，默认启用</td>
</tr>
<tr>
<td>logout()</td>
<td>添加退出登录支持。当使用WebSecurityConfigurerAdapter时，这将自动应用。默认情况是，访问URL”&#x2F; logout”，使HTTP Session无效来清除用户，清除已配置的任何#rememberMe()身份验证，清除SecurityContextHolder，然后重定向到“&#x2F;login?success”</td>
</tr>
<tr>
<td>anonymous()</td>
<td>允许配置匿名用户的表示方法。 当与WebSecurityConfigurerAdapter结合使用时，这将自动应用。 默认情况下，匿名用户将使用org.springframework.security.authentication.AnonymousAuthenticationToken表示，并包含角色 “ROLE_ANONYMOUS”</td>
</tr>
<tr>
<td>formLogin()</td>
<td>指定支持基于表单的身份验证。如果未指定FormLoginConfigurer#loginPage(String)，则将生成默认登录页面</td>
</tr>
<tr>
<td>oauth2Login()</td>
<td>根据外部OAuth 2.0或OpenID Connect 1.0提供程序配置身份验证</td>
</tr>
<tr>
<td>requiresChannel()</td>
<td>配置通道安全。为了使该配置有用，必须提供至少一个到所需信道的映射</td>
</tr>
<tr>
<td>httpBasic()</td>
<td>配置 Http Basic 验证</td>
</tr>
<tr>
<td>addFilterBefore()</td>
<td>在指定的Filter类之前添加过滤器</td>
</tr>
<tr>
<td>addFilterAt()</td>
<td>在指定的Filter类的位置添加过滤器</td>
</tr>
<tr>
<td>addFilterAfter()</td>
<td>在指定的Filter类的之后添加过滤器</td>
</tr>
<tr>
<td>and()</td>
<td>连接以上策略的连接器，用来组合安全策略。实际上就是“而且”的意思</td>
</tr>
</tbody></table>
<h2 id="4-总结"><a href="#4-总结" class="headerlink" title="4. 总结"></a>4. 总结</h2><p>到今天为止，我们已经由浅入深学习了很多关于 Spring Security 的知识。已经具有开始自定义来实现一些实用的功能了，在后面的文章开始我们将结合实际开发场景进行一些实战操作</p>
<p>转载自<a target="_blank" rel="noopener" href="https://felord.cn/spring-security-httpsecurity.html">@felord.cn</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://wangweiye01.github.io/blog/2021/07/03/security4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="老枪">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Coding & Life">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Coding & Life">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/2021/07/03/security4/" class="post-title-link" itemprop="url">Spring Security4 - 路径Uri中的 Ant 风格</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-07-03 14:44:24" itemprop="dateCreated datePublished" datetime="2021-07-03T14:44:24+08:00">2021-07-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-06-16 15:54:53" itemprop="dateModified" datetime="2025-06-16T15:54:53+08:00">2025-06-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Spring-Security/" itemprop="url" rel="index"><span itemprop="name">Spring Security</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="1-前言"><a href="#1-前言" class="headerlink" title="1. 前言"></a>1. 前言</h2><p>我们经常在读到一些文章会遇到<code>uri支持</code>Ant&#96;风格 ，而且这个东西在<strong>Spring MVC</strong>和<strong>Spring Security</strong>中经常被提及。这到底是什么呢？今天我们来学习了解一下。这对我们学习 <strong>Spring MVC</strong> 和 <strong>Spring Security</strong> 十分必要。</p>
<h2 id="2-Ant风格"><a href="#2-Ant风格" class="headerlink" title="2. Ant风格"></a>2. Ant风格</h2><p>说白了<code>Ant</code>风格就是一种路径匹配表达式。主要用来对<code>uri</code>的匹配。其实跟正则表达式作用是一样的，只不过正则表达式适用面更加宽泛，<code>Ant</code>仅仅用于路径匹配。</p>
<h2 id="3-Ant-通配符"><a href="#3-Ant-通配符" class="headerlink" title="3. Ant 通配符"></a>3. Ant 通配符</h2><p><code>Ant</code>中的通配符有三种：</p>
<ul>
<li><p><code>?</code>匹配任何单个字符</p>
</li>
<li><p><code>*</code>匹配0或者任意数量的<strong>字符</strong></p>
</li>
<li><p><code>**</code>匹配0或者更多的<strong>目录</strong></p>
</li>
</ul>
<p>这里注意了单个<code>*</code>是在一个目录内进行匹配。 而<code>**</code>是可以匹配多个目录，一定不要迷糊</p>
<h3 id="3-1-Ant-通配符示例"><a href="#3-1-Ant-通配符示例" class="headerlink" title="3.1 Ant 通配符示例"></a>3.1 Ant 通配符示例</h3><p><img src="https://blog-1256050353.file.myqcloud.com/2021070302.png"></p>
<h3 id="3-2-最长匹配原则"><a href="#3-2-最长匹配原则" class="headerlink" title="3.2 最长匹配原则"></a>3.2 最长匹配原则</h3><p>从 3.1 可以看出 <code>*</code> 和 <code>**</code> 是有冲突的情况存在的。为了解决这种冲突就规定了最长匹配原则(has more characters)。 一旦一个<code>uri</code>同时符合两个<code>Ant</code>匹配那么走匹配规则字符最多的。为什么走最长？因为字符越长信息越多就越具体。比如 <code>/ant/a/path</code> 同时满足 <code>/**/path</code> 和 <code>/ant/*/path</code> 那么走<code>/ant/*/path</code></p>
<h2 id="4-Spring-MVC-和-Spring-Security-中的-Ant-风格"><a href="#4-Spring-MVC-和-Spring-Security-中的-Ant-风格" class="headerlink" title="4. Spring MVC 和 Spring Security 中的 Ant 风格"></a>4. Spring MVC 和 Spring Security 中的 Ant 风格</h2><p>接下来我们来看看 <strong>Spring MVC</strong> 和 <strong>Spring Security</strong> 下的<code>Ant</code>风格。</p>
<h3 id="4-1-Spring-MVC-中的-Ant-风格"><a href="#4-1-Spring-MVC-中的-Ant-风格" class="headerlink" title="4.1 Spring MVC 中的 Ant 风格"></a>4.1 Spring MVC 中的 Ant 风格</h3><p>这里也提一下在 <strong>Spring MVC</strong> 中 我们在控制器中写如下接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * ant style test.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> the string</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/?ant&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">ant</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;ant&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>你使用任意合法<code>uri</code>字符替代<code>?</code>发现都可以匹配，比如<code>/bant</code> 。 还有Spring MVC 的一些 过滤器注册、格式化器注册都用到了 <code>Ant</code> 风格。</p>
<h3 id="4-2-Spring-Security-中的-Ant-风格"><a href="#4-2-Spring-Security-中的-Ant-风格" class="headerlink" title="4.2 Spring Security 中的 Ant 风格"></a>4.2 Spring Security 中的 Ant 风格</h3><p>在 <strong>Spring Security</strong> 中 <code>WebSecurityConfigurerAdapter</code> 中的你可以通过如下配置进行路由权限访问控制：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configureGlobal</span><span class="params">(AuthenticationManagerBuilder authenticationManagerBuilder)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        authenticationManagerBuilder.inMemoryAuthentication().withUser(<span class="string">&quot;admin&quot;</span>).password(<span class="string">&quot;admin&quot;</span>).roles(<span class="string">&quot;USER&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        http.authorizeRequests()</span><br><span class="line">                <span class="comment">//放行静态资源 首页</span></span><br><span class="line">                .antMatchers(<span class="string">&quot;/index.html&quot;</span>,<span class="string">&quot;/static/**&quot;</span>).permitAll()</span><br><span class="line">                .anyRequest().authenticated();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面 <strong>Spring Security</strong> 的配置中在 <code>antMatchers</code> 方法中通过 <code>Ant</code> 通配符来控制了资源的访问权限。</p>
<h2 id="5-总结"><a href="#5-总结" class="headerlink" title="5. 总结"></a>5. 总结</h2><p><code>Ant</code> 风格整体东西不多,也很好理解。 很多关于<code>uri</code>的配置、路由匹配、处理都用到了 <code>Ant</code> 风格 。对于 Web 开发人员来说是必须掌握的技能之一。</p>
<p>转载自<a target="_blank" rel="noopener" href="https://felord.cn/spring-security-ant-url.html">@felord.cn</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://wangweiye01.github.io/blog/2021/07/03/security3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="老枪">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Coding & Life">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Coding & Life">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/2021/07/03/security3/" class="post-title-link" itemprop="url">Spring Security3 - Spring Boot 中的 Spring Security 自动配置初探</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-07-03 14:17:20" itemprop="dateCreated datePublished" datetime="2021-07-03T14:17:20+08:00">2021-07-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-06-16 15:54:53" itemprop="dateModified" datetime="2025-06-16T15:54:53+08:00">2025-06-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Spring-Security/" itemprop="url" rel="index"><span itemprop="name">Spring Security</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="1-前言"><a href="#1-前言" class="headerlink" title="1. 前言"></a>1. 前言</h2><p>我们在前几篇对 Spring Security 的用户信息管理机制，密码机制进行了探讨。我们发现<strong>Spring Security Starter</strong>相关的<code>Servlet</code>自动配置都在<code>spring-boot-autoconfigure-2.1.9.RELEASE</code>（当前 Spring Boot 版本为<code>2.1.9.RELEASE</code>） 模块的路径<code>org.springframework.boot.autoconfigure.security.servlet</code>之下。其实官方提供的Starter组件的自动配置你都能在<code>spring-boot-autoconfigure-2.1.9.RELEASE</code>下找到。今天我们进一步来解密<strong>Spring Security</strong>在<strong>Spring Boot</strong>的配置和使用。</p>
<h2 id="2-Spring-Boot-下-Spring-Security-的自动配置"><a href="#2-Spring-Boot-下-Spring-Security-的自动配置" class="headerlink" title="2. Spring Boot 下 Spring Security 的自动配置"></a>2. Spring Boot 下 Spring Security 的自动配置</h2><p>我们可以通过<code>org.springframework.boot.autoconfigure.security.servlet</code>路径下找到<strong>Spring Security</strong>关于<code>Servlet</code>的自动配置类。我们来大致了解一下。</p>
<h3 id="2-1-SecurityAutoConfiguration"><a href="#2-1-SecurityAutoConfiguration" class="headerlink" title="2.1 SecurityAutoConfiguration"></a>2.1 SecurityAutoConfiguration</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.springframework.boot.autoconfigure.security.servlet;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.EnableAutoConfiguration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.condition.ConditionalOnClass;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.condition.ConditionalOnMissingBean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.security.SecurityDataConfiguration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.security.SecurityProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.properties.EnableConfigurationProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.ApplicationEventPublisher;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Import;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.authentication.AuthenticationEventPublisher;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.authentication.DefaultAuthenticationEventPublisher;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> EnableAutoConfiguration Auto-configuration&#125; for Spring Security.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Dave Syer</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Andy Wilkinson</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Madhura Bhave</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 1.0.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConditionalOnClass(DefaultAuthenticationEventPublisher.class)</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties(SecurityProperties.class)</span></span><br><span class="line"><span class="meta">@Import(&#123; SpringBootWebSecurityConfiguration.class, WebSecurityEnablerConfiguration.class,</span></span><br><span class="line"><span class="meta">        SecurityDataConfiguration.class &#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityAutoConfiguration</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConditionalOnMissingBean(AuthenticationEventPublisher.class)</span></span><br><span class="line">    <span class="keyword">public</span> DefaultAuthenticationEventPublisher <span class="title function_">authenticationEventPublisher</span><span class="params">(ApplicationEventPublisher publisher)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DefaultAuthenticationEventPublisher</span>(publisher);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>SecurityAutoConfiguration</code>顾名思义安全配置类。该类引入（<code>@import</code>）了<code>SpringBootWebSecurityConfiguration</code>、<code>WebSecurityEnablerConfiguration</code>和<code>SecurityDataConfiguration</code>三个配置类。 让这三个模块的类生效。是一个复合配置，是 Spring Security 自动配置最重要的一个类之一。 Spring Boot 自动配置经常使用这种方式以达到灵活配置的目的，这也是我们研究 Spring Security 自动配置的一个重要入口 同时 <code>SecurityAutoConfiguration</code>还将<code>DefaultAuthenticationEventPublisher</code>作为默认的<code>AuthenticationEventPublisher</code>注入<strong>Spring IoC</strong>容器。如果你熟悉 Spring 中的事件机制你就会知道该类是一个 Spring 事件发布器。该类内置了一个<code>HashMap&lt;String, Constructor&lt;? extends AbstractAuthenticationEvent&gt;&gt;</code>维护了认证异常处理和对应异常事件处理逻辑的映射关系，比如账户过期异常<code>AccountExpiredException</code>对应认证过期事件<code>AuthenticationFailureExpiredEvent</code> ，也就是说发生不同认证的异常使用不同处理策略。</p>
<h3 id="2-2-SpringBootWebSecurityConfiguration"><a href="#2-2-SpringBootWebSecurityConfiguration" class="headerlink" title="2.2 SpringBootWebSecurityConfiguration"></a>2.2 SpringBootWebSecurityConfiguration</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConditionalOnClass(WebSecurityConfigurerAdapter.class)</span></span><br><span class="line"><span class="meta">@ConditionalOnMissingBean(WebSecurityConfigurerAdapter.class)</span></span><br><span class="line"><span class="meta">@ConditionalOnWebApplication(type = Type.SERVLET)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringBootWebSecurityConfiguration</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Configuration</span></span><br><span class="line">    <span class="meta">@Order(SecurityProperties.BASIC_AUTH_ORDER)</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">DefaultConfigurerAdapter</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个类是Spring Security 对 Spring Boot Servlet Web 应用的默认配置。核心在于<code>WebSecurityConfigurerAdapter</code>适配器。从<code>@ConditionalOnMissingBean(WebSecurityConfigurerAdapter.class)</code>我们就能看出 <code>WebSecurityConfigurerAdapter</code>是安全配置的核心。 默认情况下<code>DefaultConfigurerAdapter</code>将以<code>SecurityProperties.BASIC_AUTH_ORDER（-5）</code>的顺序注入 Spring IoC 容器，这是个空实现。如果我们需要个性化可以通过继承<code>WebSecurityConfigurerAdapter</code>来实现。我们会在以后的博文重点介绍该类。</p>
<h3 id="2-3-WebSecurityEnablerConfiguration"><a href="#2-3-WebSecurityEnablerConfiguration" class="headerlink" title="2.3 WebSecurityEnablerConfiguration"></a>2.3 WebSecurityEnablerConfiguration</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConditionalOnBean(WebSecurityConfigurerAdapter.class)</span></span><br><span class="line"><span class="meta">@ConditionalOnMissingBean(name = BeanIds.SPRING_SECURITY_FILTER_CHAIN)</span></span><br><span class="line"><span class="meta">@ConditionalOnWebApplication(type = ConditionalOnWebApplication.Type.SERVLET)</span></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSecurityEnablerConfiguration</span> &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>该配置类会在<code>SpringBootWebSecurityConfiguration</code>注入 Spring IoC 容器后启用<code>@EnableWebSecurity</code>注解。也就是说<code>WebSecurityEnablerConfiguration</code>目的仅仅就是在某些条件下激活<code>@EnableWebSecurity</code>注解。那么这个注解都有什么呢？</p>
<h2 id="3-EnableWebSecurity-注解"><a href="#3-EnableWebSecurity-注解" class="headerlink" title="3. @EnableWebSecurity 注解"></a>3. @EnableWebSecurity 注解</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Retention(value = java.lang.annotation.RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Target(value = &#123; java.lang.annotation.ElementType.TYPE &#125;)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Import(&#123; WebSecurityConfiguration.class,</span></span><br><span class="line"><span class="meta">        SpringWebMvcImportSelector.class,</span></span><br><span class="line"><span class="meta">        OAuth2ImportSelector.class &#125;)</span></span><br><span class="line"><span class="meta">@EnableGlobalAuthentication</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> EnableWebSecurity &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Controls debugging support for Spring Security. Default is false.</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> if true, enables debug support with Spring Security</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">debug</span><span class="params">()</span> <span class="keyword">default</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>@Enable*</code>这类注解都是带配置导入的注解。通过导入一些配置来启用一些特定功能。 <code>@EnableWebSecurity</code>导入了 <code>WebSecurityConfiguration</code>、<code>SpringWebMvcImportSelector</code>、<code>OAuth2ImportSelector</code>以及启用了<code>@EnableGlobalAuthentication</code>注解。</p>
<h3 id="3-1-WebSecurityConfiguration"><a href="#3-1-WebSecurityConfiguration" class="headerlink" title="3.1 WebSecurityConfiguration"></a>3.1 WebSecurityConfiguration</h3><p>该配置类<code>WebSecurityConfiguration</code>使用一个<code>WebSecurity</code>对象基于用户指定的或者默认的安全配置，你可以通过继承<code>WebSecurityConfigurerAdapter</code>或者实现<code>WebSecurityConfigurer</code>来定制<code>WebSecurity</code>创建一个<code>FilterChainProxy</code> Bean来对用户请求进行安全过滤。这个<code>FilterChainProxy</code>的名称就是<code>WebSecurityEnablerConfiguration上</code>的 <code>BeanIds.SPRING_SECURITY_FILTER_CHAIN</code> 也就是 <code>springSecurityFilterChain</code>,它是一个Filter，最终会被作为Servlet过滤器链中的一个Filter应用到Servlet容器中。安全处理的策略主要是过滤器的调用顺序。<code>WebSecurityConfiguration</code>最终会通过<code>@EnableWebSecurity</code>应用到系统。</p>
<p>源码分析:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.springframework.security.config.annotation.web.configuration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Collections;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.Filter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.BeanClassLoaderAware;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.config.ConfigurableListableBeanFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.DependsOn;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.ImportAware;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.OrderComparator;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.Ordered;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.annotation.AnnotationAttributes;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.annotation.AnnotationUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.annotation.Order;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.type.AnnotationMetadata;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.access.expression.SecurityExpressionHandler;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.ObjectPostProcessor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.SecurityConfigurer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.WebSecurityConfigurer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.builders.WebSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.context.DelegatingApplicationListener;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.web.FilterChainProxy;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.web.FilterInvocation;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.web.access.WebInvocationPrivilegeEvaluator;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.web.context.AbstractSecurityWebApplicationInitializer;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* Spring Web Security 的配置类 : </span></span><br><span class="line"><span class="comment">*  1. 使用一个 WebSecurity 对象基于安全配置创建一个 FilterChainProxy 对象来对用户请求进行安全过滤。 </span></span><br><span class="line"><span class="comment">*  2. 也会暴露诸如 安全SpEL表达式处理器 SecurityExpressionHandler 等一些类。</span></span><br><span class="line"><span class="comment">*   </span></span><br><span class="line"><span class="comment">* <span class="doctag">@see</span> EnableWebSecurity</span></span><br><span class="line"><span class="comment">* <span class="doctag">@see</span> WebSecurity</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* <span class="doctag">@author</span> Rob Winch</span></span><br><span class="line"><span class="comment">* <span class="doctag">@author</span> Keesun Baik</span></span><br><span class="line"><span class="comment">* <span class="doctag">@since</span> 3.2</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSecurityConfiguration</span> <span class="keyword">implements</span> <span class="title class_">ImportAware</span>, BeanClassLoaderAware &#123;</span><br><span class="line">    <span class="keyword">private</span> WebSecurity webSecurity;</span><br><span class="line"><span class="comment">// 是否启用了调试模式，来自注解 @EnableWebSecurity 的属性 debug，缺省值 false</span></span><br><span class="line">    <span class="keyword">private</span> Boolean debugEnabled;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;SecurityConfigurer&lt;Filter, WebSecurity&gt;&gt; webSecurityConfigurers;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ClassLoader beanClassLoader;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired(required = false)</span></span><br><span class="line">    <span class="keyword">private</span> ObjectPostProcessor&lt;Object&gt; objectObjectPostProcessor;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* 代理监听器 应该时监听 DefaultAuthenticationEventPublisher 的一些处理策略</span></span><br><span class="line"><span class="comment">*/</span>   </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> DelegatingApplicationListener <span class="title function_">delegatingApplicationListener</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DelegatingApplicationListener</span>();</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * 安全SpEL表达式处理器 SecurityExpressionHandler 缺省为一个 DefaultWebSecurityExpressionHandler</span></span><br><span class="line"><span class="comment">    */</span>   </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@DependsOn(AbstractSecurityWebApplicationInitializer.DEFAULT_FILTER_NAME)</span></span><br><span class="line">    <span class="keyword">public</span> SecurityExpressionHandler&lt;FilterInvocation&gt; <span class="title function_">webSecurityExpressionHandler</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> webSecurity.getExpressionHandler();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    *  Spring Security 核心过滤器  Spring Security Filter Chain  , Bean ID 为 springSecurityFilterChain</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> the &#123;<span class="doctag">@link</span> Filter&#125; that represents the security filter chain</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="meta">@Bean(name = AbstractSecurityWebApplicationInitializer.DEFAULT_FILTER_NAME)</span></span><br><span class="line">    <span class="keyword">public</span> Filter <span class="title function_">springSecurityFilterChain</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">hasConfigurers</span> <span class="operator">=</span> webSecurityConfigurers != <span class="literal">null</span></span><br><span class="line">                &amp;&amp; !webSecurityConfigurers.isEmpty();</span><br><span class="line">        <span class="keyword">if</span> (!hasConfigurers) &#123;</span><br><span class="line">            <span class="type">WebSecurityConfigurerAdapter</span> <span class="variable">adapter</span> <span class="operator">=</span> objectObjectPostProcessor</span><br><span class="line">                    .postProcess(<span class="keyword">new</span> <span class="title class_">WebSecurityConfigurerAdapter</span>() &#123;</span><br><span class="line">                    &#125;);</span><br><span class="line">            webSecurity.apply(adapter);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> webSecurity.build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* 用于模板 如JSP Freemarker 的一些页面标签按钮控制支持</span></span><br><span class="line"><span class="comment">    * Creates the &#123;<span class="doctag">@link</span> WebInvocationPrivilegeEvaluator&#125; that is necessary for the JSP</span></span><br><span class="line"><span class="comment">    * tag support.</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> the &#123;<span class="doctag">@link</span> WebInvocationPrivilegeEvaluator&#125;</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@DependsOn(AbstractSecurityWebApplicationInitializer.DEFAULT_FILTER_NAME)</span></span><br><span class="line">    <span class="keyword">public</span> WebInvocationPrivilegeEvaluator <span class="title function_">privilegeEvaluator</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">return</span> webSecurity.getPrivilegeEvaluator();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* 用于创建web configuration的SecurityConfigurer实例，</span></span><br><span class="line"><span class="comment">* 注意该参数通过<span class="doctag">@Value</span>(...)方式注入，对应的bean autowiredWebSecurityConfigurersIgnoreParents</span></span><br><span class="line"><span class="comment">* 也在该类中定义</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> objectPostProcessor the &#123;<span class="doctag">@link</span> ObjectPostProcessor&#125; used to create a</span></span><br><span class="line"><span class="comment">    * &#123;<span class="doctag">@link</span> WebSecurity&#125; instance</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> webSecurityConfigurers the</span></span><br><span class="line"><span class="comment">    * &#123;<span class="doctag">@code</span> &lt;SecurityConfigurer&lt;FilterChainProxy, WebSecurityBuilder&gt;&#125; instances used to</span></span><br><span class="line"><span class="comment">    * create the web configuration</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="meta">@Autowired(required = false)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setFilterChainProxySecurityConfigurer</span><span class="params">(</span></span><br><span class="line"><span class="params">            ObjectPostProcessor&lt;Object&gt; objectPostProcessor,</span></span><br><span class="line"><span class="params">            <span class="meta">@Value(&quot;#&#123;@autowiredWebSecurityConfigurersIgnoreParents.getWebSecurityConfigurers()&#125;&quot;)</span> List&lt;SecurityConfigurer&lt;Filter, WebSecurity&gt;&gt; webSecurityConfigurers)</span></span><br><span class="line">            <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        webSecurity = objectPostProcessor</span><br><span class="line">                .postProcess(<span class="keyword">new</span> <span class="title class_">WebSecurity</span>(objectPostProcessor));</span><br><span class="line">        <span class="keyword">if</span> (debugEnabled != <span class="literal">null</span>) &#123;</span><br><span class="line">            webSecurity.debug(debugEnabled);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Collections.sort(webSecurityConfigurers, AnnotationAwareOrderComparator.INSTANCE);</span><br><span class="line"></span><br><span class="line">        <span class="type">Integer</span> <span class="variable">previousOrder</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">previousConfig</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">for</span> (SecurityConfigurer&lt;Filter, WebSecurity&gt; config : webSecurityConfigurers) &#123;</span><br><span class="line">            <span class="type">Integer</span> <span class="variable">order</span> <span class="operator">=</span> AnnotationAwareOrderComparator.lookupOrder(config);</span><br><span class="line">            <span class="keyword">if</span> (previousOrder != <span class="literal">null</span> &amp;&amp; previousOrder.equals(order)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(</span><br><span class="line">                        <span class="string">&quot;@Order on WebSecurityConfigurers must be unique. Order of &quot;</span></span><br><span class="line">                                + order + <span class="string">&quot; was already used on &quot;</span> + previousConfig + <span class="string">&quot;, so it cannot be used on &quot;</span></span><br><span class="line">                                + config + <span class="string">&quot; too.&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            previousOrder = order;</span><br><span class="line">            previousConfig = config;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (SecurityConfigurer&lt;Filter, WebSecurity&gt; webSecurityConfigurer : webSecurityConfigurers) &#123;</span><br><span class="line">            webSecurity.apply(webSecurityConfigurer);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">this</span>.webSecurityConfigurers = webSecurityConfigurers;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 从当前bean容器中获取所有的WebSecurityConfigurer bean。</span></span><br><span class="line"><span class="comment">    * 这些WebSecurityConfigurer通常是由开发人员实现的配置类，并且继承自WebSecurityConfigurerAdapter</span></span><br><span class="line"><span class="comment">    *  </span></span><br><span class="line"><span class="comment">    */</span>   </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> AutowiredWebSecurityConfigurersIgnoreParents <span class="title function_">autowiredWebSecurityConfigurersIgnoreParents</span><span class="params">(</span></span><br><span class="line"><span class="params">            ConfigurableListableBeanFactory beanFactory)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">AutowiredWebSecurityConfigurersIgnoreParents</span>(beanFactory);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * A custom verision of the Spring provided AnnotationAwareOrderComparator that uses</span></span><br><span class="line"><span class="comment">    * &#123;<span class="doctag">@link</span> AnnotationUtils#findAnnotation(Class, Class)&#125; to look on super class</span></span><br><span class="line"><span class="comment">    * instances for the &#123;<span class="doctag">@link</span> Order&#125; annotation.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@author</span> Rob Winch</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@since</span> 3.2</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">AnnotationAwareOrderComparator</span> <span class="keyword">extends</span> <span class="title class_">OrderComparator</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">AnnotationAwareOrderComparator</span> <span class="variable">INSTANCE</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AnnotationAwareOrderComparator</span>();</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">protected</span> <span class="type">int</span> <span class="title function_">getOrder</span><span class="params">(Object obj)</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> lookupOrder(obj);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">lookupOrder</span><span class="params">(Object obj)</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (obj <span class="keyword">instanceof</span> Ordered) &#123;</span><br><span class="line">                <span class="keyword">return</span> ((Ordered) obj).getOrder();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (obj != <span class="literal">null</span>) &#123;</span><br><span class="line">                Class&lt;?&gt; clazz = (obj <span class="keyword">instanceof</span> Class ? (Class&lt;?&gt;) obj : obj.getClass());</span><br><span class="line">                <span class="type">Order</span> <span class="variable">order</span> <span class="operator">=</span> AnnotationUtils.findAnnotation(clazz, Order.class);</span><br><span class="line">                <span class="keyword">if</span> (order != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> order.value();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> Ordered.LOWEST_PRECEDENCE;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    * 要是为了获取注解 @EnableWebSecurity 的属性 debugEnabled</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * @see org.springframework.context.annotation.ImportAware#setImportMetadata(org.</span></span><br><span class="line"><span class="comment">    * springframework.core.type.AnnotationMetadata)</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setImportMetadata</span><span class="params">(AnnotationMetadata importMetadata)</span> &#123;</span><br><span class="line">        Map&lt;String, Object&gt; enableWebSecurityAttrMap = importMetadata</span><br><span class="line">                .getAnnotationAttributes(EnableWebSecurity.class.getName());</span><br><span class="line">        <span class="type">AnnotationAttributes</span> <span class="variable">enableWebSecurityAttrs</span> <span class="operator">=</span> AnnotationAttributes</span><br><span class="line">                .fromMap(enableWebSecurityAttrMap);</span><br><span class="line">        debugEnabled = enableWebSecurityAttrs.getBoolean(<span class="string">&quot;debug&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (webSecurity != <span class="literal">null</span>) &#123;</span><br><span class="line">            webSecurity.debug(debugEnabled);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    * (non-Javadoc)</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * @see</span></span><br><span class="line"><span class="comment">    * org.springframework.beans.factory.BeanClassLoaderAware#setBeanClassLoader(java.</span></span><br><span class="line"><span class="comment">    * lang.ClassLoader)</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setBeanClassLoader</span><span class="params">(ClassLoader classLoader)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.beanClassLoader = classLoader;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-2-SpringWebMvcImportSelector"><a href="#3-2-SpringWebMvcImportSelector" class="headerlink" title="3.2 SpringWebMvcImportSelector"></a>3.2 SpringWebMvcImportSelector</h3><p>该类是为了对 Spring Mvc 进行支持的。一旦发现应用使用 Spring Mvc 的核心前置控制器<code>DispatcherServlet</code>就会引入<code>WebMvcSecurityConfiguration</code>。主要是为了适配 Spring Mvc 。</p>
<h3 id="3-3-OAuth2ImportSelector"><a href="#3-3-OAuth2ImportSelector" class="headerlink" title="3.3 OAuth2ImportSelector"></a>3.3 OAuth2ImportSelector</h3><p>该类是为了对<code>OAuth2.0</code>开放授权协议进行支持。<code>ClientRegistration</code>如果被引用，具体点也就是<code>spring-security-oauth2</code>模块被启用（引入依赖jar）时。会启用<code>OAuth2</code>客户端配置<code>OAuth2ClientConfiguration</code>。</p>
<h3 id="3-4-EnableGlobalAuthentication"><a href="#3-4-EnableGlobalAuthentication" class="headerlink" title="3.4 @EnableGlobalAuthentication"></a>3.4 @EnableGlobalAuthentication</h3><p>这个类主要引入了<code>AuthenticationConfiguration</code>目的主要为了构造 认证管理器<code>AuthenticationManager</code>。<code>AuthenticationManager</code>十分重要后面我们会进行专门的分析。</p>
<h2 id="4-SecurityFilterAutoConfiguration"><a href="#4-SecurityFilterAutoConfiguration" class="headerlink" title="4. SecurityFilterAutoConfiguration"></a>4. SecurityFilterAutoConfiguration</h2><p>我们在<code>org.springframework.boot.autoconfigure.security.servlet</code>路径下还发现了一个配置类<code>SecurityFilterAutoConfiguration</code>。该类用于向Servlet容器注册一个名称为<code>securityFilterChainRegistration</code>的bean, 实现类是<code>DelegatingFilterProxyRegistrationBean</code>。该 bean 的目的是注册另外一个<code>Servlet Filter Bean</code>到 <code>Servlet</code> 容器,实现类为<code>DelegatingFilterProxy</code>。<code>DelegatingFilterProxy</code>其实是一个代理过滤器，它被Servlet 容器用于处理请求时，会将任务委托给指定给自己另外一个Filter bean。对于<code>SecurityFilterAutoConfiguration</code>,来讲，这个被代理的Filter bean的名字为<code>springSecurityFilterChain</code>, 也就是我们上面提到过的 Spring Security Web提供的用于请求安全处理的Filter bean，其实现类是<code>FilterChainProxy</code>。</p>
<p>相关的源码分析：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.springframework.boot.autoconfigure.security.servlet;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.EnumSet;</span><br><span class="line"><span class="keyword">import</span> java.util.stream.Collectors;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.DispatcherType;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.AutoConfigureAfter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.EnableAutoConfiguration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.condition.ConditionalOnBean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.condition.ConditionalOnClass;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.condition.ConditionalOnWebApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.condition.ConditionalOnWebApplication.Type;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.security.SecurityProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.properties.EnableConfigurationProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.web.servlet.DelegatingFilterProxyRegistrationBean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.WebSecurityConfiguration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.http.SessionCreationPolicy;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.web.context.AbstractSecurityWebApplicationInitializer;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="comment">// 仅在 Servlet 环境下生效</span></span><br><span class="line"><span class="meta">@ConditionalOnWebApplication(type = Type.SERVLET)</span></span><br><span class="line"><span class="comment">// 确保安全属性配置信息被加载并以bean形式被注册到容器</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties(SecurityProperties.class)</span></span><br><span class="line"><span class="comment">// 仅在特定类存在于 classpath 上时才生效</span></span><br><span class="line"><span class="meta">@ConditionalOnClass(&#123; AbstractSecurityWebApplicationInitializer.class,</span></span><br><span class="line"><span class="meta">        SessionCreationPolicy.class &#125;)</span></span><br><span class="line"><span class="comment">// 指定该配置类在  SecurityAutoConfiguration 配置类应用之后应用       </span></span><br><span class="line"><span class="meta">@AutoConfigureAfter(SecurityAutoConfiguration.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityFilterAutoConfiguration</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 要注册到 Servlet 容器的 DelegatingFilterProxy Filter的 </span></span><br><span class="line">    <span class="comment">// 目标代理Filter bean的名称 ：springSecurityFilterChain</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DEFAULT_FILTER_NAME</span> <span class="operator">=</span> </span><br><span class="line">            AbstractSecurityWebApplicationInitializer.DEFAULT_FILTER_NAME;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 定义一个 bean securityFilterChainRegistration, </span></span><br><span class="line">    <span class="comment">// 该 bean 的目的是注册另外一个 bean 到 Servlet 容器 : 实现类为 DelegatingFilterProxy 的一个 Servlet Filter</span></span><br><span class="line">    <span class="comment">// 该 DelegatingFilterProxy Filter 其实是一个代理过滤器，它被 Servlet 容器用于匹配特定URL模式的请求，</span></span><br><span class="line">    <span class="comment">// 而它会将任务委托给指定给自己的名字为 springSecurityFilterChain 的 Filter, 也就是 Spring Security Web</span></span><br><span class="line">    <span class="comment">// 提供的用于请求安全处理的一个 Filter bean，其实现类是 FilterChainProxy</span></span><br><span class="line">    <span class="comment">// (可以将 1 个 FilterChainProxy 理解为 1 HttpFirewall + n SecurityFilterChain)</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConditionalOnBean(name = DEFAULT_FILTER_NAME)</span></span><br><span class="line">    <span class="keyword">public</span> DelegatingFilterProxyRegistrationBean <span class="title function_">securityFilterChainRegistration</span><span class="params">(</span></span><br><span class="line"><span class="params">            SecurityProperties securityProperties)</span> &#123;</span><br><span class="line">        <span class="type">DelegatingFilterProxyRegistrationBean</span> <span class="variable">registration</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DelegatingFilterProxyRegistrationBean</span>(</span><br><span class="line">                DEFAULT_FILTER_NAME);</span><br><span class="line">        registration.setOrder(securityProperties.getFilter().getOrder());</span><br><span class="line">        registration.setDispatcherTypes(getDispatcherTypes(securityProperties));</span><br><span class="line">        <span class="keyword">return</span> registration;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> EnumSet&lt;DispatcherType&gt; <span class="title function_">getDispatcherTypes</span><span class="params">(</span></span><br><span class="line"><span class="params">            SecurityProperties securityProperties)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (securityProperties.getFilter().getDispatcherTypes() == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> securityProperties.getFilter().getDispatcherTypes().stream()</span><br><span class="line">                .map((type) -&gt; DispatcherType.valueOf(type.name())).collect(Collectors</span><br><span class="line">                        .collectingAndThen(Collectors.toSet(), EnumSet::copyOf));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="5-总结"><a href="#5-总结" class="headerlink" title="5. 总结"></a>5. 总结</h2><p>本文主要对 Spring Security 在 Spring Boot 中的自动配置一些机制进行了粗略的讲解。为什么没有细讲。因为从学习出发有些东西不是我们必须要深入了解的，但是又要知道一点点相关的知识。我们先宏观上有个大致的了解就行。<strong>所以在阅读本文一定不要钻牛角尖。粗略知道配置策略、加载策略和一些关键类的作用即可。在你对 Spring Security 有了进一步学习之后，回头认真来看这些配置类会有更深层的思考</strong> 从另一个方面该文也给你阅读 Spring 源码提供了一些思路，学会这些才是最重要的。</p>
<p>转载自<a target="_blank" rel="noopener" href="https://felord.cn/spring-security-autoconfigure.html">@felord.cn</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://wangweiye01.github.io/blog/2021/07/03/security2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="老枪">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Coding & Life">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Coding & Life">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/2021/07/03/security2/" class="post-title-link" itemprop="url">Spring Security2 - 如何保护用户密码</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-07-03 11:11:33" itemprop="dateCreated datePublished" datetime="2021-07-03T11:11:33+08:00">2021-07-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-06-16 15:54:53" itemprop="dateModified" datetime="2025-06-16T15:54:53+08:00">2025-06-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Spring-Security/" itemprop="url" rel="index"><span itemprop="name">Spring Security</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="1-前言"><a href="#1-前言" class="headerlink" title="1. 前言"></a>1. 前言</h2><p>我们对<code>Spring Security中</code>的重要用户信息主体<code>UserDetails</code>进行了探讨。中间例子我们使用了明文密码，规则是通过对密码明文添加<code>&#123;noop&#125;</code>前缀。那么本节将对<code>Spring Security</code>中的密码编码进行一些探讨。</p>
<h2 id="2-不推荐使用md5"><a href="#2-不推荐使用md5" class="headerlink" title="2. 不推荐使用md5"></a>2. 不推荐使用md5</h2><p>首先<code>md5</code>不是加密算法，是哈希摘要。以前通常使用其作为密码哈希来保护密码。由于彩虹表的出现，<code>md5</code>和<code>sha1</code>之类的摘要算法都已经不安全了。如果有不相信的同学 可以到一些解密网站 如 cmd5 网站尝试解密，你会发现<code>md5</code>和<code>sha1</code>是真的非常容易被破解。</p>
<h2 id="3-Spring-Security中的密码算法"><a href="#3-Spring-Security中的密码算法" class="headerlink" title="3. Spring Security中的密码算法"></a>3. Spring Security中的密码算法</h2><p>上文我们提到了<code>InMemoryUserDetailsManager</code>初始化Bean 需要传输一个<code>ObjectProvider&lt;PasswordEncoder&gt;</code>参数。这里的<code>PasswordEncoder</code>就是我们对密码进行编码的工具接口。该接口只有两个功能：一个是匹配验证。另一个是密码编码</p>
<p><img src="https://blog-1256050353.cos.ap-beijing.myqcloud.com/2021070301.png"></p>
<p>上图就是Spring Security 提供的<code>org.springframework.security.crypto.password.PasswordEncoder</code>一些实现，有的已经过时。其中我们注意到一个叫<strong>委托密码编码器的实现</strong></p>
<h3 id="3-1-委托密码编码器-DelegatingPasswordEncoder"><a href="#3-1-委托密码编码器-DelegatingPasswordEncoder" class="headerlink" title="3.1 委托密码编码器 DelegatingPasswordEncoder"></a>3.1 委托密码编码器 DelegatingPasswordEncoder</h3><p>什么是委托（Delegate）？ 就是甲方交给乙方的活。乙方呢手里又很多的渠道，但是乙方光想赚差价又不想干活。所以乙方根据一些规则又把活委托给了别人，让别人来干。这里的乙方就是<code>DelegatingPasswordEncoder</code>。该类维护了以下清单：</p>
<ul>
<li><code>final String idForEncode</code>通过id来匹配编码器，该id不能是{} 包括的。<code>DelegatingPasswordEncoder</code>初始化传入，用来提供默认的密码编码器。</li>
<li><code>final PasswordEncoder passwordEncoderForEncode</code>通过上面<code>idForEncode</code>所匹配到的<code>PasswordEncoder</code><strong>用来对密码进行编码</strong></li>
<li><code>final Map&lt;String, PasswordEncoder&gt; idToPasswordEncoder</code>用来维护多个<code>idForEncode</code>与具体<code>PasswordEncoder</code>的映射关系。<code>DelegatingPasswordEncoder</code>初始化时装载进去，会在初始化时进行一些规则校验。</li>
<li><code>PasswordEncoder defaultPasswordEncoderForMatches = new UnmappedIdPasswordEncode</code>默认的密码匹配器，上面的<code>Map</code>中都不存在就用它来执行<code>matches</code>方法进行匹配验证。这是一个内部类实现。</li>
</ul>
<p><code>DelegatingPasswordEncoder</code>编码方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">encode</span><span class="params">(CharSequence rawPassword)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> PREFIX + <span class="built_in">this</span>.idForEncode + SUFFIX + <span class="built_in">this</span>.passwordEncoderForEncode.encode(rawPassword);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从上面源码可以看出来通过<code>DelegatingPasswordEncoder</code>编码后的密码是遵循一定的规则的，遵循&#96;&#96;{idForEncode}encodePassword<code>。也就是前缀</code>{}&#96;包含了编码的方式再拼接上该方式编码后的密码串。</p>
<p><code>DelegatingPasswordEncoder</code>密码匹配方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">matches</span><span class="params">(CharSequence rawPassword, String prefixEncodedPassword)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (rawPassword == <span class="literal">null</span> &amp;&amp; prefixEncodedPassword == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">String</span> <span class="variable">id</span> <span class="operator">=</span> extractId(prefixEncodedPassword);</span><br><span class="line">    <span class="type">PasswordEncoder</span> <span class="variable">delegate</span> <span class="operator">=</span> <span class="built_in">this</span>.idToPasswordEncoder.get(id);</span><br><span class="line">    <span class="keyword">if</span> (delegate == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.defaultPasswordEncoderForMatches</span><br><span class="line">            .matches(rawPassword, prefixEncodedPassword);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">String</span> <span class="variable">encodedPassword</span> <span class="operator">=</span> extractEncodedPassword(prefixEncodedPassword);</span><br><span class="line">    <span class="keyword">return</span> delegate.matches(rawPassword, encodedPassword);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>密码匹配通过传入原始密码和遵循<code>&#123;idForEncode&#125;encodePassword</code>规则的密码编码串。通过获取编码方式id(<code>idForEncode</code>)来从<code>DelegatingPasswordEncode</code>r中的映射集合<code>idToPasswordEncoder</code>中获取具体的<code>PasswordEncoder</code>进行匹配校验。找不到就使用<code>UnmappedIdPasswordEncoder</code>。</p>
<p>这就是<code>DelegatingPasswordEncoder</code>的工作流程。那么<code>DelegatingPasswordEncoder</code>在哪里实例化呢？</p>
<h3 id="3-2-密码器静态工厂PasswordEncoderFactories"><a href="#3-2-密码器静态工厂PasswordEncoderFactories" class="headerlink" title="3.2 密码器静态工厂PasswordEncoderFactories"></a>3.2 密码器静态工厂PasswordEncoderFactories</h3><p>从名字上就看得出来这是个工厂啊，专门制造<code>PasswordEncoder</code>。而且还是个静态工厂只提供了初始化<code>DelegatingPasswordEncoder</code>的方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SuppressWarnings(&quot;deprecation&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> PasswordEncoder <span class="title function_">createDelegatingPasswordEncoder</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">encodingId</span> <span class="operator">=</span> <span class="string">&quot;bcrypt&quot;</span>;</span><br><span class="line">    Map&lt;String, PasswordEncoder&gt; encoders = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    encoders.put(encodingId, <span class="keyword">new</span> <span class="title class_">BCryptPasswordEncoder</span>());</span><br><span class="line">    encoders.put(<span class="string">&quot;ldap&quot;</span>, <span class="keyword">new</span> <span class="title class_">org</span>.springframework.security.crypto.password.LdapShaPasswordEncoder());</span><br><span class="line">    encoders.put(<span class="string">&quot;MD4&quot;</span>, <span class="keyword">new</span> <span class="title class_">org</span>.springframework.security.crypto.password.Md4PasswordEncoder());</span><br><span class="line">    encoders.put(<span class="string">&quot;MD5&quot;</span>, <span class="keyword">new</span> <span class="title class_">org</span>.springframework.security.crypto.password.MessageDigestPasswordEncoder(<span class="string">&quot;MD5&quot;</span>));</span><br><span class="line">    encoders.put(<span class="string">&quot;noop&quot;</span>, org.springframework.security.crypto.password.NoOpPasswordEncoder.getInstance());</span><br><span class="line">    encoders.put(<span class="string">&quot;pbkdf2&quot;</span>, <span class="keyword">new</span> <span class="title class_">Pbkdf2PasswordEncoder</span>());</span><br><span class="line">    encoders.put(<span class="string">&quot;scrypt&quot;</span>, <span class="keyword">new</span> <span class="title class_">SCryptPasswordEncoder</span>());</span><br><span class="line">    encoders.put(<span class="string">&quot;SHA-1&quot;</span>, <span class="keyword">new</span> <span class="title class_">org</span>.springframework.security.crypto.password.MessageDigestPasswordEncoder(<span class="string">&quot;SHA-1&quot;</span>));</span><br><span class="line">    encoders.put(<span class="string">&quot;SHA-256&quot;</span>, <span class="keyword">new</span> <span class="title class_">org</span>.springframework.security.crypto.password.MessageDigestPasswordEncoder(<span class="string">&quot;SHA-256&quot;</span>));</span><br><span class="line">    encoders.put(<span class="string">&quot;sha256&quot;</span>, <span class="keyword">new</span> <span class="title class_">org</span>.springframework.security.crypto.password.StandardPasswordEncoder());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DelegatingPasswordEncoder</span>(encodingId, encoders);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从上面可以非常具体地看出来<code>DelegatingPasswordEncoder</code>提供的密码编码方式。默认采用了<code>bcrypt</code>进行编码。我们可终于明白了为什么上一文中我们使用<code>&#123;noop&#125;12345</code>能和我们前台输入的<code>12345</code>匹配上。这么搞有什么好处呢？这可以实现一个场景，如果有一天我们对密码编码规则进行替换或者轮转。现有的用户不会受到影响。 那么Spring Security 是如何配置密码编码器<code>PasswordEncoder</code>呢？</p>
<h2 id="4-Spring-Security-加载-PasswordEncoder-的规则"><a href="#4-Spring-Security-加载-PasswordEncoder-的规则" class="headerlink" title="4. Spring Security 加载 PasswordEncoder 的规则"></a>4. Spring Security 加载 PasswordEncoder 的规则</h2><p>我们在Spring Security配置适配器<code>WebSecurityConfigurerAdapter</code>（该类我以后的文章会仔细分析 可通过<a target="_blank" rel="noopener" href="https://felord.cn/">https://felord.cn</a> 来及时获取相关信息）找到了引用<code>PasswordEncoderFactories</code>的地方，一个内部<code>PasswordEncoder</code>实现<code>LazyPasswordEncoder</code>。从源码上看该类是懒加载的只有用到了才去实例化。在该类的内部方法中发现了<code>PasswordEncoder</code>的规则。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取最终干活的PasswordEncoder</span></span><br><span class="line"><span class="keyword">private</span> PasswordEncoder <span class="title function_">getPasswordEncoder</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.passwordEncoder != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.passwordEncoder;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">PasswordEncoder</span> <span class="variable">passwordEncoder</span> <span class="operator">=</span> getBeanOrNull(PasswordEncoder.class);</span><br><span class="line">    <span class="keyword">if</span> (passwordEncoder == <span class="literal">null</span>) &#123;</span><br><span class="line">        passwordEncoder = PasswordEncoderFactories.createDelegatingPasswordEncoder();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">this</span>.passwordEncoder = passwordEncoder;</span><br><span class="line">    <span class="keyword">return</span> passwordEncoder;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 从Spring IoC容器中获取Bean 有可能获取不到</span></span><br><span class="line"><span class="keyword">private</span> &lt;T&gt; T <span class="title function_">getBeanOrNull</span><span class="params">(Class&lt;T&gt; type)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.applicationContext.getBean(type);</span><br><span class="line">    &#125; <span class="keyword">catch</span>(NoSuchBeanDefinitionException notFound) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面的两个方法总结：如果能从从Spring IoC容器中获取<code>PasswordEncoder</code>的Bean就用该Bean作为编码器，没有就使用<code>DelegatingPasswordEncoder</code>。默认是<code>bcrypt</code>方式。文中多次提到该算法。而且还是Spring Security默认的。那么它到底是什么呢？</p>
<h2 id="5-bcrypt-编码算法"><a href="#5-bcrypt-编码算法" class="headerlink" title="5. bcrypt 编码算法"></a>5. bcrypt 编码算法</h2><p>这里简单提一下<code>bcrypt</code>， <code>bcrypt</code>使用的是布鲁斯·施内尔在1993年发布的<code>Blowfish</code>加密算法。<code>bcrypt</code>算法将<code>salt</code>随机并混入最终加密后的密码，验证时也无需单独提供之前的<code>salt</code>，从而无需单独处理<code>salt</code>问题。加密后的格式一般为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$2a$10$/bTVvqqlH9UiE0ZJZ7N2Me3RIgUCdgMheyTgV0B4cMCSokPa.6oCa</span><br></pre></td></tr></table></figure>

<p>其中：<code>$</code>是分割符，无意义;<code>2a</code>是<code>bcrypt</code>加密版本号；<code>10</code>是<code>cost</code>的值；而后的前<code>22</code>位是<code>salt</code>值；再然后的字符串就是密码的密文了。</p>
<h3 id="5-1-bcrypt-特点"><a href="#5-1-bcrypt-特点" class="headerlink" title="5.1 bcrypt 特点"></a>5.1 bcrypt 特点</h3><p>. <code>bcrypt</code>有个特点就是非常慢。这大大提高了使用彩虹表进行破解的难度。也就是说该类型的密码暗文拥有让破解者无法忍受的时间成本。同时对于开发者来说也需要注意该时长是否能超出系统忍受范围内。通常是<code>MD5</code>的数千倍。<br>. 同样的密码每次使用<code>bcrypt</code>编码，密码暗文都是不一样的。 也就是说你有两个网站如果都使用了<code>bcrypt</code>它们的暗文是不一样的，这不会因为一个网站泄露密码暗文而使另一个网站也泄露密码暗文。</p>
<p>所以从<code>bcrypt</code>的特点上来看，其安全强度还是非常有保证的</p>
<h2 id="6-总结"><a href="#6-总结" class="headerlink" title="6. 总结"></a>6. 总结</h2><p>今天我们对Spring Security中的密码编码进行分析。发现了默认情况下使用<code>bcrypt</code>进行编码。而密码验证匹配则通过密码暗文前缀中的加密方式id控制。你也可以向Spring IoC容器注入一个<code>PasswordEncoder</code>类型的Bean 来达到自定义的目的。我们还对<code>bcrypt</code>算法进行一些简单了解，对其特点进行了总结。后面我们会Spring Security进行进一步学习。关于上一篇文章的demo我也已经替换成了数据库管理用户，相关代码请使用<code>day02</code>分支获取</p>
<p>转载自<a target="_blank" rel="noopener" href="https://felord.cn/spring-security-crypt.html">@felord.cn</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://wangweiye01.github.io/blog/2021/07/03/security1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.gif">
      <meta itemprop="name" content="老枪">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Coding & Life">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Coding & Life">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/blog/2021/07/03/security1/" class="post-title-link" itemprop="url">Spring Security1 - 用户信息UserDetails相关入门</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-07-03 10:00:30" itemprop="dateCreated datePublished" datetime="2021-07-03T10:00:30+08:00">2021-07-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-06-16 15:54:53" itemprop="dateModified" datetime="2025-06-16T15:54:53+08:00">2025-06-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Spring-Security/" itemprop="url" rel="index"><span itemprop="name">Spring Security</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="1-前言"><a href="#1-前言" class="headerlink" title="1.前言"></a>1.前言</h2><p>本篇将通过<code>Spring Boot 2.x</code>来讲解<code>Spring Security</code>中的用户主题<code>UserDetails</code></p>
<h2 id="2-Spring-Boot集成Spring-Security"><a href="#2-Spring-Boot集成Spring-Security" class="headerlink" title="2.Spring Boot集成Spring Security"></a>2.Spring Boot集成Spring Security</h2><p>集成<code>Spring Security</code>只需要引入其对应的<code>Starter</code>组件。<code>Spring Security</code>不仅仅能保<code>Servlet Web</code>应用，也可以保护<code>Reactive Web</code>应用，本文我们讲前者。我们只需要在<code>Spring Security</code>项目引入以下依赖即可:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">      <span class="comment">&lt;!--  actuator 指标监控  非必须 --&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="comment">&lt;!--  spring security starter 必须  --&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="comment">&lt;!-- spring mvc  servlet web  必须  --&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="comment">&lt;!--   lombok 插件 非必须       --&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="comment">&lt;!-- 测试   --&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.security<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-security-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="3-UserDetailsServiceAutoConfiguration"><a href="#3-UserDetailsServiceAutoConfiguration" class="headerlink" title="3.UserDetailsServiceAutoConfiguration"></a>3.UserDetailsServiceAutoConfiguration</h2><p>启动项目，访问<code>Actuator</code>端点<code>http://localhost:8080/actuator</code>会跳转到一个登录页面，如下：</p>
<p><img src="https://blog-1256050353.file.myqcloud.com/Hbc735c80ea4344bb83607f459bfa21388.png" alt="登录页面"></p>
<p>要求你输入用户名<code>Username</code>（默认值为user）和密码<code>Password</code>。密码在springboot控制台会打印出类似<code>Using generated security password: e1f163be-ad18-4be1-977c-88a6bcee0d37</code>的字样，后面的长串就是密码，当然这不是生产可用的。如果你足够细心会从控制台打印日志发现该随机密码是由<code>UserDetailsServiceAutoConfiguration</code>配置类生成的，我们就从它开始顺藤摸瓜来一探究竟。</p>
<h3 id="3-1-UserDetailsService"><a href="#3-1-UserDetailsService" class="headerlink" title="3.1 UserDetailsService"></a>3.1 UserDetailsService</h3><p><code>UserDetailsService</code>接口只提供了一个方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">UserDetails <span class="title function_">loadUserByUsername</span><span class="params">(String username)</span> <span class="keyword">throws</span> UsernameNotFoundException;</span><br></pre></td></tr></table></figure>

<p>该方法很容易理解：<strong>通过用户名来加载用户</strong>。这个方法主要用于从系统数据中查询并加载具体的用户到Spring Security中。</p>
<h3 id="3-2-UserDetails"><a href="#3-2-UserDetails" class="headerlink" title="3.2 UserDetails"></a>3.2 UserDetails</h3><p>从上面<code>UserDetailsService</code>可以知道最终交给Spring Security的是<code>UserDetails</code>。该接口是提供用户信息的核心接口。该接口实现仅仅存储用户信息。后续会将该接口提供的用户信息封装到认证对象<code>Authentication</code>中取。<code>UserDetails</code>默认提供了：</p>
<p>. 用户的权限集，默认需要添加<code>ROLE_</code>前缀<br>. 用户的加密后的密码，不加密会使用<code>&#123;noop&#125;</code>前缀<br>. 应用内唯一的用户名<br>. 账户是否过期<br>. 账户是否锁定<br>. 凭证是否过期<br>. 用户是否可用</p>
<p>如果以上的信息满足不了你使用，你可以自行实现扩展以存储更多的用户信息。比如用户的邮箱、手机号等等。通常我们使用其实现类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">org.springframework.security.core.userdetails.User</span><br></pre></td></tr></table></figure>

<p>该类内置一个建造起<code>UserBuilder</code>会很方便地帮助我们构建<code>UserDetails</code>对象，后面我们会用到它</p>
<h3 id="3-3-UserDetailsServiceAutoConfiguration"><a href="#3-3-UserDetailsServiceAutoConfiguration" class="headerlink" title="3.3 UserDetailsServiceAutoConfiguration"></a>3.3 UserDetailsServiceAutoConfiguration</h3><p><code>UserDetailsServiceAutoconfiguration</code>全限定名为:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">org.springframework.boot.autoconfigure.security.servlet.UserDetailsServiceAutoConfiguration</span><br></pre></td></tr></table></figure>

<p>源码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConditionalOnClass(AuthenticationManager.class)</span></span><br><span class="line"><span class="meta">@ConditionalOnBean(ObjectPostProcessor.class)</span></span><br><span class="line"><span class="meta">@ConditionalOnMissingBean(&#123; AuthenticationManager.class, AuthenticationProvider.class, UserDetailsService.class &#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserDetailsServiceAutoConfiguration</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">NOOP_PASSWORD_PREFIX</span> <span class="operator">=</span> <span class="string">&quot;&#123;noop&#125;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Pattern</span> <span class="variable">PASSWORD_ALGORITHM_PATTERN</span> <span class="operator">=</span> Pattern.compile(<span class="string">&quot;^\\&#123;.+&#125;.*$&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Log</span> <span class="variable">logger</span> <span class="operator">=</span> LogFactory.getLog(UserDetailsServiceAutoConfiguration.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConditionalOnMissingBean(</span></span><br><span class="line"><span class="meta">            type = &quot;org.springframework.security.oauth2.client.registration.ClientRegistrationRepository&quot;)</span></span><br><span class="line">    <span class="meta">@Lazy</span></span><br><span class="line">    <span class="keyword">public</span> InMemoryUserDetailsManager <span class="title function_">inMemoryUserDetailsManager</span><span class="params">(SecurityProperties properties,</span></span><br><span class="line"><span class="params">            ObjectProvider&lt;PasswordEncoder&gt; passwordEncoder)</span> &#123;</span><br><span class="line">        SecurityProperties.<span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> properties.getUser();</span><br><span class="line">        List&lt;String&gt; roles = user.getRoles();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">InMemoryUserDetailsManager</span>(</span><br><span class="line">                User.withUsername(user.getName()).password(getOrDeducePassword(user, passwordEncoder.getIfAvailable()))</span><br><span class="line">                        .roles(StringUtils.toStringArray(roles)).build());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">getOrDeducePassword</span><span class="params">(SecurityProperties.User user, PasswordEncoder encoder)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">password</span> <span class="operator">=</span> user.getPassword();</span><br><span class="line">        <span class="keyword">if</span> (user.isPasswordGenerated()) &#123;</span><br><span class="line">            logger.info(String.format(<span class="string">&quot;%n%nUsing generated security password: %s%n&quot;</span>, user.getPassword()));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (encoder != <span class="literal">null</span> || PASSWORD_ALGORITHM_PATTERN.matcher(password).matches()) &#123;</span><br><span class="line">            <span class="keyword">return</span> password;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> NOOP_PASSWORD_PREFIX + password;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们来简单解读一下该类，从<code>@Conditional</code>系列注解我们知道该类在类路径下存在<code>AuthenticationManager</code>、在Spring容器中存在Bean<code>ObjectPostProcessor</code>并且不存在Bean<code>AuthenticationManager</code>、<code>AuthenticationProvider</code>、<code>UserDetailsService</code>的情况下生效。<strong>千万不要纠结这些类干嘛用的</strong>该类只初始化了一个<code>UserDetailsManager</code>类型的Bean。<code>UserDetailsManager</code>类负责对安全用户实体抽象<code>UserDetails</code>的增删改查操作。同时还继承了<code>UserDetailsService</code>接口。</p>
<p>明白了上面这些让我们把目光再回到<code>UserDetailsServiceAutoConfiguration</code>上来。该类初始化了一个名为<code>InMemoryUserDetailsManager</code>的内存用户管理器。该管理器通过配置注入了一个默认的<code>UserDetails</code>存在内存中，就是我们上面用的那个<code>user</code>，每次启动<code>user</code>都是动态生成的。<strong>那么问题来了如果我们定义自己的<code>UserDetailsManager</code>Bean是不是就可以实现我们需要的用户管理逻辑呢？</strong></p>
<h3 id="3-4-自定义UserDetailsManager"><a href="#3-4-自定义UserDetailsManager" class="headerlink" title="3.4 自定义UserDetailsManager"></a>3.4 自定义UserDetailsManager</h3><p>我们来自定义一个<code>UserDetailsManager</code>来看看能不能达到自定义用户管理的效果。首先我们针对<code>UserDetailsManager</code>的所有方法进行一个代理实现，我们依然将用户存在内存中，区别就是这是我们自定义的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cn.felord.spring.security;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.security.access.AccessDeniedException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.Authentication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.context.SecurityContextHolder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UserDetails;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UsernameNotFoundException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 代理 &#123;<span class="doctag">@link</span> org.springframework.security.provisioning.UserDetailsManager&#125; 所有功能</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Felordcn</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserDetailsRepository</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, UserDetails&gt; users = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">createUser</span><span class="params">(UserDetails user)</span> &#123;</span><br><span class="line">        users.putIfAbsent(user.getUsername(), user);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateUser</span><span class="params">(UserDetails user)</span> &#123;</span><br><span class="line">        users.put(user.getUsername(), user);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deleteUser</span><span class="params">(String username)</span> &#123;</span><br><span class="line">        users.remove(username);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">changePassword</span><span class="params">(String oldPassword, String newPassword)</span> &#123;</span><br><span class="line">        <span class="type">Authentication</span> <span class="variable">currentUser</span> <span class="operator">=</span> SecurityContextHolder.getContext()</span><br><span class="line">                .getAuthentication();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (currentUser == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// This would indicate bad coding somewhere</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AccessDeniedException</span>(</span><br><span class="line">                    <span class="string">&quot;Can&#x27;t change password as no Authentication object found in context &quot;</span></span><br><span class="line">                            + <span class="string">&quot;for current user.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> currentUser.getName();</span><br><span class="line"></span><br><span class="line">        <span class="type">UserDetails</span> <span class="variable">user</span> <span class="operator">=</span> users.get(username);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (user == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;Current user doesn&#x27;t exist in database.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// todo copy InMemoryUserDetailsManager  自行实现具体的更新密码逻辑</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">userExists</span><span class="params">(String username)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> users.containsKey(username);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> UserDetails <span class="title function_">loadUserByUsername</span><span class="params">(String username)</span> <span class="keyword">throws</span> UsernameNotFoundException &#123;</span><br><span class="line">        <span class="keyword">return</span> users.get(username);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>该类负责具体对<code>UserDetails</code>的增删改查操作。我们将其注入Spring容器：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> UserDetailsRepository <span class="title function_">userDetailsRepository</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">UserDetailsRepository</span> <span class="variable">userDetailsRepository</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserDetailsRepository</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 为了让我们的登录能够运行 这里我们初始化一个用户Felordcn 密码采用明文 当你在密码12345上使用了前缀&#123;noop&#125; 意味着你的密码不使用加密，authorities 一定不能为空 这代表用户的角色权限集合</span></span><br><span class="line">    <span class="type">UserDetails</span> <span class="variable">felordcn</span> <span class="operator">=</span> User.withUsername(<span class="string">&quot;Felordcn&quot;</span>).password(<span class="string">&quot;&#123;noop&#125;12345&quot;</span>).authorities(AuthorityUtils.NO_AUTHORITIES).build();</span><br><span class="line">    userDetailsRepository.createUser(felordcn);</span><br><span class="line">    <span class="keyword">return</span> userDetailsRepository;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>为了方便测试,我们也内置一个名称为<code>Felordcn</code>密码为<code>12345</code>的<code>UserDetails</code>用户，密码采用明文。当你在密码<code>12345</code>上使用了前缀<code>&#123;noop&#125;</code>意味着你的密码不使用加密，这里我们并没有指定密码加密方式你可以使用<code>PasswordEncoder</code>来指定一种加密方式。通常推荐使用<code>Bcrypt</code>作为加密方式。默认Spring Security使用的也是此方式。authorities一定不能为<code>null</code>这代表用户的角色权限集合。接下来我们实现一个<code>UserDetailsManager</code>并注入Spring 容器：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> UserDetailsManager <span class="title function_">userDetailsManager</span><span class="params">(UserDetailsRepository userDetailsRepository)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">UserDetailsManager</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">createUser</span><span class="params">(UserDetails user)</span> &#123;</span><br><span class="line">            userDetailsRepository.createUser(user);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateUser</span><span class="params">(UserDetails user)</span> &#123;</span><br><span class="line">            userDetailsRepository.updateUser(user);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deleteUser</span><span class="params">(String username)</span> &#123;</span><br><span class="line">            userDetailsRepository.deleteUser(username);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">changePassword</span><span class="params">(String oldPassword, String newPassword)</span> &#123;</span><br><span class="line">            userDetailsRepository.changePassword(oldPassword, newPassword);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">userExists</span><span class="params">(String username)</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> userDetailsRepository.userExists(username);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> UserDetails <span class="title function_">loadUserByUsername</span><span class="params">(String username)</span> <span class="keyword">throws</span> UsernameNotFoundException &#123;</span><br><span class="line">            <span class="keyword">return</span> userDetailsRepository.loadUserByUsername(username);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样实际执行委托给了<code>UserDetailsRepository</code>来做。我们重复<code>章节3.</code>的动作进入登录页面分别输入<code>Felordcn</code>和<code>12345</code>成功进入。</p>
<h3 id="3-5-数据库管理用户"><a href="#3-5-数据库管理用户" class="headerlink" title="3.5 数据库管理用户"></a>3.5 数据库管理用户</h3><p>经过以上的配置，相信聪明的你已经知道如何使用数据库来管理用户了。只需要将<code>UserDetailsRepository</code>中的<code>users</code>属性替代为抽象的Dao接口就行了，无论你使用<code>JPA</code>还是<code>Mybatis</code>来实现。</p>
<h2 id="4-总结"><a href="#4-总结" class="headerlink" title="4. 总结"></a>4. 总结</h2><p>今天我们对Spring Security 中的用户信息 UserDetails 相关进行的一些解读。并自定义了用户信息处理服务。相信你已经对在Spring Security中如何加载用户信息，如何扩展用户信息有所掌握了<a target="_blank" rel="noopener" href="https://gitee.com/charge_wangweiye/security-learning">源码地址</a>，使用<code>day01</code>分支</p>
<p>转载自<a target="_blank" rel="noopener" href="https://felord.cn/spring-security-userdetails.html">@felord.cn</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="Previous page" aria-label="Previous page" href="/blog/page/3/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/blog/">1</a><span class="space">&hellip;</span><a class="page-number" href="/blog/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/blog/page/5/">5</a><span class="space">&hellip;</span><a class="page-number" href="/blog/page/9/">9</a><a class="extend next" rel="next" title="Next page" aria-label="Next page" href="/blog/page/5/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">老枪</span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>

</body>
</html>
